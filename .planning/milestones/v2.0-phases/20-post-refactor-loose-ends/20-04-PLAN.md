---
phase: 20-post-refactor-loose-ends
plan: 04
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - src/aquapose/core/tracking/stage.py
  - src/aquapose/core/tracking/backends/__init__.py
  - src/aquapose/core/tracking/backends/hungarian.py
  - src/aquapose/tracking/associate.py
  - tests/unit/core/tracking/test_tracking_stage.py
autonomous: true
requirements: [REMEDIATE]

must_haves:
  truths:
    - "TrackingStage reads context.associated_bundles from Stage 3 as its primary input"
    - "FishTracker.update() accepts pre-associated bundles directly"
    - "Stage 4 does not re-derive cross-camera association internally"
    - "Stage 3 is a hard dependency for Stage 4 — missing bundles raises a precondition error"
    - "Existing tracking behavior is preserved for confirmed/coasting/dead lifecycle"
  artifacts:
    - path: "src/aquapose/core/tracking/stage.py"
      provides: "TrackingStage consuming Stage 3 bundles"
    - path: "src/aquapose/core/tracking/backends/hungarian.py"
      provides: "Refactored Hungarian backend consuming bundles"
  key_links:
    - from: "src/aquapose/core/tracking/stage.py"
      to: "src/aquapose/core/tracking/backends/hungarian.py"
      via: "backend.track_frame(bundles=frame_bundles)"
      pattern: "track_frame.*bundles"
    - from: "src/aquapose/core/tracking/backends/hungarian.py"
      to: "src/aquapose/tracking/associate.py"
      via: "FishTracker.update() consumes bundles instead of raw detections"
      pattern: "update.*bundles"
---

<objective>
Fix the Stage 3/4 coupling (AUD-005, AUD-006) by refactoring TrackingStage and its Hungarian backend to consume pre-associated bundles from Stage 3 output.

Purpose: Currently Stage 4 reads raw detections from Stage 1 and re-derives cross-camera association internally, wasting the work Stage 3 already did. After this fix, the pipeline's data flow is honest: each stage consumes the previous stage's output.

Output: TrackingStage reads context.associated_bundles; Hungarian backend's FishTracker.update() accepts bundles directly; redundant internal RANSAC association removed from tracker.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-post-refactor-loose-ends/20-CONTEXT.md

<interfaces>
<!-- Stage 3 output: AssociationBundle -->
From src/aquapose/core/association/types.py:
```python
@dataclass
class AssociationBundle:
    fish_idx: int
    centroid_3d: np.ndarray  # shape (3,)
    camera_detections: dict[str, int]  # cam_id -> detection_index
```

<!-- Current TrackingStage.run() reads context.detections (Stage 1) -->
From src/aquapose/core/tracking/stage.py:
```python
def run(self, context: PipelineContext) -> PipelineContext:
    if context.detections is None:
        raise ValueError(...)
    # Reads context.detections, passes bundles as secondary arg
    for frame_dets, frame_bundles in zip(context.detections, bundles_per_frame):
        frame_tracks = self._backend.track_frame(
            frame_idx=frame_idx,
            bundles=frame_bundles,
            detections_per_camera=frame_dets,
        )
```

<!-- Current HungarianBackend -->
The Hungarian backend wraps FishTracker which internally calls discover_births()
(from tracking/associate.py) to re-derive cross-camera association. This is the
redundant work that should be eliminated.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor TrackingStage to read bundles from Stage 3</name>
  <files>
    src/aquapose/core/tracking/stage.py
    src/aquapose/core/tracking/backends/__init__.py
    src/aquapose/core/tracking/backends/hungarian.py
  </files>
  <action>
    1. Update `TrackingStage.run()`:
       - Change the primary input from `context.detections` to `context.associated_bundles`
       - Raise ValueError if `context.associated_bundles is None` with message: "TrackingStage requires context.associated_bundles — ensure Stage 3 (AssociationStage) has run."
       - Remove the fallback `bundles_per_frame = context.associated_bundles or [[] for ...]`
       - Pass bundles as the primary data to the backend, with detections as optional secondary for lifecycle management
       - Update the module docstring to remove the "v1.0 debt" / "design debt" language

    2. Update the Hungarian backend (`hungarian.py`):
       - Modify `track_frame()` to accept bundles as the primary input
       - Refactor FishTracker.update() to consume `AssociationBundle` objects directly instead of re-deriving association from raw detections:
         - Each bundle provides `centroid_3d` (the 3D position) and `camera_detections` (which cameras saw this fish)
         - Use bundle centroids for Hungarian assignment to existing tracks (same distance-based matching, but using pre-computed centroids instead of re-triangulating)
         - New births come from bundles that don't match any existing track
         - Coasting/dead lifecycle management stays the same
       - Remove the internal call to `discover_births()` for association (the association stage already did this)
       - Keep `discover_births()` in `tracking/associate.py` as a utility — it may still be useful, but it's no longer called during normal pipeline operation

    3. Update the backend Protocol/interface in `backends/__init__.py`:
       - Ensure `track_frame()` signature reflects bundles as primary input
       - Update `get_backend()` if needed

    Important constraints:
    - Preserve fish lifecycle semantics: probationary -> confirmed -> coasting -> dead
    - Preserve Hungarian assignment (minimize total cost between predicted track positions and observed bundle centroids)
    - The velocity model and prediction should use bundle centroids instead of internally-computed centroids
    - This is a refactor, not a rewrite — preserve the existing tracking quality
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && hatch run test -- tests/unit/core/tracking/ -v 2>&1 | tail -20</automated>
  </verify>
  <done>
    - TrackingStage.run() reads context.associated_bundles as primary input
    - Hungarian backend consumes AssociationBundle centroids for matching
    - No internal re-association (discover_births()) called during pipeline run
    - Tracking unit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tracking tests for bundle-based input</name>
  <files>
    tests/unit/core/tracking/test_tracking_stage.py
  </files>
  <action>
    Update existing tracking stage tests to provide `context.associated_bundles` instead of (or in addition to) `context.detections`:

    1. Update test fixtures that create PipelineContext:
       - Populate `associated_bundles` with mock AssociationBundle objects matching the detection data
       - Each bundle should have fish_idx, centroid_3d (a 3D point), and camera_detections mapping

    2. Add a new test `test_tracking_requires_bundles`:
       - Create context with `associated_bundles=None`
       - Assert that `stage.run(context)` raises ValueError with message about Stage 3

    3. Update existing tests to verify:
       - Tracks are produced from bundle data
       - Fish IDs are assigned persistently across frames
       - Lifecycle states work correctly (probationary -> confirmed)

    4. Verify the test that checks Stage Protocol compliance still passes

    Run full tracking test suite.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && hatch run test -- tests/unit/core/tracking/ -v 2>&1 | tail -20</automated>
  </verify>
  <done>
    - All tracking tests pass with bundle-based input
    - New test confirms ValueError when bundles missing
    - Stage Protocol compliance test passes
  </done>
</task>

</tasks>

<verification>
1. `hatch run test -- tests/unit/core/tracking/ -v` — all tracking tests pass
2. `hatch run test` — full unit test suite passes
3. Verify in code: `grep -n "context.detections" src/aquapose/core/tracking/stage.py` returns 0 lines (tracking no longer reads raw detections as primary input)
</verification>

<success_criteria>
- TrackingStage consumes Stage 3 bundles as primary input
- No redundant internal association in tracking backend
- All unit tests pass
- Fish identity tracking quality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/20-post-refactor-loose-ends/20-04-SUMMARY.md`
</output>
