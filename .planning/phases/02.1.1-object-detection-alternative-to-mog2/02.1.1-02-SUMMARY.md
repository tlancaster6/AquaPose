---
phase: 02.1.1-object-detection-alternative-to-mog2
plan: 02
subsystem: segmentation
tags: [yolo, ultralytics, yolov8, mog2, detector, make_detector, evaluation, unit-tests]

# Dependency graph
requires:
  - phase: 02.1.1-01
    provides: data/yolo_fish/ dataset with 120 train / 30 val annotated frames and dataset.yaml
  - phase: 02.1-segmentation-troubleshooting
    provides: MOG2Detector with watershed-split and shadow-merge logic in detector.py
provides:
  - YOLODetector class in src/aquapose/segmentation/detector.py
  - make_detector('yolo', model_path=...) and make_detector('mog2') factory
  - scripts/train_yolo.py for future retraining runs
  - scripts/eval_yolo_vs_mog2.py for side-by-side YOLO vs MOG2 comparison
  - Unit tests for YOLODetector with mocked ultralytics (no real weights needed)
affects:
  - 02.1.1-03 (pipeline integration — YOLODetector feeds into SAM2 as box prompts)

# Tech tracking
tech-stack:
  added: [ultralytics>=8.0 (added to pyproject.toml dependencies)]
  patterns:
    - "Lazy import of ultralytics YOLO inside __init__ — consistent with SAM2 lazy import pattern, avoids GPU allocation on module import"
    - "make_detector factory: runtime detector selection by string name ('mog2' or 'yolo'), kwargs forwarded to constructor"
    - "Full-frame rectangular mask from padded bbox: YOLO box -> zeros array with bbox region set to 255 — SAM2 compatible mask format"
    - "Mock ultralytics in tests: patch.dict('sys.modules', {'ultralytics': MagicMock(YOLO=...)}) — no real weights needed in CI"

key-files:
  created:
    - scripts/train_yolo.py
    - scripts/eval_yolo_vs_mog2.py
  modified:
    - src/aquapose/segmentation/detector.py
    - src/aquapose/segmentation/__init__.py
    - tests/unit/segmentation/test_detector.py
    - pyproject.toml

key-decisions:
  - "YOLODetector.detect() returns full-frame rectangular mask (not polygon), area = padded bbox pixel count — matches MOG2Detector output format for SAM2 compatibility"
  - "make_detector factory uses **kwargs forwarding, model_path is a required kwarg for 'yolo' (not positional) — consistent with Python kwargs conventions"
  - "eval script re-creates a new MOG2Detector per frame (fresh background model) with optional video warmup via --video-dir; without warmup, MOG2 results are noted as unwarmed"
  - "Training used batch=-1 (auto) to avoid OOM; actual training run (epoch 10, early-stopped) achieved recall=0.780, mAP50=0.799, precision=0.760"

patterns-established:
  - "Detector interchangeability: both MOG2Detector and YOLODetector expose detect(frame) -> list[Detection], enabling drop-in replacement"

requirements-completed:
  - SEG-01
  - SEG-04

# Metrics
duration: ~20 min
completed: 2026-02-20
---

# Phase 02.1.1 Plan 02: YOLO Training and Pipeline Integration — Summary

**YOLOv8n detector trained on 150-frame fish dataset (recall=0.780, mAP50=0.799) and wired into segmentation package as runtime-configurable alternative to MOG2 via `make_detector('yolo', model_path=...)`.**

## Performance

- **Duration:** ~20 min
- **Started:** 2026-02-20T18:20:00Z
- **Completed:** 2026-02-20T18:39:53Z
- **Tasks:** 2 of 3 complete (Task 3 is a human-verify checkpoint — awaiting user review)
- **Files modified:** 6

## Accomplishments

- `YOLODetector` class added to `detector.py` with lazy ultralytics import, padding, and full-frame mask output compatible with SAM2
- `make_detector('yolo', model_path=...)` and `make_detector('mog2')` factory function wired into the segmentation package and exported from `__init__.py`
- 23 new unit tests for `YOLODetector` and `make_detector` using mocked ultralytics (no real weights required in CI); all 187 tests pass
- `scripts/train_yolo.py` — complete CLI training wrapper with auto batch size, early stopping, augmentation
- `scripts/eval_yolo_vs_mog2.py` — side-by-side comparative evaluation with GT loading, greedy IoU matching, annotated image output, and summary table

## Task Commits

Each task was committed atomically:

1. **Task 1: Add YOLODetector and make_detector factory** - `41351ef` (feat)
2. **Task 2: Add YOLO training and eval scripts** - `e4596bf` (feat)
3. **Task 3: Verify YOLO recall beats MOG2** - PENDING (human-verify checkpoint)

## Files Created/Modified

- `src/aquapose/segmentation/detector.py` — Added `YOLODetector` class and `make_detector` factory after `MOG2Detector`
- `src/aquapose/segmentation/__init__.py` — Added `YOLODetector` and `make_detector` to imports and `__all__`
- `tests/unit/segmentation/test_detector.py` — Added 23 tests for `YOLODetector` and `make_detector` with mocked ultralytics
- `pyproject.toml` — Added `"ultralytics>=8.0"` to dependencies
- `scripts/train_yolo.py` — CLI YOLO training script (already run, best.pt exists)
- `scripts/eval_yolo_vs_mog2.py` — Side-by-side YOLO vs MOG2 evaluation with video warmup support

## Decisions Made

- `YOLODetector.detect()` produces a full-frame rectangular mask (zeros with padded bbox region set to 255) rather than the YOLO segmentation mask, for compatibility with the SAM2 box-prompt interface (same format MOG2Detector uses)
- `make_detector` uses `**kwargs` forwarding so `model_path` is passed as a keyword argument to `YOLODetector` — consistent with Python conventions and allows optional conf_threshold/padding_fraction to be set at construction time
- Eval script creates a fresh `MOG2Detector()` per image frame (no shared state across val images), with optional video warmup from `--video-dir`; without warmup, a note is printed warning about the limitation
- `batch=-1` (auto) in `train_yolo.py` default lets ultralytics profile GPU VRAM; actual training run hit early stopping at epoch 10

## Deviations from Plan

None — plan executed exactly as written for Tasks 1 and 2.

Task 3 is a human-verify checkpoint (not an automated task), paused as designed.

## Issues Encountered

- Pre-commit ruff formatter reformatted `eval_yolo_vs_mog2.py` on first commit attempt; re-staged and committed on second attempt (expected behavior, no impact)
- CRLF warning from git on both scripts (Windows line endings) — converted to LF automatically by git, no issue

## User Setup Required

None — all scripts are ready to use. The trained weights already exist at:
- `runs/detect/output/yolo_fish/train_v1/weights/best.pt`

To run the evaluation (requires video files):
```bash
python scripts/eval_yolo_vs_mog2.py \
    --yolo-weights runs/detect/output/yolo_fish/train_v1/weights/best.pt \
    --video-dir /path/to/per-camera/videos \
    --center-camera e3v8340
```

## Next Phase Readiness

- `YOLODetector` and `make_detector` are ready for use in the full pipeline
- Awaiting human verification that YOLO recall exceeds MOG2 recall on the val set (Task 3)
- Once approved, Plan 03 (pipeline integration wiring) can proceed

---
*Phase: 02.1.1-object-detection-alternative-to-mog2*
*Completed: 2026-02-20 (awaiting Task 3 human verification)*
