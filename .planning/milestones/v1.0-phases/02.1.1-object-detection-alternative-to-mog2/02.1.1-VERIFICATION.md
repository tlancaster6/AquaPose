---
phase: 02.1.1-object-detection-alternative-to-mog2
verified: 2026-02-20T19:53:03Z
status: human_needed
score: 15/16 must-haves verified
re_verification:
  previous_status: human_needed
  previous_score: 11/12
  gaps_closed:
    - "YOLODetector detections feed through SAMPseudoLabeler.predict() and produce refined binary masks"
    - "An end-to-end script runs detector -> SAM2 -> Label Studio export with a --detector flag choosing mog2 or yolo"
    - "SAMPseudoLabeler docstrings accurately reflect that both MOG2 and YOLO detections are accepted"
    - "Integration test proves YOLODetector -> SAMPseudoLabeler pipeline produces valid masks without error"
  gaps_remaining: []
  regressions: []
human_verification:
  - test: "Confirm YOLO recall exceeds MOG2 recall on validation frames"
    expected: "Side-by-side eval table shows YOLO recall > MOG2 recall at IoU=0.5 on the 30-frame val set"
    why_human: "Formal head-to-head comparison deferred; YOLO val recall=0.780 accepted at checkpoint. scripts/eval_yolo_vs_mog2.py is ready but no YOLO-vs-MOG2 comparison table with warmed-up MOG2 produced. This is the core claim of the phase goal."
  - test: "Confirm SEG-04 traceability claim is accurate"
    expected: "Either REQUIREMENTS.md updated to mark SEG-04 Complete, or confirm SEG-04 intentionally deferred"
    why_human: "Plans 02 and 03 list SEG-04 in requirements arrays and mark it completed, but REQUIREMENTS.md still shows SEG-04 as Pending. CropDataset from Phase 2 implements 256x256 crop logic. Whether this closes SEG-04 requires a requirements interpretation judgment call."
---

# Phase 02.1.1: Object Detection Alternative to MOG2 - Verification Report

**Phase Goal:** Replace MOG2 background subtraction with a YOLOv8 object detector as a runtime-configurable alternative first-stage fish localizer, trained on 150 manually annotated frames, achieving higher recall than MOG2 on a stratified validation set.
**Verified:** 2026-02-20T19:53:03Z
**Status:** human_needed
**Re-verification:** Yes -- after Plan 03 gap closure (covers Plans 01, 02, and 03)

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | 150 diverse frames exported as JPEGs ready for annotation | VERIFIED | data/yolo_fish/images/train/ has 120 images, val/ has 30 |
| 2 | Frame sampling guided by MOG2 detection counts for hard-case coverage | VERIFIED | scripts/sample_yolo_frames.py bins frames by count (0,1,2,3+) via MOG2Detector.detect() |
| 3 | YOLO-format dataset directory with 80/20 stratified split exists | VERIFIED | data/yolo_fish/images/train+val and labels/train+val present with correct counts |
| 4 | data/yolo_fish/dataset.yaml configured for ultralytics training | VERIFIED | nc=1, names: 0=fish, absolute path correct |
| 5 | YOLOv8n trained on 150-frame fish dataset and weights saved | VERIFIED | runs/detect/output/yolo_fish/train_v1/weights/best.pt exists |
| 6 | YOLODetector produces Detection objects interchangeable with MOG2Detector | VERIFIED | detect() returns list[Detection] with identical (bbox, mask, area, confidence) fields |
| 7 | YOLO detections feed into SAM2 pseudo-labeler without modification | VERIFIED | SAMPseudoLabeler.predict() accepts list[Detection]; uses det.bbox and det.mask identically |
| 8 | Runtime detector selection via make_detector factory | VERIFIED | make_detector in detector.py lines 305-323; exported from __init__.py __all__ |
| 9 | Side-by-side visual comparison of YOLO vs MOG2 boxes exists for validation frames | VERIFIED | output/yolo_eval/ contains annotated .jpg images |
| 10 | ultralytics>=8.0 added to pyproject.toml dependencies | VERIFIED | pyproject.toml line 37 confirmed |
| 11 | Unit tests for YOLODetector with mocked ultralytics pass | VERIFIED | 23 tests in tests/unit/segmentation/test_detector.py covering all behaviors |
| 12 | YOLO recall beats MOG2 recall on 30-frame validation set | NEEDS HUMAN | Comparison deferred; YOLO val recall=0.780 accepted at checkpoint but no warmed MOG2 baseline produced |
| 13 | YOLODetector detections feed through SAMPseudoLabeler.predict() and produce refined binary masks | VERIFIED | Integration test test_yolo_detections_feed_into_sam_predict passes; Detection object structure proven compatible |
| 14 | End-to-end script runs detector -> SAM2 -> Label Studio export with --detector flag | VERIFIED | scripts/run_pseudo_labels.py: 244 lines, make_detector(args.detector) selects YOLO or MOG2 at runtime |
| 15 | SAMPseudoLabeler docstrings accurately reflect both MOG2 and YOLO detections accepted | VERIFIED | All three docstrings updated: module (line 1), class (lines 77-79), predict() (lines 133-134) |
| 16 | Integration test proves YOLODetector -> SAMPseudoLabeler pipeline produces valid masks without error | VERIFIED | test_yolo_sam_integration.py: 245 lines, 3 tests, full chain make_detector->detect->predict->export |

**Score:** 15/16 truths verified (1 needs human)

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| scripts/sample_yolo_frames.py | MOG2-guided frame sampling and export | VERIFIED | 420 lines, bin-based diversity sampling, all CLI args |
| data/yolo_fish/dataset.yaml | YOLO dataset config for ultralytics | VERIFIED | nc=1, names 0=fish, absolute path, train/val splits |
| data/yolo_fish/images/train/ | 120 training images | VERIFIED | 120 images confirmed |
| data/yolo_fish/images/val/ | 30 validation images | VERIFIED | 30 images confirmed |
| src/aquapose/segmentation/detector.py | YOLODetector class and make_detector factory | VERIFIED | class YOLODetector line 238, make_detector line 305 |
| scripts/train_yolo.py | YOLO training script | VERIFIED | 120 lines, full model.train() wrapper |
| scripts/eval_yolo_vs_mog2.py | Comparative evaluation with visual output | VERIFIED | 441 lines, GT loading, IoU matching, annotated image output |
| tests/unit/segmentation/test_detector.py | Unit tests for YOLODetector | VERIFIED | 23 new tests, mocked ultralytics via patch.dict sys.modules |
| runs/detect/output/yolo_fish/train_v1/weights/best.pt | Trained YOLOv8n weights | VERIFIED | File exists |
| scripts/run_pseudo_labels.py | End-to-end pseudo-label script with --detector flag | VERIFIED | 244 lines, full pipeline, all CLI args from plan spec present |
| src/aquapose/segmentation/pseudo_labeler.py | SAMPseudoLabeler with detector-agnostic docstrings | VERIFIED | Module, class, and predict() docstrings updated to reference both MOG2 and YOLO |
| tests/integration/segmentation/test_yolo_sam_integration.py | Integration test for YOLO -> SAM2 pipeline path | VERIFIED | 245 lines, 3 tests, mock-based, GPU-free, full chain verified |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| scripts/sample_yolo_frames.py | detector.py | from aquapose.segmentation import MOG2Detector | WIRED | Line 20 imports MOG2Detector; detector.detect(frame) called |
| detector.py | ultralytics | from ultralytics import YOLO inside YOLODetector.__init__ | WIRED | Lazy import confirmed at line 259 |
| scripts/eval_yolo_vs_mog2.py | detector.py | Uses MOG2Detector and YOLODetector on same frames | WIRED | Both imported; instances created and detect() called |
| detector.py | pseudo_labeler.py | YOLODetector.detect() returns list[Detection] compatible with SAMPseudoLabeler.predict() | WIRED | predict() uses det.bbox and det.mask identically for both detector types |
| __init__.py | detector.py | YOLODetector and make_detector in __all__ | WIRED | Line 4 imports both; lines 23 and 27 in __all__ |
| scripts/run_pseudo_labels.py | detector.py | make_detector(args.detector) to select YOLO or MOG2 at runtime | WIRED | Lines 15, 117, 123: import and both branches call make_detector |
| scripts/run_pseudo_labels.py | pseudo_labeler.py | SAMPseudoLabeler.predict(frame, detections) with detector-produced Detections | WIRED | Line 13, 126: import and instantiation; line 199: labeler.predict(frame, detections) |
| scripts/run_pseudo_labels.py | label_studio.py | export_to_label_studio(all_frames, output_dir) to produce importable JSON | WIRED | Line 14: import; line 232: export_to_label_studio(all_frames, output_dir) called |

### Requirements Coverage

| Requirement | Status | Blocking Issue |
|-------------|--------|----------------|
| SEG-01 - MOG2 detection with >= 95% recall | SATISFIED (pre-existing) | Marked Complete in REQUIREMENTS.md from Phase 2. YOLO adds alternative; MOG2 not regressed. |
| SEG-04 - Segment on 256x256 crops from detection bboxes | NEEDS HUMAN | Plans 02 and 03 both claim completion but REQUIREMENTS.md traceability table still shows Pending. CropDataset from Phase 2 implements 256x256 cropping; YOLO bboxes are compatible inputs. YOLODetector itself does not add crop functionality. Requires requirements interpretation judgment. |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| detector.py | 22 | placeholder in docstring comment | Info | Describes design intent (confidence=1.0 for MOG2), not a code stub. No functional issue. |

No blocker anti-patterns found in any Plan 03 files.

### Human Verification Required

#### 1. YOLO Recall vs MOG2 Recall on Validation Set

**Test:** Run scripts/eval_yolo_vs_mog2.py with video files for MOG2 warmup:

    python scripts/eval_yolo_vs_mog2.py \\
        --yolo-weights runs/detect/output/yolo_fish/train_v1/weights/best.pt \\
        --video-dir /path/to/per-camera/videos \\
        --center-camera e3v8340

**Expected:** Table shows YOLO recall > MOG2 recall at IoU=0.5 on the 30-frame val set.

**Why human:** Formal comparison was deferred at the Plan 02 human-verify checkpoint. User approved YOLO val metrics (recall=0.780) as sufficient to proceed, but the phase goal explicitly requires higher recall than MOG2. The warmed-up MOG2 recall on those same 30 validation frames is unknown. The eval script is ready; only video files for MOG2 warmup are needed. This is the core quantitative claim of the phase goal.

#### 2. SEG-04 Traceability Reconciliation

**Test:** Decide whether REQUIREMENTS.md SEG-04 should be marked Complete.

**Expected:** Either (a) SEG-04 marked Complete in REQUIREMENTS.md because CropDataset from Phase 2 already satisfies the 256x256 crop requirement and YOLO bboxes are compatible inputs, or (b) SEG-04 remains Pending and the over-claim in Plans 02 and 03 requirements arrays is acknowledged.

**Why human:** CropDataset (Phase 2) implements the 256x256 crop logic; YOLO bboxes are compatible inputs to CropDataset. YOLODetector itself does not add crop functionality. Whether the combination satisfies SEG-04 requires a requirements interpretation judgment call that cannot be verified programmatically.

### Re-verification Summary

Plan 03 closed all four new truths it was designed to deliver.

scripts/run_pseudo_labels.py exists with 244 lines of full implementation. make_detector() creates the detector at runtime based on --detector flag, SAMPseudoLabeler refines detections, export_to_label_studio writes the Label Studio JSON. All key links are wired: import at line 15, YOLO branch at line 117, MOG2 branch at line 123, labeler.predict() at line 199, export call at line 232.

pseudo_labeler.py docstrings updated to be detector-agnostic. Module docstring (line 1): from fish detections. Class docstring (lines 77-79): from fish detections using SAM2 and from MOG2 or YOLO. predict() method docstring (lines 133-134): MOG2Detector or YOLODetector via make_detector. No functional code changes confirmed.

tests/integration/segmentation/test_yolo_sam_integration.py exists with 245 lines and 3 substantive tests: (a) Detection object compatibility with SAMPseudoLabeler.predict(), (b) make_detector(yolo) producing correctly-typed Detection fields, (c) full chain from make_detector to export_to_label_studio with JSON structure assertions. No GPU or real weights required.

Both commits verified in git log: 55a5310 (feat: add end-to-end pseudo-label script and update docstrings) and 74c41ce (test: add integration tests for YOLO -> SAM2 -> Label Studio pipeline).

No regressions found. YOLODetector (detector.py line 238), make_detector (line 305), __init__.py exports (lines 4, 23, 27) all confirmed present.

The two human verification items from the initial verification remain open. Neither was in scope for Plan 03, and neither has been resolved. The phase goal core quantitative claim -- YOLO recall > MOG2 recall -- still awaits the formal head-to-head comparison with warmed MOG2 on the same 30 validation frames.

---
_Verified: 2026-02-20T19:53:03Z_
_Verifier: Claude (gsd-verifier)_
