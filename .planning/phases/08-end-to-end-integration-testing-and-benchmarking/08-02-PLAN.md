---
phase: 08-end-to-end-integration-testing-and-benchmarking
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/aquapose/visualization/__init__.py
  - src/aquapose/visualization/overlay.py
  - src/aquapose/visualization/plot3d.py
  - src/aquapose/pipeline/report.py
  - src/aquapose/pipeline/__init__.py
  - tests/unit/visualization/test_overlay.py
autonomous: true
requirements:
  - OUT-02
  - OUT-03

must_haves:
  truths:
    - "System reprojects 3D B-spline midline + width profile onto each camera's video frame via RefractiveProjectionModel.project() and draws the overlay with cv2.polylines/circles"
    - "System renders a 3D animation of midlines in tank coordinates via matplotlib FuncAnimation, saved as MP4 (or GIF fallback)"
    - "Diagnostic mode produces a self-contained Markdown report with embedded figures and a timing summary table"
  artifacts:
    - path: "src/aquapose/visualization/overlay.py"
      provides: "2D reprojection overlay on camera frames"
      exports: ["draw_midline_overlay", "render_overlay_video"]
    - path: "src/aquapose/visualization/plot3d.py"
      provides: "3D scatter plot and MP4 animation of midlines in tank volume"
      exports: ["render_3d_animation", "plot_3d_frame"]
    - path: "src/aquapose/pipeline/report.py"
      provides: "Diagnostic Markdown report generator"
      exports: ["write_diagnostic_report"]
    - path: "tests/unit/visualization/test_overlay.py"
      provides: "Unit tests for overlay rendering"
  key_links:
    - from: "src/aquapose/visualization/overlay.py"
      to: "src/aquapose/reconstruction/triangulation.py"
      via: "evaluates Midline3D B-spline to get 3D points"
      pattern: "BSpline|control_points"
    - from: "src/aquapose/visualization/overlay.py"
      to: "src/aquapose/calibration/projection.py"
      via: "projects 3D points to 2D pixels for overlay"
      pattern: "RefractiveProjectionModel\\.project"
    - from: "src/aquapose/pipeline/report.py"
      to: "src/aquapose/pipeline/orchestrator.py"
      via: "called from reconstruct() in diagnostic mode"
      pattern: "write_diagnostic_report"
---

<objective>
Implement 2D reprojection overlays (OUT-02), 3D midline animation (OUT-03), and diagnostic Markdown report generator.

Purpose: Provide visual QA tools for evaluating reconstruction quality — 2D overlays validate reprojection accuracy per camera, 3D animation validates spatial coherence, and the diagnostic report collates all results into a single reviewable artifact.

Output: `src/aquapose/visualization/` package, `src/aquapose/pipeline/report.py`, unit tests.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-end-to-end-integration-testing-and-benchmarking/08-CONTEXT.md
@.planning/phases/08-end-to-end-integration-testing-and-benchmarking/08-RESEARCH.md
@.planning/phases/08-end-to-end-integration-testing-and-benchmarking/08-01-SUMMARY.md
@src/aquapose/reconstruction/triangulation.py
@src/aquapose/calibration/projection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: 2D overlay renderer and 3D animation</name>
  <files>
    src/aquapose/visualization/__init__.py
    src/aquapose/visualization/overlay.py
    src/aquapose/visualization/plot3d.py
  </files>
  <action>
Create `src/aquapose/visualization/` package:

**`overlay.py`** — 2D reprojection overlay:

`def draw_midline_overlay(frame: np.ndarray, midline: Midline3D, model: RefractiveProjectionModel, *, color: tuple[int, int, int] = (0, 255, 0), thickness: int = 2, n_eval: int = 30, draw_widths: bool = True) -> np.ndarray`:
- Evaluate the B-spline at `n_eval` points using `scipy.interpolate.BSpline(midline.knots, midline.control_points, midline.degree)`
- Project each 3D point to 2D via `model.project(pts_tensor)` (torch tensor input)
- Draw polyline with `cv2.polylines()` using valid projected points
- If `draw_widths=True`: at every 5th point, draw a circle with radius proportional to the half-width at that arc-length position (use the pinhole approximation `radius_px = half_width_m * focal_px / depth_m` where focal_px comes from model intrinsics and depth_m from the projection output)
- Color the overlay by fish_id: assign a fixed color palette (10 distinct colors cycling by `fish_id % 10`)
- Returns the annotated frame (modifies in-place and returns)

`def render_overlay_video(video_path: Path, output_path: Path, midlines_per_frame: list[dict[int, Midline3D]], model: RefractiveProjectionModel, *, fps: float = 30.0, codec: str = "mp4v") -> None`:
- Opens input video with `cv2.VideoCapture`, opens output with `cv2.VideoWriter`
- For each frame, reads the image, draws overlays for all fish in that frame, writes to output
- Handles frame count mismatch gracefully (stop at min of video length and midlines length)
- Releases both captures in finally block

**`plot3d.py`** — 3D visualization:

`def plot_3d_frame(midlines: dict[int, Midline3D], ax: Axes3D | None = None, *, n_eval: int = 30) -> Figure`:
- Evaluate each fish's B-spline and plot as a 3D line with fish_id-colored labels
- Set axis labels (X, Y, Z in metres), equal aspect ratio
- Returns the figure

`def render_3d_animation(midlines_per_frame: list[dict[int, Midline3D]], output_path: Path, *, fps: int = 15, n_eval: int = 30) -> None`:
- Check FFMpeg availability via `matplotlib.animation.FFMpegWriter.isAvailable()`
- If available: use `FFMpegWriter(fps=fps)`, save as MP4
- If not available: fall back to `PillowWriter(fps=fps)`, save as GIF, log a warning
- Use `FuncAnimation` with update function that clears and redraws all fish midlines per frame
- Color each fish_id consistently across frames using the same palette as overlay.py
- Show trajectory trails: for the last 10 frames, plot centroid (control_points mean) as fading dots

**`__init__.py`** — Export `draw_midline_overlay`, `render_overlay_video`, `render_3d_animation`, `plot_3d_frame`.

Define the shared color palette as a module-level constant `FISH_COLORS: list[tuple[int, int, int]]` in `overlay.py` and import it in `plot3d.py` (convert BGR to RGB for matplotlib).
  </action>
  <verify>
    - `hatch run check` passes
    - `python -c "from aquapose.visualization import draw_midline_overlay, render_overlay_video, render_3d_animation, plot_3d_frame"` succeeds
  </verify>
  <done>
    - draw_midline_overlay reprojects 3D midline + width profile onto camera frames
    - render_overlay_video produces per-camera overlay MP4s
    - render_3d_animation produces 3D animation MP4 (or GIF fallback) with trajectory trails
    - All functions use established library patterns (scipy BSpline, cv2.polylines, matplotlib FuncAnimation)
  </done>
</task>

<task type="auto">
  <name>Task 2: Diagnostic report generator and visualization unit tests</name>
  <files>
    src/aquapose/pipeline/report.py
    src/aquapose/pipeline/__init__.py
    tests/unit/visualization/__init__.py
    tests/unit/visualization/test_overlay.py
  </files>
  <action>
**`src/aquapose/pipeline/report.py`** — Diagnostic Markdown report:

`def write_diagnostic_report(output_dir: Path, stage_timing: dict[str, float], midlines_per_frame: list[dict[int, Midline3D]], *, n_frames: int, n_cameras: int, mode: str = "diagnostic") -> Path`:
- Builds a Markdown report at `output_dir / "report.md"` with:
  1. Header with date, mode, n_frames, n_cameras
  2. Stage timing table (stage name, wall time in seconds, percentage of total)
  3. Reconstruction summary: total fish tracked, mean/max residuals across all frames, percentage of low-confidence midlines
  4. Per-frame fish count statistics (min, max, mean, std)
  5. Embedded figure references (relative paths) for:
     - `figures/detection_sample.png` (if exists in output_dir)
     - `figures/segmentation_sample.png` (if exists)
     - `figures/midline_3d_sample.png` (if exists)
     - `figures/overlay_sample.png` (if exists)
  6. All figure paths are relative to output_dir (not absolute)
- Returns the path to the written report

Update `src/aquapose/pipeline/__init__.py` to also export `write_diagnostic_report`.

Also update `src/aquapose/pipeline/orchestrator.py` to call visualization and report functions in diagnostic mode:
- After triangulation, if mode=="diagnostic":
  - Save a sample 3D frame plot to `output_dir/figures/midline_3d_sample.png` via `plot_3d_frame()`
  - Call `write_diagnostic_report()` with timing and midline data
  - Call `render_3d_animation()` to produce `output_dir/midlines_3d.mp4`
  - For each camera, call `render_overlay_video()` to produce `output_dir/overlays/{camera_id}.mp4`

**`tests/unit/visualization/test_overlay.py`** — Tests:

1. `test_draw_midline_overlay_adds_polyline`: Create a dummy 100x100 black frame and a Midline3D with known control points. Mock `RefractiveProjectionModel.project()` to return known pixel coordinates. Verify the returned frame has non-zero pixels along the expected polyline path.
2. `test_draw_midline_overlay_with_widths`: Same setup with `draw_widths=True`, verify circles are drawn (more non-zero pixels than polyline-only).
3. `test_fish_color_palette_has_10_colors`: Verify `FISH_COLORS` has at least 10 distinct entries.

Create `tests/unit/visualization/__init__.py` (empty).

All tests mock the projection model — no GPU, no calibration files needed.
  </action>
  <verify>
    - `hatch run check` passes
    - `hatch run test tests/unit/visualization/test_overlay.py` — all tests pass
    - `python -c "from aquapose.pipeline import reconstruct, ReconstructResult, write_diagnostic_report"` succeeds
  </verify>
  <done>
    - Diagnostic report generates a self-contained Markdown document with timing table, reconstruction stats, and relative figure paths
    - orchestrator.py's diagnostic mode produces overlay videos, 3D animation, and the report
    - 3 unit tests validate overlay rendering with mocked projection
  </done>
</task>

</tasks>

<verification>
- `hatch run check` passes across all new visualization and pipeline files
- `hatch run test tests/unit/visualization/` — all pass
- Diagnostic mode in orchestrator calls visualization + report functions
</verification>

<success_criteria>
- 2D overlay reprojects 3D midline onto camera frames with width indicators (OUT-02)
- 3D animation renders midlines in tank volume with identity coloring and trajectory trails (OUT-03)
- Diagnostic report is a self-contained Markdown with timing, stats, and figures
- All visualizations use relative paths for portability
</success_criteria>

<output>
After completion, create `.planning/phases/08-end-to-end-integration-testing-and-benchmarking/08-02-SUMMARY.md`
</output>
