---
phase: 18-cli-and-execution-modes
plan: 03
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - src/aquapose/core/synthetic.py
  - src/aquapose/core/__init__.py
  - src/aquapose/engine/pipeline.py
  - src/aquapose/cli.py
  - tests/unit/core/test_synthetic.py
  - tests/unit/engine/test_cli.py
  - tests/unit/engine/test_build_stages.py
autonomous: true
requirements: [CLI-04]

must_haves:
  truths:
    - "`aquapose run --mode synthetic --config path.yaml` runs the pipeline using synthetic detections and midlines while real Association, Tracking, and Reconstruction stages execute normally"
    - "Synthetic mode replaces Detection + Midline stages with a SyntheticDataStage that injects known-geometry 3D fish splines projected through the real refractive calibration model"
    - "Synthetic mode still requires a real calibration file — tests synthetic fish in actual camera rig geometry"
    - "Synthetic data is configurable via config file: fish count, frame count, noise level with sensible defaults (3 fish, 30 frames, 0 noise)"
    - "SyntheticDataStage satisfies the Stage protocol — it has run(context) -> context and populates detections, annotated_detections, frame_count, and camera_ids"
  artifacts:
    - path: "src/aquapose/core/synthetic.py"
      provides: "SyntheticDataStage that generates synthetic detections and midlines from known 3D splines"
      contains: "class SyntheticDataStage"
    - path: "tests/unit/core/test_synthetic.py"
      provides: "Unit tests for SyntheticDataStage"
    - path: "src/aquapose/engine/pipeline.py"
      provides: "Mode-aware build_stages() that returns synthetic stage list when mode=='synthetic'"
      contains: "SyntheticDataStage"
    - path: "src/aquapose/cli.py"
      provides: "CLI calls build_stages(config) which is already mode-aware — no synthetic-specific logic in CLI"
      contains: "build_stages"
    - path: "tests/unit/engine/test_build_stages.py"
      provides: "Tests that build_stages returns correct stage list per mode"
  key_links:
    - from: "src/aquapose/engine/pipeline.py"
      to: "src/aquapose/core/synthetic.py"
      via: "build_stages() imports SyntheticDataStage when mode=='synthetic'"
      pattern: "SyntheticDataStage"
    - from: "src/aquapose/core/synthetic.py"
      to: "aquapose.calibration"
      via: "Uses refractive projection model to project 3D splines to 2D views"
      pattern: "project"
    - from: "src/aquapose/core/synthetic.py"
      to: "aquapose.engine.stages.PipelineContext"
      via: "Populates context.detections, context.annotated_detections, context.frame_count, context.camera_ids"
      pattern: "PipelineContext"
---

<objective>
Implement synthetic execution mode with a SyntheticDataStage that replaces Detection + Midline stages with synthetic data generated from known-geometry 3D fish splines projected through the real calibration model.

Purpose: Enables pipeline testing with ground-truth 3D geometry, bypassing real video and segmentation. Useful for verifying reconstruction accuracy, debugging tracking, and benchmarking without GPU-heavy detection/segmentation.

Output: `aquapose run --mode synthetic` that generates synthetic fish data and runs Association, Tracking, Reconstruction on it.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cli-and-execution-modes/18-CONTEXT.md
@.planning/phases/18-cli-and-execution-modes/18-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/aquapose/engine/stages.py:
```python
@runtime_checkable
class Stage(Protocol):
    def run(self, context: PipelineContext) -> PipelineContext: ...

@dataclass
class PipelineContext:
    frame_count: int | None = None
    camera_ids: list[str] | None = None
    detections: list[dict[str, list]] | None = None
    annotated_detections: list[dict[str, list]] | None = None
    associated_bundles: list[list] | None = None
    tracks: list[list] | None = None
    midlines_3d: list[dict] | None = None
    stage_timing: dict[str, float] = field(default_factory=dict)
```

From src/aquapose/engine/config.py:
```python
@dataclass(frozen=True)
class PipelineConfig:
    calibration_path: str = ""
    mode: str = "production"
    # ... stage configs
```

From src/aquapose/engine/pipeline.py:
```python
def build_stages(config: PipelineConfig) -> list[Stage]:
    """Returns [DetectionStage, MidlineStage, AssociationStage, TrackingStage, ReconstructionStage]"""
```

From src/aquapose/calibration (key projection function):
```python
# The AquaCal calibration model provides refractive projection:
# model.project(points_3d) -> points_2d
# Load via: from aquapose.calibration import load_calibration
```

Detection objects that SyntheticDataStage must produce (from src/aquapose/core/detection.py or similar):
```python
# Detection has: bbox (x1,y1,x2,y2), confidence, class_id
# AnnotatedDetection wraps Detection + mask + CropRegion + Midline2D
# The synthetic stage needs to produce these in the same format as real stages
```

From CONTEXT.md decisions on synthetic mode:
- Generate known-geometry 3D fish splines as ground truth
- Project to 2D views via the real refractive calibration model
- Feed as synthetic detections with pre-computed 2D midlines
- Replaces Detection + Midline stages
- Configurable: fish count (default 3), frame count (default 30), noise level (default 0)
- Real calibration file required
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyntheticDataStage with configurable 3D fish generation</name>
  <files>
    src/aquapose/core/synthetic.py
    src/aquapose/core/__init__.py
    src/aquapose/engine/config.py
    src/aquapose/engine/pipeline.py
    tests/unit/core/test_synthetic.py
    tests/unit/engine/test_build_stages.py
  </files>
  <action>
**1. Add SyntheticConfig to `src/aquapose/engine/config.py`:**
```python
@dataclass(frozen=True)
class SyntheticConfig:
    """Config for synthetic data generation in synthetic mode.

    Attributes:
        fish_count: Number of synthetic fish to generate.
        frame_count: Number of frames to simulate.
        noise_std: Standard deviation of Gaussian noise added to 2D projections (pixels). 0 = no noise.
        seed: Random seed for reproducible generation.
    """
    fish_count: int = 3
    frame_count: int = 30
    noise_std: float = 0.0
    seed: int = 42
```
Add `synthetic: SyntheticConfig` field to `PipelineConfig` with default factory. Add to `load_config()` processing (same pattern as other stage configs — parse from YAML key "synthetic", merge CLI overrides). Add SyntheticConfig to engine `__init__.py` exports and `__all__`.

**2. Create `src/aquapose/core/synthetic.py`:**
- Module docstring explaining purpose.
- `class SyntheticDataStage:` satisfying the Stage protocol.
- Constructor: `__init__(self, calibration_path: str, synthetic_config: SyntheticConfig)`.
- `run(self, context: PipelineContext) -> PipelineContext`:
  1. Load calibration from `calibration_path` using `aquapose.calibration.load_calibration`.
  2. Get camera IDs from calibration (all available cameras, excluding e3v8250 per project convention).
  3. Generate `fish_count` 3D fish splines as ground truth:
     - Each fish is a 15-point 3D spline (matching the n_points=15 convention).
     - Position each fish at a reasonable location within the tank (e.g., x in [-0.1, 0.1], y in [-0.1, 0.1], z in [0.0, 0.15] meters — approximate tank dimensions).
     - Use simple straight or slightly curved midlines. Generate with numpy and the configured seed.
     - For multiple frames: add small per-frame displacement to simulate swimming (e.g., translate by small random increments).
  4. For each frame, for each camera:
     - Project each fish's 3D midline points to 2D using the calibration model's `project()` method.
     - If noise_std > 0, add Gaussian noise to 2D projections.
     - Check visibility: only include fish in cameras where all projected points fall within image bounds.
     - Create a Detection object with a bounding box derived from the projected points (min/max of projected 2D points with padding).
     - Create an AnnotatedDetection wrapping the Detection, with:
       - `midline`: a `Midline2D` object containing the projected 2D midline points and synthetic half-widths (e.g., constant 5.0 pixels).
       - `mask`: None (synthetic mode skips segmentation masks).
       - `crop_region`: a CropRegion derived from the bounding box.
  5. Populate context fields:
     - `context.frame_count = frame_count`
     - `context.camera_ids = camera_ids`
     - `context.detections = [per_frame_dict, ...]` (list of dict[str, list[Detection]])
     - `context.annotated_detections = [per_frame_dict, ...]` (list of dict[str, list[AnnotatedDetection]])
  6. Return context.

- Add `SyntheticDataStage` to `src/aquapose/core/__init__.py` imports and `__all__`.

**IMPORTANT:** Before implementing, read the actual Detection, AnnotatedDetection, Midline2D, and CropRegion classes from the codebase to understand their exact constructor signatures. The executor MUST read these files:
- `src/aquapose/core/detection.py` (or wherever Detection lives)
- `src/aquapose/core/midline.py` (or wherever Midline2D lives)
- `src/aquapose/segmentation/crop.py` (CropRegion)
Use `Glob` and `Grep` to find them if needed.

Also read `src/aquapose/calibration/__init__.py` to understand `load_calibration` and the camera model's `project()` API.

**3. Update `src/aquapose/engine/pipeline.py` — make `build_stages()` mode-aware:**

The existing `build_stages(config)` returns 5 stages for production mode. Update it to check `config.mode` and return the appropriate stage list:

- When `config.mode == "synthetic"`:
  1. Import `SyntheticDataStage` from `aquapose.core`.
  2. Return `[SyntheticDataStage(calibration_path=config.calibration_path, synthetic_config=config.synthetic), AssociationStage(...), TrackingStage(...), ReconstructionStage(...)]` — 4 stages total.
  3. The SyntheticDataStage replaces both DetectionStage and MidlineStage.
- For all other modes (production, diagnostic, benchmark): return the existing 5-stage list unchanged.

This keeps `build_stages()` as the canonical stage factory. The CLI simply calls `build_stages(config)` regardless of mode — it does NOT need to know which stages are swapped.

**IMPORTANT:** The mode-aware logic lives in `pipeline.py`, NOT in `cli.py`. This is a locked decision from CONTEXT.md: "build_stages() in pipeline.py is the canonical stage factory — synthetic mode should swap stages at this level."

**4. Create `tests/unit/engine/test_build_stages.py`:**
- Test that `build_stages(config)` with `config.mode == "production"` returns 5 stages starting with DetectionStage.
- Test that `build_stages(config)` with `config.mode == "synthetic"` returns 4 stages starting with SyntheticDataStage.
- Test that synthetic mode preserves AssociationStage, TrackingStage, ReconstructionStage as stages 2-4.
- Mock stage constructors to avoid needing real calibration/video files.

**5. Create `tests/unit/core/test_synthetic.py`:**
- Test that SyntheticDataStage satisfies the Stage protocol: `isinstance(stage, Stage)`.
- Test that `run()` populates `context.frame_count`, `context.camera_ids`, `context.detections`, and `context.annotated_detections`.
- Test that `context.frame_count == synthetic_config.frame_count`.
- Test that each frame has detections for at least some cameras (not necessarily all — visibility depends on fish position).
- Test that annotated_detections have Midline2D objects with 15 points.
- Test determinism: two runs with the same seed produce identical results.
- Test noise: with noise_std > 0, results differ from noise_std=0.
- These tests require a calibration file. Use `@pytest.mark.slow` if calibration file is only available on the dev machine. Alternatively, mock the calibration model for fast unit tests (preferred).
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -m pytest tests/unit/core/test_synthetic.py tests/unit/engine/test_build_stages.py -x -v</automated>
  </verify>
  <done>
    - SyntheticDataStage satisfies Stage protocol
    - Generates configurable number of fish/frames with known 3D geometry
    - Projects through real calibration model to produce realistic 2D detections
    - Populates all context fields that Detection + Midline stages would
    - Deterministic with fixed seed
    - SyntheticConfig added to PipelineConfig
    - build_stages() in pipeline.py is mode-aware — returns 4-stage synthetic list or 5-stage production list
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire synthetic mode into CLI and add CLI tests</name>
  <files>
    src/aquapose/cli.py
    tests/unit/engine/test_cli.py
  </files>
  <action>
**1. Update `src/aquapose/cli.py`:**

The CLI requires NO synthetic-specific stage logic. Since Task 1 already made `build_stages(config)` mode-aware in `pipeline.py`, the CLI's existing call to `build_stages(config)` already handles synthetic mode correctly. The CLI does NOT import `SyntheticDataStage`, `AssociationStage`, `TrackingStage`, or `ReconstructionStage` — it only calls `build_stages(config)`.

The only CLI change needed for synthetic mode:
- Observers for synthetic mode: same as production mode (ConsoleObserver + TimingObserver + HDF5ExportObserver). The synthetic mode is about DATA source, not observer configuration. Add `"synthetic"` to the production-mode branch of `_build_observers()`.
- `ConsoleObserver` already uses `total_stages=len(stages)`, which will be 4 when `build_stages` returns the synthetic stage list.

**IMPORTANT:** Do NOT import any stage classes (SyntheticDataStage, AssociationStage, TrackingStage, ReconstructionStage) in cli.py. The CLI calls `build_stages(config)` and that factory handles all mode-based stage selection. This is a locked decision from CONTEXT.md.

**2. Update `tests/unit/engine/test_cli.py`:**

- `test_synthetic_mode_calls_build_stages`: Mock `build_stages` and `PosePipeline` and verify that `--mode synthetic` still calls `build_stages(config)` (the same factory as all other modes). Assert that cli.py does NOT directly instantiate any stage classes.
- `test_synthetic_mode_uses_production_observers`: Verify observer assembly matches production mode (ConsoleObserver + TimingObserver + HDF5ExportObserver).
- `test_synthetic_mode_passes_mode_in_config`: Verify that `--mode synthetic` sets `config.mode = "synthetic"` so `build_stages` can dispatch correctly.

All tests mock pipeline execution — no real video/calibration needed.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -m pytest tests/unit/engine/test_cli.py -x -v -k "synthetic"</automated>
  </verify>
  <done>
    - `--mode synthetic` uses build_stages(config) which returns the synthetic stage list — CLI has no stage construction logic
    - CLI does NOT import SyntheticDataStage, AssociationStage, TrackingStage, or ReconstructionStage
    - Synthetic mode uses production-mode observers (ConsoleObserver + TimingObserver + HDF5ExportObserver)
    - All CLI tests pass including synthetic mode tests
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/unit/core/test_synthetic.py tests/unit/engine/test_build_stages.py tests/unit/engine/test_cli.py -x -v` — all tests pass
2. `python -c "from aquapose.core.synthetic import SyntheticDataStage; from aquapose.engine.stages import Stage; print(isinstance(SyntheticDataStage.__new__(SyntheticDataStage), Stage))"` — prints True (structural typing)
3. `grep "SyntheticDataStage" src/aquapose/engine/pipeline.py` — confirms synthetic stage wired into build_stages factory
4. `grep -c "SyntheticDataStage\|AssociationStage\|TrackingStage\|ReconstructionStage" src/aquapose/cli.py` returns 0 — CLI does NOT import or construct stages directly
5. `grep -c "def detect\|def triangulate\|def reconstruct\|def segment" src/aquapose/cli.py` returns 0 — no computation logic in CLI
</verification>

<success_criteria>
- `aquapose run --mode synthetic --config path.yaml` runs the pipeline using synthetic data with real Association/Tracking/Reconstruction
- SyntheticDataStage generates known-geometry 3D fish, projects through real calibration, produces Detection+Midline format data
- Synthetic data is configurable (fish count, frame count, noise) via config file
- Stage adapter pattern: swap stages at build_stages level, not pipeline bypass
</success_criteria>

<output>
After completion, create `.planning/phases/18-cli-and-execution-modes/18-03-SUMMARY.md`
</output>
