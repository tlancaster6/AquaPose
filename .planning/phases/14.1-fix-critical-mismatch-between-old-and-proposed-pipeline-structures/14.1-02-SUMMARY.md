---
phase: 14.1-fix-critical-mismatch-between-old-and-proposed-pipeline-structures
plan: "02"
subsystem: engine
tags: [pipeline, engine, config, stages, dataclass, golden-tests]

# Dependency graph
requires:
  - phase: 14.1-01
    provides: Aligned planning documents (ROADMAP, REQUIREMENTS, inbox) to 5-stage model
provides:
  - PipelineContext with 5-stage field names (detections, annotated_detections, associated_bundles, tracks, midlines_3d)
  - MidlineConfig, ReconstructionConfig, AssociationConfig replacing old SegmentationConfig/TriangulationConfig
  - PipelineConfig with midline/association/reconstruction fields instead of segmentation/triangulation
  - load_config() with backward compat for old YAML keys (segmentation/triangulation)
  - Golden test harness docstrings clarifying v1.0-to-5-stage mapping
affects: [phase-15-stage-migrations, future-engine-consumers]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "PipelineContext fields named exactly as guidebook stage outputs — no alias fields"
    - "Config hierarchy: one frozen dataclass per stage, composed into PipelineConfig"
    - "Backward compat in load_config(): old YAML keys accepted, new keys take precedence"

key-files:
  created: []
  modified:
    - src/aquapose/engine/stages.py
    - src/aquapose/engine/config.py
    - src/aquapose/engine/__init__.py
    - tests/unit/engine/test_stages.py
    - tests/unit/engine/test_config.py
    - tests/golden/test_stage_harness.py
    - tests/golden/conftest.py

key-decisions:
  - "load_config() accepts both old YAML keys (segmentation/triangulation) and new keys (midline/reconstruction) — new takes precedence when both present"
  - "AssociationConfig is a placeholder frozen dataclass with no fields — extended in Phase 15"
  - "ReconstructionConfig adds a backend field (default 'triangulation') for future curve_optimizer support"
  - "Golden data .pt files on disk unchanged — only test code and engine infrastructure modified"

patterns-established:
  - "Stage output fields in PipelineContext match guidebook stage names exactly — no translation layer"
  - "New stage configs placeholder pattern: empty frozen dataclass with docstring explaining future extension"

requirements-completed: []

# Metrics
duration: 7min
completed: 2026-02-25
---

# Phase 14.1 Plan 02: Update Engine Code and Golden Tests to 5-Stage Model Summary

**Engine PipelineContext and config hierarchy aligned to guidebook's 5-stage model: MidlineConfig/ReconstructionConfig/AssociationConfig replace old SegmentationConfig/TriangulationConfig, annotated_detections/associated_bundles replace masks/midline_sets fields, golden test docstrings clarify v1.0-to-5-stage mapping**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-25T22:53:46Z
- **Completed:** 2026-02-25T23:00:29Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- PipelineContext updated to 5-stage data flow: removed `masks` and `midline_sets`, added `annotated_detections` (Stage 2 output) and `associated_bundles` (Stage 3 output)
- Config hierarchy renamed to match guidebook stage names: `SegmentationConfig` -> `MidlineConfig`, `TriangulationConfig` -> `ReconstructionConfig`, new `AssociationConfig` placeholder added
- `PipelineConfig` updated with `midline`, `association`, `reconstruction` fields; `load_config()` accepts both old and new YAML key names for backward compatibility
- `__init__.py` exports updated to expose new config names and remove old ones
- Golden test harness module docstring and individual test docstrings updated with explicit v1.0-to-5-stage mapping table
- All 456 unit tests pass; golden module imports without errors; lint passes on all modified files

## Task Commits

Each task was committed atomically:

1. **Task 1: Update PipelineContext fields and config dataclasses to match 5-stage model** - `ced4695` (feat)
2. **Task 2: Update golden test harness to clarify 5-stage mapping** - `5399cfd` (docs)

## Files Created/Modified

- `src/aquapose/engine/stages.py` - PipelineContext updated: removed masks/midline_sets, added annotated_detections/associated_bundles with 5-stage docstring
- `src/aquapose/engine/config.py` - SegmentationConfig->MidlineConfig, TriangulationConfig->ReconstructionConfig, added AssociationConfig; load_config() updated with new kwargs and backward compat
- `src/aquapose/engine/__init__.py` - Exports: removed SegmentationConfig/TriangulationConfig, added MidlineConfig/ReconstructionConfig/AssociationConfig
- `tests/unit/engine/test_stages.py` - Updated test_pipeline_context_defaults_none to check new fields
- `tests/unit/engine/test_config.py` - Updated all tests to use new config field names (midline, reconstruction); added reconstruction.backend assertion
- `tests/golden/test_stage_harness.py` - Module docstring with v1.0-to-5-stage mapping table; updated 4 test docstrings
- `tests/golden/conftest.py` - Added module-level comment explaining v1.0 data is the golden reference

## Decisions Made

- `load_config()` accepts both old YAML keys (`segmentation`, `triangulation`) and new keys (`midline`, `reconstruction`) for backward compatibility — new names take precedence when both present. Avoids breaking any existing YAML configs while migrating to correct naming.
- `AssociationConfig` is an empty placeholder frozen dataclass — Association (Stage 3) parameters are unknown until Phase 15 designs the stage.
- `ReconstructionConfig` adds a `backend` field with default `"triangulation"` to support future `"curve_optimizer"` backend without a breaking config schema change.
- Golden `.pt` files on disk left completely unchanged — only test code and docstrings were modified as required by the plan.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None — all changes straightforward, 456 unit tests green after Task 1.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Engine infrastructure now accurately describes the 5-stage pipeline that Phase 15 will implement
- PipelineContext field names match guidebook stage output names exactly — Stage implementations can populate fields without any naming translation
- Config hierarchy ready: one frozen dataclass per stage, all named and documented
- Golden test harness clearly documents which v1.0 data maps to which new stage — Phase 15 implementers have a clear regression target

---
*Phase: 14.1-fix-critical-mismatch-between-old-and-proposed-pipeline-structures*
*Completed: 2026-02-25*
