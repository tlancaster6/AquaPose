---
phase: 20-post-refactor-loose-ends
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquapose/cli.py
  - src/aquapose/engine/observer_factory.py
  - src/aquapose/engine/__init__.py
  - src/aquapose/core/detection/stage.py
  - src/aquapose/core/midline/stage.py
  - src/aquapose/core/association/stage.py
  - src/aquapose/core/association/backends/ransac_centroid.py
  - src/aquapose/core/tracking/stage.py
  - src/aquapose/core/reconstruction/stage.py
  - src/aquapose/core/reconstruction/backends/triangulation.py
  - src/aquapose/core/reconstruction/backends/curve_optimizer.py
  - src/aquapose/engine/pipeline.py
  - src/aquapose/engine/config.py
autonomous: true
requirements: [REMEDIATE]

must_haves:
  truths:
    - "No _DEFAULT_SKIP_CAMERA_ID constant exists in any file"
    - "No skip_camera_id parameter exists on any stage constructor"
    - "CLI is under ~120 LOC — observer assembly logic lives in engine/"
    - "build_observers() is callable from engine layer"
    - "Pipeline processes all cameras in the input directory without filtering"
  artifacts:
    - path: "src/aquapose/engine/observer_factory.py"
      provides: "build_observers() factory function"
      exports: ["build_observers"]
    - path: "src/aquapose/cli.py"
      provides: "Thin CLI wrapper"
  key_links:
    - from: "src/aquapose/cli.py"
      to: "src/aquapose/engine/observer_factory.py"
      via: "import build_observers"
      pattern: "from aquapose.engine.observer_factory import build_observers"
---

<objective>
Remove all camera skip logic (AUD-007) and extract observer assembly from CLI to engine (AUD-002).

Purpose: Camera skip removal embodies the philosophical shift that the pipeline processes everything in the input directory — no internal filtering. CLI thinning moves business logic (observer assembly) to the engine layer where it belongs, leaving CLI as a true thin wrapper.

Output: No skip_camera_id anywhere in the codebase; build_observers() in engine/observer_factory.py; CLI at ~100-120 LOC.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-post-refactor-loose-ends/20-CONTEXT.md

<interfaces>
<!-- Current skip_camera_id locations (all to be removed) -->
9 _DEFAULT_SKIP_CAMERA_ID constants in:
- core/detection/stage.py:29,68
- core/midline/stage.py:28,76
- core/association/stage.py:28,64
- core/association/backends/ransac_centroid.py:20,51
- core/tracking/stage.py:36,73
- core/reconstruction/stage.py:31,77
- core/reconstruction/backends/triangulation.py:26,53
- core/reconstruction/backends/curve_optimizer.py:22,50

<!-- Current _build_observers to extract -->
From src/aquapose/cli.py lines 41-113:
```python
def _build_observers(config, mode, verbose, total_stages, extra_observers) -> list[Observer]:
    # 73 lines of observer assembly logic
```

Also: _OBSERVER_MAP dict at cli.py:31-38
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove all camera skip logic from stage files and pipeline config</name>
  <files>
    src/aquapose/core/detection/stage.py
    src/aquapose/core/midline/stage.py
    src/aquapose/core/association/stage.py
    src/aquapose/core/association/backends/ransac_centroid.py
    src/aquapose/core/tracking/stage.py
    src/aquapose/core/reconstruction/stage.py
    src/aquapose/core/reconstruction/backends/triangulation.py
    src/aquapose/core/reconstruction/backends/curve_optimizer.py
    src/aquapose/engine/pipeline.py
    src/aquapose/engine/config.py
  </files>
  <action>
    In ALL 8 core stage/backend files listed above:
    1. Delete the `_DEFAULT_SKIP_CAMERA_ID = "e3v8250"` constant
    2. Remove `skip_camera_id` from the `__init__` parameter list
    3. Remove any `self._skip_camera_id` storage
    4. In `run()` methods and backend processing, remove any filtering that skips cameras matching skip_camera_id. Look for patterns like:
       - `if cam_id == self._skip_camera_id: continue`
       - `[c for c in cameras if c != self._skip_camera_id]`
       - Any conditional that references skip_camera_id
    5. Remove the associated "Camera to exclude" comments
    6. Update the class docstrings to remove skip_camera_id parameter documentation

    In `src/aquapose/engine/pipeline.py` `build_stages()`:
    - Remove any `skip_camera_id=...` kwargs passed to stage constructors (if present — check both standard and synthetic paths)

    In `src/aquapose/engine/config.py`:
    - Check if `skip_camera_id` exists as a field on `PipelineConfig` or any sub-config. If so, remove it.
    - If it's in the template YAML generation, remove it there too.

    The result: if a user doesn't want a camera analyzed, they don't include its video in the input directory. Zero filtering logic inside the pipeline.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && grep -rn "skip_camera" src/aquapose/ | grep -v __pycache__ | wc -l</automated>
  </verify>
  <done>
    - 0 occurrences of "skip_camera" in src/aquapose/
    - 0 occurrences of "_DEFAULT_SKIP_CAMERA_ID" in src/aquapose/
    - No camera filtering logic in any stage run() method
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract observer assembly from CLI to engine/observer_factory.py</name>
  <files>
    src/aquapose/engine/observer_factory.py
    src/aquapose/engine/__init__.py
    src/aquapose/cli.py
  </files>
  <action>
    1. Create `src/aquapose/engine/observer_factory.py`:
       - Move `_OBSERVER_MAP` dict and `_build_observers()` function from `cli.py`
       - Rename `_build_observers` to `build_observers` (public API)
       - Add proper module docstring, Google-style docstrings, type hints
       - Import all observer types from engine (TimingObserver, HDF5ExportObserver, etc.)
       - Import Observer Protocol from engine.observers
       - Import PipelineConfig from engine.config

    2. Update `src/aquapose/engine/__init__.py`:
       - Add `from aquapose.engine.observer_factory import build_observers` to exports
       - Add `build_observers` to `__all__`

    3. Slim down `src/aquapose/cli.py`:
       - Remove `_OBSERVER_MAP` and `_build_observers()` entirely
       - Import `build_observers` from `aquapose.engine.observer_factory` (or via `aquapose.engine`)
       - Remove observer-specific imports that are no longer needed in CLI (TimingObserver, HDF5ExportObserver, etc. — only import what CLI directly references)
       - The `run()` command should call `build_observers(config, mode, verbose, len(stages), extra_observers)` — one line instead of the inline function
       - CLI should end up at approximately 100-120 LOC

    Target CLI structure after thinning:
    ```python
    # Imports: click, Path, yaml, engine imports (PipelineConfig, PosePipeline, load_config, build_stages, build_observers)
    # @click.group cli()
    # @cli.command run() — parse args, load config, build stages, build observers, run pipeline
    # @cli.command init-config() — generate template YAML
    # def main()
    ```
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -c "from aquapose.engine.observer_factory import build_observers; print('OK')" && wc -l src/aquapose/cli.py</automated>
  </verify>
  <done>
    - build_observers() is importable from aquapose.engine.observer_factory
    - CLI is ~100-120 LOC
    - `aquapose run --help` still works
    - Observer assembly logic lives in engine layer, not CLI layer
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "skip_camera" src/aquapose/ | grep -v __pycache__` returns 0 lines
2. `wc -l src/aquapose/cli.py` shows ~100-120 lines
3. `python -c "from aquapose.engine import build_observers; print('OK')"` succeeds
4. `hatch run test` passes all unit tests
</verification>

<success_criteria>
- Zero skip_camera references in src/aquapose/
- CLI under ~120 LOC
- build_observers() available as engine public API
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-post-refactor-loose-ends/20-03-SUMMARY.md`
</output>
