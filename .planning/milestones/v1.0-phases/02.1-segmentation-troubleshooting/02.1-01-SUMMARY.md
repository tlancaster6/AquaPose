---
phase: 02.1-segmentation-troubleshooting
plan: "01"
subsystem: segmentation
tags: [mog2, opencv, background-subtraction, fish-detection, diagnostic]

# Dependency graph
requires:
  - phase: 02-segmentation-pipeline
    provides: MOG2Detector with 2-stage shadow fix in detector.py
provides:
  - Consolidated MOG2 diagnostic script (scripts/test_mog2.py) with --cameras filter and side-by-side annotated stills
  - 20 annotated JPEG stills in output/test_mog2/ (10 per camera for e3v8250 and e3v83eb)
  - Per-frame detection counts and per-camera avg/min/max summary
affects:
  - 02.1-02-SAM2-test (MOG2 detection counts inform SAM2 evaluation scope)
  - 02.1-03-maskrcnn (indirect: MOG2 quality gates the full segmentation pipeline)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Diagnostic scripts in scripts/ use detector._mog2.apply(learningRate=0) for visualization-only mask extraction — acceptable in scripts, not in library code"
    - "Side-by-side left (overlaid detections) + right (colorized MOG2 mask) panel layout for visual QA of detection quality"
    - "--cameras arg with 'all' passthrough for selective vs exhaustive camera processing"

key-files:
  created:
    - scripts/test_mog2.py
  modified: []

key-decisions:
  - "No automated PASS/FAIL in test_mog2.py — detection quality is assessed visually from stills (plan requirement)"
  - "Default cameras e3v8250 (center) and e3v83eb (side) capture two view angles for representative coverage"
  - "2-stage shadow fix in detector.py: Stage 1 merges shadow+foreground masks (fg_mask >= 127); Stage 2 uses watershed on foreground-only cores (fg_mask == 255) to split merged blobs"

patterns-established:
  - "MOG2 diagnostic: sample evenly-spaced frames after 500-frame warmup, feed intermediate frames between samples to keep background model current"

requirements-completed: [SEG-1]

# Metrics
duration: 8min
completed: 2026-02-20
---

# Phase 02.1 Plan 01: MOG2 Detection Diagnostic Summary

**Consolidated two MOG2 diagnostic scripts into scripts/test_mog2.py with --cameras filter; validated 2-stage shadow fix on real aquarium footage producing annotated side-by-side stills for visual QA**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-20T13:36:10Z
- **Completed:** 2026-02-20T13:44:22Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Consolidated `scripts/diagnose_mog2.py` and `scripts/verify_mog2_recall.py` into a single `scripts/test_mog2.py` with `--cameras` arg (default: center e3v8250 + side e3v83eb; pass `all` for all 13)
- Ran on both default cameras: 20 annotated side-by-side JPEG stills saved to `output/test_mog2/`
- Per-frame detection counts logged and per-camera summary printed

## Detection Count Observations

| Camera | Frames | Avg Det | Min Det | Max Det |
|--------|--------|---------|---------|---------|
| e3v8250 (center) | 10 | 7.0 | 3 | 12 |
| e3v83eb (side) | 10 | 9.2 | 0 | 18 |

Total: 162 detections across 20 sampled frames.

**Notable:** e3v83eb frame 006765 shows 0 detections — likely a stationary-fish frame where MOG2 background model has absorbed the fish. e3v83eb also shows counts up to 18, suggesting blob-splitting may be fragmenting single fish into multiple detections at higher activity frames. Visual inspection of the stills required to confirm. The 9-fish expectation means counts >9 indicate false positives or over-splitting; counts <9 indicate missed fish or under-splitting.

## The Existing 2-Stage Shadow Fix in detector.py

The `MOG2Detector.detect()` method implements a two-stage approach to handle MOG2 shadow misclassification:

**Stage 1 — Shadow+Foreground Union:**
MOG2 classifies pixels as foreground (255), shadow (127), or background (0). Fish moving through the frame are often classified as shadows rather than foreground, especially in low-contrast conditions. Stage 1 combines shadow and foreground pixels (`fg_mask >= 127`) into a single binary mask before finding connected components. This ensures shadow-classified fish are not discarded.

**Stage 2 — Watershed Split for Merged Blobs:**
When two fish are close together, Stage 1's union mask merges them into a single blob. Stage 2 detects this by looking for multiple foreground-only (255) cores within a single blob. When multiple cores exist, it runs a distance-transform watershed using the foreground cores as seeds to split the merged blob into individual fish detections.

**Shadow threshold:** `setShadowThreshold(200)` is set on the MOG2 model, which tightens the shadow detection range (default is 0.5 intensity ratio). Combined with the two-stage approach, this allows flexible shadow inclusion without false-positive explosion.

No parameter changes were needed — production defaults (history=500, var_threshold=12, min_area=200) were used as specified.

## Task Commits

Each task was committed atomically:

1. **Task 1: Consolidate MOG2 diagnostic scripts and run on default cameras** - `3434adf` (feat)

**Plan metadata:** (to be committed with this summary)

## Files Created/Modified
- `scripts/test_mog2.py` - Consolidated MOG2 diagnostic script: per-camera sampling, side-by-side visualization, detection count logging, --cameras filter

## Decisions Made
- No automated PASS/FAIL threshold — plan explicitly requires visual QA by the user, not programmatic gate
- Removed recall_proxy computation from the consolidated script (plan 01 intent is visual assessment, not numeric recall scoring — that framing belongs to the original verify_mog2_recall.py which was pre-plan 02.1)
- Default camera pair (e3v8250 + e3v83eb) represents center view + angled side view for representative dual-angle coverage

## Deviations from Plan

None - plan executed exactly as written. The existing `scripts/test_mog2.py` was a partial earlier draft missing the `--cameras` arg; it was updated to match the plan specification.

## Issues Encountered
- Pre-commit ruff hooks reformatted the file on first commit attempt — re-staged and recommitted cleanly.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- `scripts/test_mog2.py` is ready for full 13-camera run: `hatch run python scripts/test_mog2.py --cameras all`
- Annotated stills in `output/test_mog2/` are ready for visual review by user
- Plan 02.1-02 (SAM2 evaluation) can proceed once user reviews MOG2 stills and confirms acceptable detection quality
- The 0-detection frame for e3v83eb (frame 006765) and high counts (18) are worth inspecting in the stills before moving on

---
*Phase: 02.1-segmentation-troubleshooting*
*Completed: 2026-02-20*
