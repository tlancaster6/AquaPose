---
phase: 02.1.1-object-detection-alternative-to-mog2
plan: 03
type: execute
wave: 3
depends_on:
  - 02.1.1-01
  - 02.1.1-02
files_modified:
  - src/aquapose/segmentation/pseudo_labeler.py
  - scripts/run_pseudo_labels.py
  - tests/integration/segmentation/test_yolo_sam_integration.py
autonomous: true
requirements:
  - SEG-01
  - SEG-04
must_haves:
  truths:
    - "YOLODetector detections feed through SAMPseudoLabeler.predict() and produce refined binary masks"
    - "An end-to-end script runs detector -> SAM2 -> Label Studio export with a --detector flag choosing mog2 or yolo"
    - "SAMPseudoLabeler docstrings accurately reflect that both MOG2 and YOLO detections are accepted"
    - "Integration test proves YOLODetector -> SAMPseudoLabeler pipeline produces valid masks without error"
  artifacts:
    - path: "scripts/run_pseudo_labels.py"
      provides: "End-to-end pseudo-label generation script with configurable detector"
      contains: "--detector"
    - path: "src/aquapose/segmentation/pseudo_labeler.py"
      provides: "SAMPseudoLabeler with detector-agnostic docstrings"
    - path: "tests/integration/segmentation/test_yolo_sam_integration.py"
      provides: "Integration test for YOLO -> SAM2 pipeline path"
  key_links:
    - from: "scripts/run_pseudo_labels.py"
      to: "src/aquapose/segmentation/detector.py"
      via: "make_detector(args.detector, ...) to select YOLO or MOG2 at runtime"
      pattern: "make_detector"
    - from: "scripts/run_pseudo_labels.py"
      to: "src/aquapose/segmentation/pseudo_labeler.py"
      via: "SAMPseudoLabeler.predict(image, detections) with detector-produced Detections"
      pattern: "SAMPseudoLabeler.*predict"
    - from: "scripts/run_pseudo_labels.py"
      to: "src/aquapose/segmentation/label_studio.py"
      via: "export_to_label_studio(frames, output_dir) to produce importable JSON"
      pattern: "export_to_label_studio"
---

<objective>
Wire YOLODetector into the SAM2 pseudo-labeling workflow as a drop-in alternative to MOG2, with an end-to-end script and integration test proving the full path works.

Purpose: Plans 01-02 built the YOLODetector class and verified it produces compatible Detection objects. This plan closes the loop by creating a runnable pipeline script that goes from video frames through detector -> SAM2 -> Label Studio export, with a CLI flag to choose between YOLO and MOG2. This makes the YOLO path usable for real annotation workflows.
Output: `scripts/run_pseudo_labels.py` end-to-end script, updated pseudo_labeler docstrings, integration test.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1.1-object-detection-alternative-to-mog2/02.1.1-02-SUMMARY.md
@src/aquapose/segmentation/detector.py
@src/aquapose/segmentation/pseudo_labeler.py
@src/aquapose/segmentation/label_studio.py
@src/aquapose/segmentation/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pseudo_labeler docstrings and create end-to-end pseudo-label script</name>
  <files>
    src/aquapose/segmentation/pseudo_labeler.py
    scripts/run_pseudo_labels.py
  </files>
  <action>
1. **src/aquapose/segmentation/pseudo_labeler.py**: Update stale docstrings that reference only MOG2 to be detector-agnostic.

   - Module docstring (line 1): Change `"SAM2 pseudo-label generation from MOG2 detections."` to `"SAM2 pseudo-label generation from fish detections."`.
   - `SAMPseudoLabeler` class docstring (line 77): Change `"Generate high-quality pseudo-label masks from MOG2 detections using SAM2."` to `"Generate high-quality pseudo-label masks from fish detections using SAM2."`. Change `"Wraps SAM2ImagePredictor to refine rough MOG2 detection masks"` to `"Wraps SAM2ImagePredictor to refine rough detection masks (from MOG2 or YOLO)"`.
   - `predict()` method docstring (line 133 area): Change `"detections: List of Detection objects from MOG2Detector."` to `"detections: List of Detection objects from any detector (MOG2Detector or YOLODetector via make_detector)."`.

   Do NOT change any functional code — only docstrings.

2. **scripts/run_pseudo_labels.py**: Create an end-to-end script that runs the full pseudo-label generation pipeline with configurable detector.

   CLI arguments:
   - `--video-dir` (required): Path to directory containing per-camera video files.
   - `--detector` (default `"yolo"`): Detector type — `"mog2"` or `"yolo"`.
   - `--yolo-weights` (default `"runs/detect/output/yolo_fish/train_v1/weights/best.pt"`): Path to YOLO weights. Required when `--detector yolo`.
   - `--output-dir` (default `"output/pseudo_labels/"`): Directory for Label Studio export.
   - `--sam-model` (default `"facebook/sam2.1-hiera-large"`): SAM2 model variant.
   - `--frame-stride` (default 100): Process every Nth frame from each video.
   - `--warmup-frames` (default 200): Number of warmup frames for MOG2 (ignored for YOLO).
   - `--max-frames-per-camera` (default 10): Maximum frames to process per camera.
   - `--center-camera` (default `"e3v8340"`): Center camera ID (for MOG2 warmup distinction).
   - `--conf-threshold` (default 0.25): YOLO confidence threshold.

   Implementation:
   a. Use `make_detector(args.detector, ...)` to create the detector. For YOLO, pass `model_path=args.yolo_weights, conf_threshold=args.conf_threshold`. For MOG2, pass no extra args.
   b. Create `SAMPseudoLabeler(model_variant=args.sam_model)`.
   c. For each video file in `--video-dir`:
      - Parse camera_id from filename (assume format `{camera_id}.mp4` or similar — use stem).
      - Open video with cv2.VideoCapture.
      - If detector is MOG2: warm up with `--warmup-frames` frames via `detector.apply(frame)`.
      - Sample frames at `--frame-stride` intervals, up to `--max-frames-per-camera` per camera.
      - For each sampled frame:
        - Run `detector.detect(frame)` to get detections.
        - Run `labeler.predict(frame, detections)` to get refined SAM2 masks.
        - Build a `FrameAnnotation(frame_id=f"{camera_id}_frame_{idx:06d}", image_path=saved_jpeg_path, masks=masks, camera_id=camera_id)`.
        - Save the frame as JPEG to `{output_dir}/images/`.
   d. Call `export_to_label_studio(all_frames, output_dir)` to produce the tasks JSON.
   e. Print summary: number of cameras processed, total frames, total detections, total masks, path to tasks JSON.

   Imports:
   ```python
   from aquapose.segmentation import (
       SAMPseudoLabeler,
       export_to_label_studio,
       make_detector,
   )
   from aquapose.segmentation.pseudo_labeler import FrameAnnotation
   ```

   Handle the case where `--detector yolo` but `--yolo-weights` does not exist: print an error and exit with code 1.
   Handle the case where MOG2 detector does not have a `.apply()` method call for YOLO (YOLO has no warmup step — skip warmup when detector is yolo).
  </action>
  <verify>
`python scripts/run_pseudo_labels.py --help` prints all CLI arguments correctly.
`python -c "from aquapose.segmentation.pseudo_labeler import SAMPseudoLabeler; help(SAMPseudoLabeler.predict)"` shows updated docstring referencing both MOG2 and YOLO.
`hatch run lint` passes on both modified files.
  </verify>
  <done>
End-to-end pseudo-label script exists with --detector flag for runtime YOLO/MOG2 selection, and pseudo_labeler docstrings are detector-agnostic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration test for YOLO -> SAM2 pipeline path</name>
  <files>
    tests/integration/segmentation/test_yolo_sam_integration.py
  </files>
  <action>
Create `tests/integration/segmentation/test_yolo_sam_integration.py` with integration tests proving the YOLO -> SAM2 path works end-to-end using mocks (no real GPU or model weights needed).

Tests to create:

1. **test_yolo_detections_feed_into_sam_predict**: Create a mock YOLODetector that returns a `list[Detection]` with one detection (bbox=(100,100,200,200), full-frame mask 480x640, area=40000, confidence=0.85). Create a mock SAMPseudoLabeler with a monkeypatched `predict()` that returns a fake binary mask. Call `labeler.predict(fake_image, detections)` and assert:
   - Returns a list of np.ndarray
   - Each mask has shape matching the input image (480, 640)
   - Mask values are 0 or 255

2. **test_make_detector_yolo_produces_compatible_detections**: Use `make_detector("yolo", model_path="dummy.pt")` with mocked ultralytics (same pattern as existing unit tests in test_detector.py — monkeypatch `sys.modules` with a MagicMock YOLO). Call `detect()` on a synthetic frame (np.zeros 480x640x3 uint8). Assert each Detection has:
   - `bbox` is a tuple of 4 ints
   - `mask` is np.ndarray with shape (480, 640)
   - `confidence` is a float in [0, 1]
   - `area` is a positive int

3. **test_full_pipeline_detector_to_export**: Mock both detector and SAM2. Run the full chain: `make_detector() -> detector.detect() -> labeler.predict() -> FrameAnnotation -> export_to_label_studio()`. Assert:
   - The tasks JSON file is written
   - JSON contains the expected number of tasks
   - Each task has "data" with "image", "frame_id", "camera_id" keys
   - Tasks with masks have "predictions" with "result" entries

Use `@pytest.fixture` for mock setup. Use `tmp_path` for output files. Use `monkeypatch` to patch ultralytics and SAM2 imports.

Mark all tests with `@pytest.mark.integration` if such a marker is configured, otherwise use no special marker (these tests should run with `hatch run test` since they use only mocks).

Ensure the test file has:
- Module docstring
- Proper imports from aquapose.segmentation
- Google-style docstrings on fixtures

Run `hatch run test` to verify all tests pass (existing + new).
  </action>
  <verify>
`hatch run test` passes with the new integration tests included.
`hatch run lint` passes.
`hatch run typecheck` passes (or at least does not regress).
  </verify>
  <done>
Integration tests verify that YOLODetector detections flow through SAMPseudoLabeler and export_to_label_studio without error, using mocked models.
  </done>
</task>

</tasks>

<verification>
- `scripts/run_pseudo_labels.py` exists, runs `--help` without error, and accepts `--detector mog2|yolo`
- `pseudo_labeler.py` docstrings reference both MOG2 and YOLO detectors
- Integration tests in `tests/integration/segmentation/test_yolo_sam_integration.py` pass
- `hatch run test` passes (all existing + new tests)
- `hatch run lint` passes
- No functional code changes to pseudo_labeler.py — only docstrings updated
</verification>

<success_criteria>
The YOLO -> SAM2 -> Label Studio export pipeline is runnable via a single script with `--detector yolo`, integration-tested with mocks, and the codebase docstrings accurately reflect that both YOLO and MOG2 detectors are supported throughout the pseudo-labeling workflow.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1.1-object-detection-alternative-to-mog2/02.1.1-03-SUMMARY.md`
</output>
