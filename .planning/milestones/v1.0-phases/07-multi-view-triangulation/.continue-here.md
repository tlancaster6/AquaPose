---
phase: 07-multi-view-triangulation
task: triangulation-diagnostics
total_tasks: N/A (ad-hoc debugging session)
status: in_progress
last_updated: 2026-02-22T07:21:12.926Z
---

<current_state>
Investigating why 3D triangulation produces bad metrics (94px mean residual, 0.77m
arc length) despite per-camera spline overlays showing good visual alignment for
8/9 fish. Committed diagnostic improvements and metric fixes. User is running an
overnight 5-minute (9000 frame) diagnostic run with enhanced reporting.
</current_state>

<completed_work>

- Created `scripts/per_camera_spline_overlay.py` - standalone diagnostic that runs
  the full pipeline and generates per-camera overlay images at a target frame showing
  both 2D midline dots and 3D spline reprojections for visual comparison
- Fixed `_triangulate_body_point` to return mean residual (was max); 2-camera path
  now computes actual reprojection error (was hardcoded 0.0)
- Changed residual computation in `triangulate_midlines` from raw per-point
  triangulation residuals to **spline-based residuals** (reproject fitted spline into
  every observing camera and compare against 2D midline observations)
- Changed `is_low_confidence` from `min_n_cams <= 2` (flags entire fish if ANY single
  body point has <=2 cameras) to fraction-based: flags when >20% of body points have
  <3 cameras
- Added `per_camera_residuals: dict[str, float]` field to `Midline3D` dataclass
- Added Fish x Camera residual matrix to diagnostic report (values >50px bolded)
- Added arc length distribution table (percentiles P5/P25/median/P75/P95)
- Added temporal stability table (per-fish arc length CoV, flags >0.3)
- Added `per_frame_metrics.csv` export for time-series analysis
- Fixed 3D animation axis scaling: uses 2nd/98th percentile bounds instead of raw
  min/max (one outlier fish was stretching axes to ~20m)
- Updated inline triangulation in `diagnose_pipeline.py` to match all fixes
- All 21 unit tests pass
- Committed as `e6b494d`
</completed_work>

<remaining_work>

- Review overnight diagnostic report (report.md + per_frame_metrics.csv) from the
  5-minute run to identify root cause of bad metrics
- The Fish x Camera residual matrix should pinpoint whether the issue is:
  - Cross-view identity mismatch (specific fish+camera cells with huge residuals)
  - Systematic calibration error (entire camera column with high residuals)
- The temporal stability table should show if arc lengths are stable per-fish (good
  reconstruction, just wrong scale) or wildly varying (identity swaps)
- Once root cause is identified, fix the actual triangulation/tracking issue
- Expected outcome: mean residual <15px, arc length ~0.1m, low-confidence rate <20%
</remaining_work>

<decisions_made>

- Spline-based residuals over per-point residuals: the spline LSQ fit smooths over
  noisy triangulated body points, so per-point residuals measure noise not quality.
  Spline-based residuals match visual overlay quality.
- Fraction-based low-confidence (>20% weak points) over any-point-based: with 15 body
  points and 15px inlier threshold, nearly every fish had at least one weak point
  under the old criterion, making the flag meaningless.
- Per-camera residual breakdown chosen as primary diagnostic: directly reveals whether
  errors come from identity mismatch (row-specific) or calibration (column-specific).
</decisions_made>

<blockers>

- Root cause of bad 3D reconstruction not yet confirmed. Leading hypothesis is
  cross-view identity mismatch in the tracker (FishTracker), since only 6/12 cameras
  detect fish and detection counts vary wildly (3-9 per frame). Overnight run data
  should confirm or rule this out.
</blockers>

<context>
The key insight from this session: the 3D splines reproject correctly onto fish in
individual camera views (overlay looks good), yet the 3D geometry is wrong (0.77m arc
length, noise in 3D animation). This is consistent with the spline being derived from
only 2-3 cameras with small baseline, producing a degenerate 3D shape that happens to
project well into those cameras. Cross-view identity errors would cause triangulation
to use pixels from different physical fish in different cameras, producing rays that
barely converge and 3D points far from the tank.

The `per_camera_spline_overlay.py` script was validated as useful - user confirmed
it shows tight alignment between 2D dots and 3D circles for 8/9 fish.

The overnight run will produce detailed data in:
- `output/e2e_diagnostic/diagnostics/report.md` (enhanced with new sections)
- `output/e2e_diagnostic/diagnostics/per_frame_metrics.csv` (time-series data)
</context>

<next_action>
Start with: Read `output/e2e_diagnostic/diagnostics/report.md` from the overnight
run. Focus on the "Per-Camera Residual Breakdown" matrix and "Temporal Stability"
table. If specific fish+camera cells have >50px residuals while others are <15px,
the issue is cross-view identity in the tracker. If entire camera columns are high,
investigate calibration for those cameras.
</next_action>
