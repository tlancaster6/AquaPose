---
phase: 04.1-isolate-phase-4-specific-code-post-archive
plan: 01
subsystem: infra
tags: [cleanup, optimization, pytorch3d, git-branch, archive]

# Dependency graph
requires:
  - phase: 04-per-fish-reconstruction
    provides: "Phase 4 ABS implementation (renderer, optimizer, loss, validation) that needed archiving"
provides:
  - "archive/phase4-abs git branch preserving full ABS codebase for future reference"
  - "Clean dev branch with zero optimization module code"
  - "Shared infrastructure (calibration, segmentation, mesh, initialization) unmodified and green"
affects:
  - 05-cross-view-identity-and-3d-tracking
  - 06-2d-medial-axis-and-arc-length-sampling

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Archive pattern: create dedicated git branch before stripping obsolete code"

key-files:
  created: []
  modified:
    - pyproject.toml
    - CLAUDE.md
  deleted:
    - src/aquapose/optimization/__init__.py
    - src/aquapose/optimization/renderer.py
    - src/aquapose/optimization/optimizer.py
    - src/aquapose/optimization/loss.py
    - src/aquapose/optimization/validation.py
    - tests/unit/optimization/__init__.py
    - tests/unit/optimization/test_renderer.py
    - tests/unit/optimization/test_optimizer.py
    - tests/unit/optimization/test_loss.py
    - tests/unit/optimization/test_validation.py
    - scripts/run_reconstruction.py
    - scripts/diagnose_real_frame.py
    - scripts/diagnose_synthetic.py

key-decisions:
  - "archive/phase4-abs branch created from current HEAD before stripping — preserves all ABS code (renderer, optimizer, loss, validation)"
  - "diagnose_real_frame.py and diagnose_synthetic.py deleted (untracked scripts importing from aquapose.optimization)"
  - "visualize_val_predictions.py retained — only imports from aquapose.segmentation, no optimization dependency"
  - "pytorch3d.structures retained in mesh/builder.py (shared infrastructure, not ABS-specific)"
  - "Pre-existing basedpyright errors in segmentation/detector.py are out of scope (pre-existed before this phase)"
  - "CLAUDE.md updated to reflect triangulation pivot and remove optimization/ from architecture diagram"

patterns-established:
  - "Strip pattern: git rm tracked files, rm untracked files, verify grep shows zero references before committing"

requirements-completed: [RECON-ABS-01, RECON-ABS-02, RECON-ABS-03, RECON-ABS-04, RECON-ABS-05]

# Metrics
duration: 2min
completed: 2026-02-21
---

# Phase 04.1 Plan 01: Isolate Phase 4 Specific Code Post-Archive Summary

**Archived full ABS codebase to archive/phase4-abs branch and stripped all optimization code (renderer, optimizer, loss, validation + tests + scripts) from dev — 233 tests pass, zero optimization references remain.**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-21T~15:07Z
- **Completed:** 2026-02-21T~15:09Z
- **Tasks:** 2
- **Files modified/deleted:** 15

## Accomplishments

- Created `archive/phase4-abs` git branch preserving full Phase 4 ABS implementation for future reference
- Deleted all 5 optimization source files (`renderer.py`, `optimizer.py`, `loss.py`, `validation.py`, `__init__.py`) and their 5 test counterparts
- Deleted `scripts/run_reconstruction.py` and 2 diagnostic scripts that imported from `aquapose.optimization`
- Verified zero remaining references to `aquapose.optimization` anywhere in `src/`, `tests/`, `scripts/`
- Updated `pyproject.toml` description and `CLAUDE.md` to reflect the direct triangulation pivot
- All 233 remaining tests pass (calibration, mesh, segmentation, initialization)

## Task Commits

Each task was committed atomically:

1. **Task 1: Archive branch creation and Phase 4 ABS code deletion** - `81b52af` (chore)
2. **Task 2: pyproject.toml description update** - `c606ab7` (chore)
3. **Deviation: CLAUDE.md architecture update** - `e352ad5` (chore)

## Files Created/Modified

- `pyproject.toml` - Updated description from "differentiable refractive rendering" to "refractive multi-view triangulation"
- `CLAUDE.md` - Updated project description, removed optimization/ from architecture diagram, added initialization/, updated domain conventions

## Files Deleted

- `src/aquapose/optimization/` — entire directory (renderer.py, optimizer.py, loss.py, validation.py, __init__.py)
- `tests/unit/optimization/` — entire directory (test_renderer.py, test_optimizer.py, test_loss.py, test_validation.py, __init__.py)
- `scripts/run_reconstruction.py` — ABS end-to-end CLI
- `scripts/diagnose_real_frame.py` — imported from aquapose.optimization
- `scripts/diagnose_synthetic.py` — imported from aquapose.optimization

## Decisions Made

- `visualize_val_predictions.py` retained: only imports from `aquapose.segmentation` (no optimization dependency)
- Pre-existing `basedpyright` errors in `segmentation/detector.py` are out of scope — they existed before this phase and are unrelated to deleted modules
- CLAUDE.md updated as a deviation (Rule 1 auto-fix: architecture diagram was stale/incorrect after optimization module deletion)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated CLAUDE.md architecture diagram and description**
- **Found during:** Task 2 (verification step)
- **Issue:** CLAUDE.md still listed `optimization/` in architecture diagram and described project as "analysis-by-synthesis" — factually incorrect after deletion
- **Fix:** Updated CLAUDE.md description to "refractive multi-view triangulation", removed optimization/ from architecture, added initialization/, updated domain conventions
- **Files modified:** CLAUDE.md
- **Verification:** CLAUDE.md no longer references optimization/ or analysis-by-synthesis
- **Committed in:** e352ad5 (separate chore commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - stale documentation)
**Impact on plan:** CLAUDE.md update is necessary for correctness — no scope creep.

## Issues Encountered

- `scripts/run_reconstruction.py` had local modifications vs HEAD — required `git rm -f` (force) to remove
- `diagnose_real_frame.py` and `diagnose_synthetic.py` were untracked files — required `rm` rather than `git rm`

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Dev branch is clean: zero Phase 4-specific code, all shared infrastructure intact
- 233 tests pass, ruff clean
- Archive branch `archive/phase4-abs` available for future ABS reference
- Ready for Phase 5 planning: Cross-View Identity and 3D Tracking

---
*Phase: 04.1-isolate-phase-4-specific-code-post-archive*
*Completed: 2026-02-21*
