# Phase 02.1: Segmentation Troubleshooting - Context

**Gathered:** 2026-02-20
**Status:** Ready for planning

<domain>
## Phase Boundary

Systematically test each Phase 2 segmentation component on real data, diagnose failures, and fix until quality is sufficient to unblock Phase 4 (single-fish reconstruction). Components: MOG2 detection, SAM2 pseudo-labeling, Mask R-CNN training/inference. Each component gets a test task and a fix task — if the test passes, the fix task is a no-op.

</domain>

<decisions>
## Implementation Decisions

### Systematic test-then-fix structure
- Each component (MOG2, SAM2, Mask R-CNN) gets two tasks: test and fix
- If the test task passes thresholds, the fix task is checked off as complete
- Sequential dependency: MOG2 → SAM2 → Mask R-CNN (Mask R-CNN training data comes from SAM pseudo-labels + Label Studio corrections)

### MOG2 testing (already in progress)
- Full video from all 13 cameras is available for testing
- Two existing scripts need cleanup: `scripts/diagnose_mog2.py` and `scripts/verify_mog2_recall.py` — combine and improve into a single diagnostic script
- Shadow misclassification already diagnosed: fish were being classified as shadows by MOG2
- 2-stage fix already implemented in `detector.py`: (1) merge shadow + foreground masks, (2) split merged blobs using foreground-only pixels (255) as seeds for watershed/distance-transform separation
- The MOG2 test task should summarize this prior diagnostic and fix work alongside new test results

### SAM2 testing
- User will manually annotate a small handful of images as ground truth for SAM2 evaluation
- Test evaluates SAM2 pseudo-label quality against these manual annotations

### Mask R-CNN testing
- Training data comes from SAM pseudo-labels corrected in Label Studio — depends on SAM pipeline working first
- Test evaluates trained model on held-out frames

### Test output format
- All test scripts produce both visual output (annotated images showing detections/masks) AND numeric metrics
- Visual output allows human inspection of what's happening

### Pass/fail thresholds
- Relaxed thresholds for now (lower bar than Phase 2 targets) to unblock Phase 4
- Phase 2 targets (95% MOG2 recall, 0.90 mean IoU) are aspirational — will tighten later
- Exact relaxed values: Claude's discretion based on what's achievable

### Claude's Discretion
- Specific relaxed threshold values per component
- Test script architecture (how to combine the two MOG2 scripts)
- Metric computation details
- Visual output format (overlay style, side-by-side, etc.)

</decisions>

<specifics>
## Specific Ideas

- Combine `scripts/diagnose_mog2.py` and `scripts/verify_mog2_recall.py` into a single improved diagnostic script rather than starting from scratch
- MOG2 2-stage shadow fix (merge → watershed split) is the key architectural change already made to `detector.py`
- The executing agent for MOG2 test must include the prior shadow diagnosis and fix work in its summary

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 02.1-segmentation-troubleshooting*
*Context gathered: 2026-02-20*
