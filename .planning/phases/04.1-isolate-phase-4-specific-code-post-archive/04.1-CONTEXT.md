# Phase 04.1: Isolate Phase 4-Specific Code Post-Archive - Context

**Gathered:** 2026-02-21
**Status:** Ready for planning

<domain>
## Phase Boundary

Archive the current repo state to a dedicated branch, then systematically strip all analysis-by-synthesis code, scripts, tests, and Phase 4-only dependencies from the working branch. Shared infrastructure (mesh model, refractive projection) is retained.

</domain>

<decisions>
## Implementation Decisions

### Archive strategy
- Create branch `archive/phase4-abs` from current HEAD before any deletions
- This preserves the full analysis-by-synthesis implementation for potential future reference

### Code to strip
- `renderer.py` — differentiable silhouette renderer (RefractiveCamera, RefractiveSilhouetteRenderer)
- `optimizer.py` — FishOptimizer (2-start, warm-start, Adam with per-param LR)
- `loss.py` — soft_iou_loss, compute_angular_diversity_weights, multi_objective_loss
- `validation.py` — evaluate_holdout_iou, run_holdout_validation, render_overlay
- `scripts/run_reconstruction.py` — end-to-end reconstruction CLI

### Code to keep
- Mesh module (FishState, spine, cross-sections, mesh builder) — Phase 3 deliverable, shared
- Calibration/refractive projection layer — Phase 1 deliverable, foundational for all future phases
- Segmentation pipeline — Phase 2 deliverable, needed by Phase 5+

### Tests
- Delete all Phase 4-specific tests (renderer, optimizer, loss, validation, MockRenderer)
- Keep all tests for shared infrastructure (mesh, calibration, segmentation)

### Dependencies
- Clean pyproject.toml of any packages only needed by stripped code (e.g., pytorch3d if no longer needed by retained code)
- Verify remaining code still builds and tests pass after dependency removal

### Claude's Discretion
- Exact file identification (which files/modules are Phase 4-specific vs shared)
- Order of operations for safe removal
- Whether any utility functions inside stripped files have reuse value worth extracting first

</decisions>

<specifics>
## Specific Ideas

- User wants a clean break: archive branch preserves everything, working branch has no Phase 4 remnants
- This is a prerequisite cleanup before Phase 5 (cross-view identity and 3D tracking) begins

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 04.1-isolate-phase-4-specific-code-post-archive*
*Context gathered: 2026-02-21*
