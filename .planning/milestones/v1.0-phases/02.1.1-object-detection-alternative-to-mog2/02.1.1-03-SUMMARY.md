---
phase: 02.1.1-object-detection-alternative-to-mog2
plan: "03"
subsystem: segmentation
tags: [yolo, sam2, pseudo-labels, label-studio, mog2, pipeline-integration]

# Dependency graph
requires:
  - phase: 02.1.1-01
    provides: pseudo-label dataset preparation and YOLO training frames
  - phase: 02.1.1-02
    provides: YOLODetector class, make_detector factory, trained YOLO weights

provides:
  - End-to-end pseudo-label script (scripts/run_pseudo_labels.py) with --detector mog2|yolo
  - Detector-agnostic SAMPseudoLabeler docstrings
  - Integration tests proving YOLO -> SAM2 -> Label Studio export chain

affects:
  - phase 02.1 (SAM2 pseudo-labeling now uses YOLO as default detector)
  - annotation workflow (run_pseudo_labels.py is the primary annotation generation entry point)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - make_detector factory used for runtime detector selection in scripts
    - Integration tests mock both ultralytics and SAM2 to avoid GPU dependencies

key-files:
  created:
    - scripts/run_pseudo_labels.py
    - tests/integration/segmentation/__init__.py
    - tests/integration/segmentation/test_yolo_sam_integration.py
  modified:
    - src/aquapose/segmentation/pseudo_labeler.py

key-decisions:
  - "run_pseudo_labels.py validates YOLO weights path at startup (before loading any models) to fail fast with a clear error message"
  - "MOG2 warmup uses sequential cap.read() from start of video; YOLO skips warmup entirely — script handles both paths via detector type check"
  - "Integration tests mock SAMPseudoLabeler.predict() via monkeypatch rather than importing SAM2 — keeps tests GPU-free and fast"

patterns-established:
  - "Detector selection pattern: make_detector(args.detector, **kwargs) with conditional kwargs based on detector type"
  - "SAMPseudoLabeler.predict() is detector-agnostic: accepts list[Detection] from any source"

requirements-completed:
  - SEG-01
  - SEG-04

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 02.1.1 Plan 03: Pipeline Integration Summary

**End-to-end pseudo-label generation script wiring YOLODetector into SAM2 via make_detector(), with CLI --detector flag for runtime YOLO/MOG2 selection and mock-based integration tests covering the full pipeline**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-20T19:43:47Z
- **Completed:** 2026-02-20T19:47:53Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Created `scripts/run_pseudo_labels.py`: full pipeline from video frames to Label Studio JSON with `--detector mog2|yolo` flag
- Updated `SAMPseudoLabeler` docstrings throughout to be detector-agnostic, referencing both MOG2 and YOLO
- Created 3 integration tests proving YOLO Detection objects flow correctly through SAMPseudoLabeler to Label Studio export, all using mocks (no GPU or weights required)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update pseudo_labeler docstrings and create end-to-end pseudo-label script** - `55a5310` (feat)
2. **Task 2: Add integration test for YOLO -> SAM2 pipeline path** - `74c41ce` (test)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified
- `scripts/run_pseudo_labels.py` - End-to-end CLI script: video dir -> detector -> SAM2 -> Label Studio export
- `src/aquapose/segmentation/pseudo_labeler.py` - Docstrings updated to reference both MOG2Detector and YOLODetector
- `tests/integration/segmentation/__init__.py` - Package init for integration test directory
- `tests/integration/segmentation/test_yolo_sam_integration.py` - 3 integration tests for YOLO -> SAM2 pipeline

## Decisions Made
- Validated YOLO weights path at startup (before loading any models) for fast early failure with a clear error message
- MOG2 warmup reads frames sequentially from video start; YOLO detector has no warmup step — branched on `args.detector` type
- Integration tests mock `SAMPseudoLabeler.predict()` via `monkeypatch` to keep tests GPU-free; real SAM2 behavior tested via existing unit tests

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Ruff I001 (import sort order) on the integration test file required one auto-fix pass. No functional impact.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 02.1.1 is now fully complete: YOLO is trained (Plan 01), integrated as a detector (Plan 02), and wired into the full pseudo-label pipeline (Plan 03)
- `scripts/run_pseudo_labels.py --video-dir <path> --detector yolo --yolo-weights <weights>` is the primary annotation workflow entry point
- Next: proceed with Phase 02.1 remaining plans (SAM2 pseudo-labeling on real data using the new YOLO detector)

---
*Phase: 02.1.1-object-detection-alternative-to-mog2*
*Completed: 2026-02-20*

## Self-Check: PASSED

- FOUND: scripts/run_pseudo_labels.py
- FOUND: src/aquapose/segmentation/pseudo_labeler.py
- FOUND: tests/integration/segmentation/test_yolo_sam_integration.py
- FOUND commit 55a5310: feat(02.1.1-03): add end-to-end pseudo-label script and update docstrings
- FOUND commit 74c41ce: test(02.1.1-03): add integration tests for YOLO -> SAM2 -> Label Studio pipeline
