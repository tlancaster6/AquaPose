# Plan 17-03: 2D Reprojection Overlay Visualization Observer

---
wave: 2
depends_on:
  - 17-02
files_modified:
  - src/aquapose/engine/overlay_observer.py
  - tests/unit/engine/test_overlay_observer.py
  - src/aquapose/engine/__init__.py
requirements:
  - OBS-03
autonomous: true
---

## Goal

Implement an Overlay2DObserver that generates MP4 video(s) showing reprojected 3D midlines overlaid on camera frames alongside original 2D midlines, enabling visual assessment of reconstruction quality.

## Context

- **CONTEXT.md decisions**:
  - Output format: MP4 video (not image sequences)
  - Default overlay: reprojected 3D midline + original 2D midline (two colors for comparison)
  - Bounding box + fish ID overlay available via config flag, not shown by default
  - Camera layout: mosaic grid (all cameras tiled) is default; per-camera individual videos via config
  - Video encoding via OpenCV VideoWriter
- **Dependencies on 17-02**: Uses the `context` field on PipelineComplete event (added in 17-02)
- **PipelineContext fields needed**:
  - `midlines_3d`: list[dict[int, Spline3D]] — 3D splines per frame per fish
  - `annotated_detections`: list[dict[str, list]] — 2D midlines per frame per camera
  - `tracks`: list[list[FishTrack]] — fish_id to camera mapping
  - `camera_ids`: list[str] — active camera IDs
- **Calibration**: needed for 3D->2D reprojection. The observer needs the calibration path from config (captured from PipelineStart event)
- **Video frames**: observer needs to read original video frames. Uses `src/aquapose/io/video.py` or direct OpenCV VideoCapture

## Must-Haves (Goal-Backward)

1. Overlay2DObserver satisfies Observer protocol
2. On PipelineComplete, generates MP4 mosaic video with reprojected 3D midlines + original 2D midlines in two colors
3. Per-camera video mode available via constructor flag
4. Bounding box + fish ID overlay available via constructor flag (off by default)
5. Uses OpenCV VideoWriter for encoding
6. Unit tests verify observer protocol compliance and core overlay logic (frame rendering, not full video write)

## Tasks

<task id="17-03-T1">
<title>Implement Overlay2DObserver class</title>
<description>
Create `src/aquapose/engine/overlay_observer.py`.

Class `Overlay2DObserver`:
- Constructor:
  ```python
  def __init__(
      self,
      output_dir: str | Path,
      video_dir: str | Path,
      calibration_path: str | Path,
      *,
      mosaic: bool = True,
      per_camera: bool = False,
      show_bbox: bool = False,
      show_fish_id: bool = False,
      fps: float = 30.0,
      reprojected_color: tuple[int, int, int] = (0, 255, 0),   # green
      midline_2d_color: tuple[int, int, int] = (255, 0, 0),    # blue (BGR)
  ):
  ```
- `on_event(self, event: Event) -> None`:
  - On `PipelineStart`: capture config for any needed parameters
  - On `PipelineComplete`: trigger video generation
    - Extract context from event
    - Load calibration model for 3D->2D reprojection
    - Open video files for each camera
    - For each frame:
      - Read camera frames
      - For each fish with a 3D midline: reproject spline sample points to each camera, draw as polyline in `reprojected_color`
      - For each camera's 2D detections with midlines: draw original 2D midline as polyline in `midline_2d_color`
      - If `show_bbox`: draw bounding boxes around detections
      - If `show_fish_id`: put fish ID text near detection centroid
    - If `mosaic`: tile all camera frames into a grid and write single video `overlay_mosaic.mp4`
    - If `per_camera`: write individual `overlay_{cam_id}.mp4` per camera
- Helper methods:
  - `_reproject_3d_midline(spline3d, cam_id, model) -> np.ndarray`: evaluate spline at N points, project each to 2D via calibration model, return (N, 2) pixel coords
  - `_draw_midline(frame, points_2d, color, thickness=2)`: draw polyline on frame
  - `_build_mosaic(frames: dict[str, np.ndarray], camera_ids: list[str]) -> np.ndarray`: tile frames into grid. Compute grid dims from camera count (e.g., 4x3 for 12 cameras). Resize each frame to fit grid cell. Return single image.
  - `_draw_bbox(frame, bbox, color, fish_id=None)`: draw rectangle and optional text

For reprojection, use the calibration model's `project()` method. Import from `aquapose.calibration` (this is engine/ importing computation modules, which is allowed by ENG-07).

For spline evaluation, the Spline3D object should have a method or the observer evaluates the B-spline from control_points using scipy. Use `scipy.interpolate.BSpline` with the stored knot vector and control points, evaluate at `np.linspace(0, 1, 50)` for smooth curves.

Add `Overlay2DObserver` to `src/aquapose/engine/__init__.py` exports and `__all__`.
</description>
</task>

<task id="17-03-T2">
<title>Unit tests for Overlay2DObserver</title>
<description>
Create `tests/unit/engine/test_overlay_observer.py`.

Tests:
1. `test_overlay_observer_satisfies_protocol` — `isinstance(Overlay2DObserver(...), Observer)` is True (pass dummy paths)
2. `test_build_mosaic` — create 4 dummy frames (100x100x3 numpy arrays, different colors), call `_build_mosaic`, assert output shape is (200, 200, 3) for a 2x2 grid
3. `test_draw_midline` — create blank frame, call `_draw_midline` with known points, assert frame is modified (non-zero pixels along the line)
4. `test_reproject_returns_correct_shape` — mock calibration model's project method, create a mock Spline3D with control_points, call `_reproject_3d_midline`, assert output shape is (N, 2)

Mark full video generation tests as `@pytest.mark.slow` since they require real video files and calibration:
5. `test_mosaic_video_generation` (slow) — if video files and calibration exist, run observer with a minimal synthetic context, assert MP4 file is created

Use numpy arrays and simple mocks for non-slow tests. Do NOT require real video files or calibration for fast tests.
</description>
</task>

## Verification

```bash
hatch run test tests/unit/engine/test_overlay_observer.py -v -k "not slow"
hatch run check
```

- [ ] All non-slow tests pass
- [ ] Observer satisfies protocol
- [ ] Mosaic grid assembly produces correctly-sized output
- [ ] Midline drawing modifies frame pixels
- [ ] No stage code was modified
