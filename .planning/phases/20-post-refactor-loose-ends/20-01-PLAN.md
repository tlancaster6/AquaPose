---
phase: 20-post-refactor-loose-ends
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquapose/core/context.py
  - src/aquapose/core/__init__.py
  - src/aquapose/engine/stages.py
  - src/aquapose/engine/__init__.py
  - src/aquapose/engine/pipeline.py
  - src/aquapose/core/detection/stage.py
  - src/aquapose/core/midline/stage.py
  - src/aquapose/core/association/stage.py
  - src/aquapose/core/tracking/stage.py
  - src/aquapose/core/reconstruction/stage.py
  - src/aquapose/core/synthetic.py
  - tests/unit/engine/test_stages.py
  - tests/unit/engine/test_pipeline.py
  - tests/unit/engine/test_diagnostic_observer.py
  - tests/unit/core/tracking/test_tracking_stage.py
  - tests/unit/core/test_synthetic.py
  - tests/unit/core/reconstruction/test_reconstruction_stage.py
  - tests/unit/core/midline/test_midline_stage.py
  - tests/unit/core/association/test_association_stage.py
  - tests/unit/core/detection/test_detection_stage.py
  - tools/import_boundary_checker.py
autonomous: true
requirements: [REMEDIATE]

must_haves:
  truths:
    - "PipelineContext and Stage Protocol are defined in core/context.py, not engine/"
    - "No file in core/ imports from engine/ under TYPE_CHECKING or otherwise"
    - "engine/stages.py does not exist"
    - "Import boundary checker passes with zero violations"
    - "All existing unit tests pass after the move"
  artifacts:
    - path: "src/aquapose/core/context.py"
      provides: "PipelineContext dataclass and Stage Protocol"
      contains: "class PipelineContext"
    - path: "src/aquapose/engine/__init__.py"
      provides: "Re-export of PipelineContext from core.context"
  key_links:
    - from: "src/aquapose/core/detection/stage.py"
      to: "src/aquapose/core/context.py"
      via: "direct import (no TYPE_CHECKING)"
      pattern: "from aquapose.core.context import PipelineContext"
    - from: "src/aquapose/engine/__init__.py"
      to: "src/aquapose/core/context.py"
      via: "re-export for backward compat"
      pattern: "from aquapose.core.context import"
---

<objective>
Fix the Critical IB-003 violations by moving PipelineContext and Stage Protocol from engine/stages.py to core/context.py.

Purpose: PipelineContext and Stage are pure data containers with no engine logic. Moving them to core/ eliminates all 7 TYPE_CHECKING backdoors where core/ stage files imported from engine/. This is the single root cause of both DoD Criterion 7 failures.

Output: core/context.py with PipelineContext + Stage; engine/stages.py deleted; all imports updated; import boundary checker passes clean.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-post-refactor-loose-ends/20-CONTEXT.md
@.planning/phases/19-alpha-refactor-audit/19-AUDIT.md

<interfaces>
<!-- Current engine/stages.py content to move -->
From src/aquapose/engine/stages.py:
```python
@runtime_checkable
class Stage(Protocol):
    def run(self, context: PipelineContext) -> PipelineContext: ...

@dataclass
class PipelineContext:
    frame_count: int | None = None
    camera_ids: list[str] | None = None
    detections: list[dict[str, list]] | None = None
    annotated_detections: list[dict[str, list]] | None = None
    associated_bundles: list[list] | None = None
    tracks: list[list] | None = None
    midlines_3d: list[dict] | None = None
    stage_timing: dict[str, float] = field(default_factory=dict)
    def get(self, field_name: str) -> object: ...
```

From src/aquapose/engine/__init__.py (line 39):
```python
from aquapose.engine.stages import PipelineContext, Stage
```

7 TYPE_CHECKING violations to fix (all import `from aquapose.engine.stages import PipelineContext`):
- core/detection/stage.py:22
- core/midline/stage.py:21
- core/association/stage.py:21
- core/tracking/stage.py:29
- core/reconstruction/stage.py:24
- core/synthetic.py:25 (also imports SyntheticConfig from engine.config:24)

Test files importing `from aquapose.engine.stages import PipelineContext, Stage`:
- tests/unit/engine/test_stages.py:10
- tests/unit/engine/test_pipeline.py:19
- tests/unit/engine/test_diagnostic_observer.py:8
- tests/unit/core/tracking/test_tracking_stage.py:25
- tests/unit/core/test_synthetic.py:12
- tests/unit/core/reconstruction/test_reconstruction_stage.py:30
- tests/unit/core/midline/test_midline_stage.py:23
- tests/unit/core/association/test_association_stage.py:24
- tests/unit/core/detection/test_detection_stage.py:22
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core/context.py and update all source imports</name>
  <files>
    src/aquapose/core/context.py
    src/aquapose/core/__init__.py
    src/aquapose/engine/__init__.py
    src/aquapose/engine/pipeline.py
    src/aquapose/core/detection/stage.py
    src/aquapose/core/midline/stage.py
    src/aquapose/core/association/stage.py
    src/aquapose/core/tracking/stage.py
    src/aquapose/core/reconstruction/stage.py
    src/aquapose/core/synthetic.py
  </files>
  <action>
    1. Create `src/aquapose/core/context.py` — copy the entire content of `engine/stages.py` (Stage Protocol + PipelineContext dataclass + imports). Update module docstring to reflect new location: "Stage Protocol and PipelineContext — core data contracts for the pipeline."

    2. Add `PipelineContext` and `Stage` to `src/aquapose/core/__init__.py` exports:
       - Add `from aquapose.core.context import PipelineContext, Stage`
       - Add both to `__all__`

    3. Delete `src/aquapose/engine/stages.py` entirely. No re-export shim, no backward compat.

    4. Update `src/aquapose/engine/__init__.py`:
       - Change `from aquapose.engine.stages import PipelineContext, Stage` to `from aquapose.core.context import PipelineContext, Stage`
       - Keep both names in `__all__` so external consumers (CLI, tests) still find them via `aquapose.engine`

    5. Update `src/aquapose/engine/pipeline.py`:
       - Change `from aquapose.engine.stages import PipelineContext, Stage` to `from aquapose.core.context import PipelineContext, Stage`

    6. For ALL 5 core stage files (detection, midline, association, tracking, reconstruction):
       - Remove the `TYPE_CHECKING` import block entirely (the `if TYPE_CHECKING:` + `from aquapose.engine.stages import PipelineContext`)
       - Add a direct import: `from aquapose.core.context import PipelineContext`
       - Remove `from typing import TYPE_CHECKING` if no other TYPE_CHECKING usage remains
       - Update module docstrings to remove "referenced only under TYPE_CHECKING" language

    7. For `src/aquapose/core/synthetic.py`:
       - Remove `from aquapose.engine.stages import PipelineContext` from TYPE_CHECKING block
       - Add direct import: `from aquapose.core.context import PipelineContext`
       - Keep `from aquapose.engine.config import SyntheticConfig` under TYPE_CHECKING — SyntheticConfig genuinely belongs in engine/config and synthetic.py's constructor takes it as a parameter passed by the engine layer. This is acceptable: config flows downward from engine to core.

    8. Update `tools/import_boundary_checker.py` to also flag TYPE_CHECKING imports from engine in core. Verify the checker has this capability already; if not, add a check that scans `if TYPE_CHECKING:` blocks for `aquapose.engine` imports.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python tools/import_boundary_checker.py --verbose</automated>
  </verify>
  <done>
    - core/context.py exists with PipelineContext and Stage
    - engine/stages.py is deleted
    - 0 IB-003 violations reported by import boundary checker
    - No core/ file imports from engine/ at runtime or under TYPE_CHECKING (except synthetic.py importing SyntheticConfig, which is config flowing downward — acceptable)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all test imports and verify test suite passes</name>
  <files>
    tests/unit/engine/test_stages.py
    tests/unit/engine/test_pipeline.py
    tests/unit/engine/test_diagnostic_observer.py
    tests/unit/core/tracking/test_tracking_stage.py
    tests/unit/core/test_synthetic.py
    tests/unit/core/reconstruction/test_reconstruction_stage.py
    tests/unit/core/midline/test_midline_stage.py
    tests/unit/core/association/test_association_stage.py
    tests/unit/core/detection/test_detection_stage.py
  </files>
  <action>
    Update all test files that import from `aquapose.engine.stages`:

    For test files in tests/unit/core/ (stage tests):
    - Change `from aquapose.engine.stages import PipelineContext, Stage` to `from aquapose.core.context import PipelineContext, Stage`
    - These are core module tests — they should import from core, not engine

    For test files in tests/unit/engine/ (engine tests):
    - Change `from aquapose.engine.stages import PipelineContext, Stage` to `from aquapose.core.context import PipelineContext, Stage`
    - Or alternatively import via `from aquapose.engine import PipelineContext, Stage` (the re-export). Prefer direct import from core.context for clarity.

    Run the full unit test suite to confirm nothing breaks.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && hatch run test 2>&1 | tail -20</automated>
  </verify>
  <done>
    - All test files import PipelineContext from core.context (not engine.stages)
    - Full unit test suite passes (519+ tests, 0 failures)
  </done>
</task>

</tasks>

<verification>
1. `python tools/import_boundary_checker.py --verbose` reports 0 violations (especially 0 IB-003)
2. `hatch run test` passes all unit tests
3. `python -c "from aquapose.core.context import PipelineContext, Stage; print('OK')"` succeeds
4. `python -c "from aquapose.engine import PipelineContext, Stage; print('OK')"` succeeds (re-export)
5. `python -c "import aquapose.engine.stages"` fails with ImportError (file deleted)
</verification>

<success_criteria>
- PipelineContext and Stage live in core/context.py
- engine/stages.py is deleted
- Import boundary checker reports 0 IB-003 violations
- All 519+ unit tests pass
- engine/__init__.py re-exports PipelineContext and Stage for external consumers
</success_criteria>

<output>
After completion, create `.planning/phases/20-post-refactor-loose-ends/20-01-SUMMARY.md`
</output>
