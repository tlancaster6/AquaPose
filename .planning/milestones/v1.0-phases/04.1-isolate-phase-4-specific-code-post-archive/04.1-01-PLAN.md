---
phase: 04.1-isolate-phase-4-specific-code-post-archive
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquapose/optimization/renderer.py
  - src/aquapose/optimization/optimizer.py
  - src/aquapose/optimization/loss.py
  - src/aquapose/optimization/validation.py
  - src/aquapose/optimization/__init__.py
  - tests/unit/optimization/test_renderer.py
  - tests/unit/optimization/test_optimizer.py
  - tests/unit/optimization/test_loss.py
  - tests/unit/optimization/test_validation.py
  - tests/unit/optimization/__init__.py
  - scripts/run_reconstruction.py
  - scripts/diagnose_real_frame.py
  - scripts/diagnose_synthetic.py
  - scripts/visualize_val_predictions.py
  - pyproject.toml
autonomous: true
requirements:
  - RECON-ABS-01
  - RECON-ABS-02
  - RECON-ABS-03
  - RECON-ABS-04
  - RECON-ABS-05

must_haves:
  truths:
    - "Branch archive/phase4-abs exists preserving the full analysis-by-synthesis codebase"
    - "No optimization module exists under src/aquapose/ on the working branch"
    - "No Phase 4-specific test files exist under tests/unit/"
    - "scripts/run_reconstruction.py is deleted from the working branch"
    - "hatch run test passes with all remaining tests green"
    - "No Python file in src/ tests/ scripts/ references aquapose.optimization"
  artifacts:
    - path: "archive/phase4-abs (git branch)"
      provides: "Complete Phase 4 ABS code preserved for future reference"
    - path: "src/aquapose/mesh/builder.py"
      provides: "Retained shared mesh infrastructure (uses pytorch3d.structures.Meshes)"
      contains: "pytorch3d.structures"
  key_links:
    - from: "src/aquapose/__init__.py"
      to: "optimization/"
      via: "no import — package must not reference deleted optimization module"
      pattern: "^(?!.*optimization)"
---

<objective>
Archive the analysis-by-synthesis codebase to a dedicated branch, then strip all Phase 4-specific code (renderer, optimizer, loss, validation), tests, and scripts from the working branch.

Purpose: Clean the codebase so only shared infrastructure (calibration, segmentation, mesh) remains, unblocking Phase 5 (cross-view identity and 3D tracking) without dead code.
Output: A clean working branch with no ABS code; an archive/phase4-abs branch preserving everything.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-isolate-phase-4-specific-code-post-archive/04.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create archive branch and delete all Phase 4 ABS source code, tests, and scripts</name>
  <files>
    src/aquapose/optimization/renderer.py
    src/aquapose/optimization/optimizer.py
    src/aquapose/optimization/loss.py
    src/aquapose/optimization/validation.py
    src/aquapose/optimization/__init__.py
    tests/unit/optimization/test_renderer.py
    tests/unit/optimization/test_optimizer.py
    tests/unit/optimization/test_loss.py
    tests/unit/optimization/test_validation.py
    tests/unit/optimization/__init__.py
    scripts/run_reconstruction.py
    scripts/diagnose_real_frame.py
    scripts/diagnose_synthetic.py
    scripts/visualize_val_predictions.py
  </files>
  <action>
    Step 1: Create archive branch from current HEAD.
    ```bash
    git checkout -b archive/phase4-abs
    git checkout dev
    ```
    This preserves the full ABS codebase on the archive branch per user's locked decision.

    Step 2: Delete the entire `src/aquapose/optimization/` directory (all 5 files: renderer.py, optimizer.py, loss.py, validation.py, __init__.py). Delete the directory itself — do NOT leave an empty placeholder. Per RESEARCH.md, there is zero retained value in this package after stripping the 4 modules.

    Step 3: Delete the entire `tests/unit/optimization/` directory (all 5 files: test_renderer.py, test_optimizer.py, test_loss.py, test_validation.py, __init__.py).

    Step 4: Delete `scripts/run_reconstruction.py` (tracked file, imports from aquapose.optimization).

    Step 5: Inspect untracked diagnostic scripts for optimization imports:
    - `scripts/diagnose_real_frame.py`
    - `scripts/diagnose_synthetic.py`
    - `scripts/visualize_val_predictions.py`
    If any import from `aquapose.optimization`, delete them. If they only use shared modules (calibration, mesh, segmentation), leave them alone.

    Step 6: Verify no remaining references to `aquapose.optimization` in `src/`, `tests/`, or `scripts/`:
    ```bash
    grep -r "aquapose.optimization\|from .optimization\|from aquapose.optimization" src/ tests/ scripts/ --include="*.py"
    ```
    This must return zero results.

    Step 7: Verify `src/aquapose/__init__.py` does NOT import from optimization (it currently does not, but confirm after deletion).

    IMPORTANT: Do NOT remove pytorch3d from pyproject.toml or install instructions. `mesh/builder.py` uses `pytorch3d.structures.Meshes` — it is shared infrastructure, not Phase 4-only.
  </action>
  <verify>
    - `git branch --list archive/phase4-abs` returns the branch name
    - `ls src/aquapose/optimization/` returns "No such file or directory"
    - `ls tests/unit/optimization/` returns "No such file or directory"
    - `ls scripts/run_reconstruction.py` returns "No such file or directory"
    - `grep -r "aquapose.optimization" src/ tests/ scripts/ --include="*.py"` returns no results
    - `grep -r "pytorch3d.renderer" src/ --include="*.py"` returns no results (only pytorch3d.structures retained)
  </verify>
  <done>
    Archive branch exists. All Phase 4 ABS-specific source files, test files, and scripts are deleted from the working branch. No dangling imports to the deleted optimization module remain anywhere in the codebase. Shared infrastructure (mesh, calibration, segmentation, initialization) is untouched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pyproject.toml description and verify test suite passes</name>
  <files>
    pyproject.toml
  </files>
  <action>
    Step 1: Update the `description` field in `pyproject.toml` from:
    ```
    "3D fish pose estimation via differentiable refractive rendering"
    ```
    to:
    ```
    "3D fish pose estimation via refractive multi-view triangulation"
    ```
    This reflects the project's pivot from analysis-by-synthesis to direct triangulation. Per RESEARCH.md open question #2, this is a cosmetic but appropriate change while touching the project.

    Step 2: Run the full test suite:
    ```bash
    hatch run test
    ```
    All remaining tests (calibration, mesh, segmentation, initialization) must pass. There should be no ImportErrors, no missing module errors, and no test collection failures.

    Step 3: Run lint and typecheck to ensure no stale references:
    ```bash
    hatch run check
    ```
    If ruff or basedpyright flags any issues related to the deleted modules, fix them (likely none since optimization was self-contained).
  </action>
  <verify>
    - `hatch run test` exits 0 with all tests passing
    - `hatch run check` exits 0 (or only pre-existing warnings unrelated to this phase)
    - `grep "description" pyproject.toml` shows the updated description
  </verify>
  <done>
    pyproject.toml description reflects the direct triangulation direction. Full test suite passes with no errors. Lint and typecheck clean. The codebase is ready for Phase 5 development.
  </done>
</task>

</tasks>

<verification>
1. `git branch --list archive/phase4-abs` — archive branch exists
2. `ls src/aquapose/optimization/ 2>/dev/null` — directory does not exist
3. `ls tests/unit/optimization/ 2>/dev/null` — directory does not exist
4. `grep -r "optimization" src/ tests/ scripts/ --include="*.py"` — no results
5. `grep "pytorch3d.structures" src/aquapose/mesh/builder.py` — confirms shared dep retained
6. `hatch run test` — all tests pass
7. `hatch run check` — lint + typecheck clean
</verification>

<success_criteria>
- Archive branch `archive/phase4-abs` preserves the full ABS implementation
- Zero Phase 4-specific code remains on the `dev` branch
- All shared infrastructure (calibration, segmentation, mesh, initialization) is unmodified and functional
- Test suite passes, lint and typecheck clean
- pyproject.toml description updated to reflect direct triangulation pivot
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-isolate-phase-4-specific-code-post-archive/04.1-01-SUMMARY.md`
</output>
