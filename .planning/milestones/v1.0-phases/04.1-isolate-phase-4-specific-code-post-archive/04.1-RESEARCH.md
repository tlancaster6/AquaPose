# Phase 04.1: Isolate Phase 4-Specific Code Post-Archive - Research

**Researched:** 2026-02-21
**Domain:** Git branching, Python module deletion, dependency cleanup, test suite hygiene
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

**Archive strategy**
- Create branch `archive/phase4-abs` from current HEAD before any deletions
- This preserves the full analysis-by-synthesis implementation for potential future reference

**Code to strip**
- `renderer.py` — differentiable silhouette renderer (RefractiveCamera, RefractiveSilhouetteRenderer)
- `optimizer.py` — FishOptimizer (2-start, warm-start, Adam with per-param LR)
- `loss.py` — soft_iou_loss, compute_angular_diversity_weights, multi_objective_loss
- `validation.py` — evaluate_holdout_iou, run_holdout_validation, render_overlay
- `scripts/run_reconstruction.py` — end-to-end reconstruction CLI

**Code to keep**
- Mesh module (FishState, spine, cross-sections, mesh builder) — Phase 3 deliverable, shared
- Calibration/refractive projection layer — Phase 1 deliverable, foundational for all future phases
- Segmentation pipeline — Phase 2 deliverable, needed by Phase 5+

**Tests**
- Delete all Phase 4-specific tests (renderer, optimizer, loss, validation, MockRenderer)
- Keep all tests for shared infrastructure (mesh, calibration, segmentation)

**Dependencies**
- Clean pyproject.toml of any packages only needed by stripped code (e.g., pytorch3d if no longer needed by retained code)
- Verify remaining code still builds and tests pass after dependency removal

### Claude's Discretion
- Exact file identification (which files/modules are Phase 4-specific vs shared)
- Order of operations for safe removal
- Whether any utility functions inside stripped files have reuse value worth extracting first

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope
</user_constraints>

---

## Summary

Phase 04.1 is a code cleanup / archival operation with no new feature work. The analysis-by-synthesis pipeline has been shelved in favor of direct triangulation. The goal is to create a clean `archive/phase4-abs` branch and then strip all ABS-specific code from the working branch so the codebase only carries forward code that supports Phase 5+ (cross-view identity, tracking, direct triangulation).

The scope is fully known from direct codebase inspection. Every file to be deleted has been read and understood. The primary technical judgment calls are: (1) the pytorch3d situation — `mesh/builder.py` uses `pytorch3d.structures.Meshes`, making pytorch3d shared infrastructure, not Phase 4-only; and (2) the `optimization/` package directory itself should be deleted wholesale after stripping all four modules, but the `tests/unit/optimization/` directory likewise becomes empty and should be removed.

**Primary recommendation:** Execute in the order: archive → delete sources → delete tests → update `__init__.py` files → assess dependencies → verify tests pass. Do not extract any utility functions from the stripped files — none have reuse value not already present elsewhere.

---

## Architecture Patterns

### Recommended Operation Order

The safe removal sequence matters because the `optimization/__init__.py` re-exports everything from the four stripped modules. Deleting modules before updating `__init__.py` will break imports at the package level.

```
1. git checkout -b archive/phase4-abs   (create archive branch, push if desired)
2. git checkout dev                      (return to working branch)
3. Delete source files:
   - src/aquapose/optimization/renderer.py
   - src/aquapose/optimization/optimizer.py
   - src/aquapose/optimization/loss.py
   - src/aquapose/optimization/validation.py
   - scripts/run_reconstruction.py
4. Update src/aquapose/optimization/__init__.py:
   - Empty out all imports; set __all__ = []
   - Update docstring to reflect empty state
   OR: Delete the entire optimization/ package if no residual value
5. Delete test files:
   - tests/unit/optimization/test_renderer.py
   - tests/unit/optimization/test_optimizer.py
   - tests/unit/optimization/test_loss.py
   - tests/unit/optimization/test_validation.py
   - tests/unit/optimization/__init__.py (if package becomes empty)
6. Assess dependency removals in pyproject.toml
7. Run: hatch run test — verify all remaining tests pass
```

### Anti-Patterns to Avoid

- **Deleting modules before updating `__init__.py`:** The optimization `__init__.py` imports from all 4 stripped modules. Deleting the modules first causes an `ImportError` at import time, which breaks every test that imports anything from `aquapose` even indirectly.
- **Deleting the optimization package directory without checking for retained value:** In this case the `optimization/` package has zero retained value after stripping all 4 modules. It can be fully removed. However, verify `tests/unit/optimization/__init__.py` is also removed.
- **Forgetting `scripts/run_reconstruction.py`:** This script is listed for deletion but lives outside `src/` and is easy to overlook. It imports from `aquapose.optimization` at the top level so leaving it would cause import errors at script invocation.

---

## Exact File Inventory

### Files to DELETE (confirmed by direct inspection)

**Source modules:**
- `src/aquapose/optimization/renderer.py` — `RefractiveCamera`, `RefractiveSilhouetteRenderer`; depends on `pytorch3d.renderer` (full renderer stack: `BlendParams`, `FoVOrthographicCameras`, `MeshRasterizer`, `MeshRenderer`, `RasterizationSettings`, `SoftSilhouetteShader`)
- `src/aquapose/optimization/optimizer.py` — `FishOptimizer`, `make_optimizable_state`, `warm_start_from_velocity`, `get_state_params`; imports `torch.nn.utils.clip_grad_norm_` and `aquapose.mesh.builder.build_fish_mesh`
- `src/aquapose/optimization/loss.py` — `soft_iou_loss`, `compute_angular_diversity_weights`, `multi_objective_loss`; imports `numpy`, `torch`, `torch.nn.functional`
- `src/aquapose/optimization/validation.py` — `evaluate_holdout_iou`, `run_holdout_validation`, `render_overlay`, `_get_initial_state`; imports `numpy`, `torch`, `aquapose.mesh.builder`, `.loss`
- `scripts/run_reconstruction.py` — end-to-end CLI; imports `FishOptimizer`, `RefractiveSilhouetteRenderer`, `compute_angular_diversity_weights`, `render_overlay`, `run_holdout_validation` from `aquapose.optimization`

**Test files:**
- `tests/unit/optimization/test_renderer.py` — tests `RefractiveCamera` and `RefractiveSilhouetteRenderer`; requires `pytorch3d` at import time
- `tests/unit/optimization/test_optimizer.py` — tests `FishOptimizer`, `MockRenderer`, `make_optimizable_state`, `warm_start_from_velocity`; `MockRenderer` class is defined in this file (not a shared fixture)
- `tests/unit/optimization/test_loss.py` — tests `soft_iou_loss`, `compute_angular_diversity_weights`, `multi_objective_loss`
- `tests/unit/optimization/test_validation.py` — tests `evaluate_holdout_iou`, `run_holdout_validation`, `render_overlay`

**Package infrastructure to remove:**
- `src/aquapose/optimization/__init__.py` — currently exports all 4 modules; becomes empty or entire dir deleted
- `tests/unit/optimization/__init__.py` — package marker for the test subdirectory

**Diagnosis/debug scripts (untracked, evaluate during cleanup):**
- `scripts/diagnose_real_frame.py` — untracked; inspect whether it imports optimization
- `scripts/diagnose_synthetic.py` — untracked; inspect whether it imports optimization
- `scripts/visualize_val_predictions.py` — untracked; inspect whether it imports optimization

### Files to UPDATE

**`src/aquapose/optimization/__init__.py`:**
Current content exports all four modules. If the entire `optimization/` directory is deleted (recommended), this file goes away too. If retaining the empty package for future Phase 5+ use, replace with:
```python
"""Optimization module — Phase 4 ABS code removed; placeholder for future use."""

__all__: list[str] = []
```

### Files to KEEP (confirmed safe, no ABS dependencies)

**Source:**
- `src/aquapose/calibration/` — all files; pure calibration, no optimization imports
- `src/aquapose/segmentation/` — all files; no optimization imports
- `src/aquapose/mesh/state.py`, `spine.py`, `cross_section.py`, `profiles.py` — pure mesh math
- `src/aquapose/mesh/builder.py` — **KEEP**: uses `pytorch3d.structures.Meshes` (shared, needed by future phases)
- `src/aquapose/mesh/__init__.py` — exports mesh module
- `src/aquapose/initialization/` — all files; triangulation code, Phase 5 precursor
- `src/aquapose/io/__init__.py` — empty placeholder
- `src/aquapose/utils/__init__.py` — empty placeholder
- `src/aquapose/core/__init__.py` — empty placeholder
- `src/aquapose/__init__.py` — top-level package init

**Tests:**
- `tests/unit/calibration/` — all files; safe
- `tests/unit/mesh/` — all files including `test_builder.py` (uses pytorch3d.structures.Meshes via build_fish_mesh)
- `tests/unit/initialization/` — all files; safe
- `tests/unit/segmentation/` — all files; safe
- `tests/unit/test_smoke.py` — safe (inspect to confirm no optimization imports)
- `tests/integration/` — all files; safe
- `tests/e2e/` — safe (currently empty)

---

## Dependency Analysis

### pytorch3d

**Status: SHARED DEPENDENCY — DO NOT REMOVE**

`pytorch3d` is used in two locations:
1. `src/aquapose/optimization/renderer.py` — imports `pytorch3d.renderer` (full ABS rendering stack)
2. `src/aquapose/mesh/builder.py` — imports `pytorch3d.structures.Meshes`

`mesh/builder.py` is retained (Phase 3 deliverable). Therefore `pytorch3d` remains a runtime dependency. The pyproject.toml comment about pytorch3d installation stays unchanged. No dependency entry to modify (pytorch3d is not in `[project.dependencies]` — it's a manual install listed in comments only).

**Confidence: HIGH** — verified by direct file inspection.

### Other dependencies in pyproject.toml

All listed dependencies (`torch`, `torchvision`, `numpy`, `opencv-python`, `scipy`, `h5py`, `aquacal`, `pycocotools`, `ultralytics`) are used by retained modules (calibration, segmentation, initialization, mesh). None are exclusively used by the stripped files.

The stripped files use: `torch`, `numpy`, `torch.nn.functional`, `torch.nn.utils` — all standard torch, all needed elsewhere.

**Result: pyproject.toml requires NO changes to `[project.dependencies]`.**

The description field in `[project]` currently says "3D fish pose estimation via differentiable refractive rendering" — this should be updated to reflect the new direct triangulation direction, but that is cosmetic and can be done here or deferred.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead |
|---------|-------------|-------------|
| Archiving old code | Manual file copying | `git branch archive/phase4-abs HEAD` then delete from working branch |
| Verifying nothing is broken | Manual inspection | `hatch run test` — run the full test suite after deletions |
| Finding hidden imports | Grep by hand | `grep -r "optimization" src/ tests/ scripts/` to catch any missed references |

---

## Common Pitfalls

### Pitfall 1: Forgetting `optimization/__init__.py` Re-Exports
**What goes wrong:** Delete the 4 module files but leave `optimization/__init__.py` with `from .renderer import ...` — results in `ImportError` when any code `import aquapose` even indirectly.
**Why it happens:** `__init__.py` runs on package import; its imports are evaluated immediately.
**How to avoid:** Either delete the entire `optimization/` directory, or update `__init__.py` to empty `__all__` as the first file touched.
**Warning signs:** `ImportError: cannot import name 'RefractiveCamera'` when running any test.

### Pitfall 2: Overlooking the `scripts/` Directory
**What goes wrong:** The four source modules are deleted cleanly, but `scripts/run_reconstruction.py` is left in place. It has `from aquapose.optimization import FishOptimizer, ...` at the top, so running it (or any automated script scanner) fails.
**Why it happens:** `scripts/` is outside `src/` and not part of the installable package, so it doesn't appear in import traces.
**How to avoid:** Delete `scripts/run_reconstruction.py` explicitly as part of the plan.

### Pitfall 3: Untracked Diagnosis Scripts
**What goes wrong:** `scripts/diagnose_real_frame.py`, `scripts/diagnose_synthetic.py`, `scripts/visualize_val_predictions.py` are untracked (in `.gitignore` or just not committed). They may import from `aquapose.optimization`.
**Why it happens:** Untracked files are not visible in git diff.
**How to avoid:** Inspect each untracked script for `optimization` imports before deleting the module. If they import optimization, delete or update them too.
**Warning signs:** `ImportError` when running diagnostic scripts after cleanup.

### Pitfall 4: pytorch3d Dependency Confusion
**What goes wrong:** Planner assumes pytorch3d is Phase 4-only and removes it from the install instructions or marks it deleted.
**Why it happens:** The ABS renderer is the most visible pytorch3d user; `mesh/builder.py`'s use is less prominent.
**How to avoid:** `mesh/builder.py` uses `pytorch3d.structures.Meshes` — this is retained. pytorch3d stays.

### Pitfall 5: Deleting the `optimization/` Directory Leaves Dead Test Package
**What goes wrong:** `src/aquapose/optimization/` is deleted but `tests/unit/optimization/` is left behind (possibly empty or with `__init__.py` only). pytest may warn or error about empty test packages.
**How to avoid:** Delete `tests/unit/optimization/` in full, including `__init__.py`.

---

## Code Examples

### Creating the Archive Branch

```bash
# From dev branch at current HEAD
git checkout -b archive/phase4-abs
git push origin archive/phase4-abs   # optional, preserve remotely

# Return to working branch
git checkout dev
```

### Verifying No Remaining Optimization Imports After Deletion

```bash
# Run after deletions, before committing
grep -r "aquapose.optimization\|from .optimization\|from aquapose.optimization" \
  src/ tests/ scripts/ \
  --include="*.py"
# Should return NO results

grep -r "pytorch3d.renderer" src/ --include="*.py"
# Should return NO results (only pytorch3d.structures is retained via mesh/builder.py)
```

### Smoke-Testing After Cleanup

```bash
hatch run test
# All remaining tests (calibration, mesh, segmentation, initialization) should PASS
# The optimization tests are gone, so there's nothing to fail there
```

---

## Open Questions

1. **Should the `optimization/` package directory be fully removed or kept as an empty placeholder?**
   - What we know: All 4 modules inside it are Phase 4-specific and being deleted. The package currently has no retained value.
   - What's unclear: Phase 5/6+ might need an `optimization/` package for e.g. LM refinement (RECON-05, optional). However, that requirement is marked optional and distant.
   - Recommendation: Delete the directory entirely now. It's trivial to re-create an empty package later if needed. Keeping empty packages adds noise.

2. **Should `pyproject.toml` description be updated?**
   - Current: "3D fish pose estimation via differentiable refractive rendering"
   - What's unclear: Whether to update now (while touching pyproject.toml) or in a later phase.
   - Recommendation: Update now since we're already modifying the project metadata context. Change to "3D fish pose estimation via refractive multi-view triangulation" to match the new direction. Low-risk cosmetic change.

3. **Do untracked diagnostic scripts import from `aquapose.optimization`?**
   - `scripts/diagnose_real_frame.py`, `scripts/diagnose_synthetic.py`, `scripts/visualize_val_predictions.py` are untracked.
   - Recommendation: Plan should include a task to inspect and handle these scripts before or immediately after deleting optimization modules.

---

## Sources

### Primary (HIGH confidence)
- Direct file inspection: `src/aquapose/optimization/renderer.py`, `optimizer.py`, `loss.py`, `validation.py` — full file reads, all imports catalogued
- Direct file inspection: `src/aquapose/mesh/builder.py` — confirmed `pytorch3d.structures.Meshes` usage, retained
- Direct file inspection: `scripts/run_reconstruction.py` — confirmed `aquapose.optimization` imports
- Direct file inspection: `pyproject.toml` — confirmed pytorch3d is not in `[project.dependencies]` (manual install only)
- Direct file inspection: `tests/unit/optimization/` — all four test files read, MockRenderer is local to `test_optimizer.py`

### Secondary (MEDIUM confidence)
- Git log inspection: confirmed current branch is `dev`, HEAD at `a1355e9`
- Filesystem enumeration: all `src/`, `tests/`, `scripts/` Python files catalogued

---

## Metadata

**Confidence breakdown:**
- File inventory: HIGH — all files read directly, no guessing
- Dependency analysis: HIGH — verified by grep across all source files
- pytorch3d retention decision: HIGH — `mesh/builder.py` confirmed to use `pytorch3d.structures.Meshes`
- Operation order: HIGH — standard git + Python package removal, no exotic patterns
- Pitfalls: HIGH — derived from actual code structure, not speculation

**Research date:** 2026-02-21
**Valid until:** Stable indefinitely — this is a one-time cleanup operation against a known, fixed codebase snapshot.
