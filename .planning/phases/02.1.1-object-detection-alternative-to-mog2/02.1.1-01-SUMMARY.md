---
phase: 02.1.1-object-detection-alternative-to-mog2
plan: 01
subsystem: segmentation
tags: [yolo, mog2, frame-sampling, label-studio, annotation, dataset]

# Dependency graph
requires:
  - phase: 02.1-segmentation-troubleshooting
    provides: MOG2Detector with watershed-split and shadow-merge logic
provides:
  - scripts/sample_yolo_frames.py for MOG2-guided diverse frame export
  - scripts/organize_yolo_dataset.py for Label Studio export -> YOLO structure organization
  - data/yolo_fish/ — 150 annotated frames, 120 train / 30 val, stratified by camera
  - data/yolo_fish/dataset.yaml for ultralytics model.train()
affects:
  - 02.1.1-02 (YOLO training — consumes data/yolo_fish/ dataset)

# Tech tracking
tech-stack:
  added: [label-studio (manual annotation), ultralytics YOLO dataset format]
  patterns:
    - "MOG2-guided diversity sampling: bin by detection count (0,1,2,3+), allocate at least 1 per non-empty bin, fill remainder proportionally"
    - "Stratified camera split: 80/20 per camera ensures all 13 cameras in both train and val"

key-files:
  created:
    - scripts/sample_yolo_frames.py
    - scripts/organize_yolo_dataset.py
    - data/yolo_fish/dataset.yaml
  modified: []

key-decisions:
  - "sample_yolo_frames.py uses MOG2Detector.detect() (not apply()) on strided frames to classify diversity; detector.apply() is called on skipped frames to keep background model current"
  - "Ring cameras: 10 frames each (12 cameras = 120); center camera: 30 frames; total 150 frames"
  - "Stratified bin sampling: quota >= 1 per non-empty bin, surplus distributed proportional to bin size"

patterns-established:
  - "Frame diversity via MOG2 count bins (0, 1, 2, 3+): ensures hard cases (stationary/absent fish) are included in annotation set"

requirements-completed:
  - SEG-01

# Metrics
duration: ~2 sessions (5min automated + human annotation checkpoint)
completed: 2026-02-20
---

# Phase 02.1.1 Plan 01: YOLO Dataset Preparation - Summary

**MOG2-guided diversity sampling and manual Label Studio annotation yielding 150 annotated fish bounding boxes in a stratified 13-camera YOLO dataset (120 train / 30 val) ready for ultralytics training.**

## Performance

- **Duration:** ~2 sessions (5 min automated script + human annotation checkpoint)
- **Started:** 2026-02-20T15:15:04Z
- **Completed:** 2026-02-20
- **Tasks:** 2 (1 auto + 1 human checkpoint)
- **Files modified:** 3

## Accomplishments

- Frame sampling script with MOG2 detection-count-based bin diversity (0, 1, 2, 3+ fish)
- 150 manually annotated fish bounding boxes via Label Studio with YOLO-format export
- Dataset organized into stratified 80/20 train/val split across all 13 cameras (120 train / 30 val)
- `data/yolo_fish/dataset.yaml` configured for direct use with `model.train(data=...)`

## Task Commits

Each task was committed atomically:

1. **Task 1: Build MOG2-guided frame sampling script** - `3627a48` (feat)
2. **Task 2: Organize annotated YOLO dataset** - `3fb9f45` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `scripts/sample_yolo_frames.py` - CLI script: scans per-camera videos with MOG2, bins by detection count, exports diverse JPEG frames for YOLO annotation
- `scripts/organize_yolo_dataset.py` - Dataset organization script: Label Studio YOLO export -> stratified train/val structure across 13 cameras
- `data/yolo_fish/dataset.yaml` - Ultralytics YOLO dataset config (nc=1, names: {0: fish}, absolute path)

## Decisions Made

- `detect()` called on every strided frame (not `apply()`) so detection count drives bin assignment; `apply()` is still called on skipped frames to keep background model accurate
- Script does NOT automate Label Studio import — user imports JPEGs manually via web UI (as specified in plan)
- `--ring-frames` and `--center-frames` exposed as separate CLI args (not hardcoded) for flexibility
- Stratified 80/20 split per camera ensures all 13 cameras represented in both train and val sets

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Removed unused variable `frame_idx` to satisfy ruff F841**
- **Found during:** Task 1 (pre-commit hook lint check)
- **Issue:** Variable assigned but never used after code was restructured to use `cap.get(CAP_PROP_POS_FRAMES)` for actual frame position
- **Fix:** Removed the stale assignment
- **Files modified:** scripts/sample_yolo_frames.py
- **Verification:** `hatch run python scripts/sample_yolo_frames.py --help` passes; ruff passes pre-commit
- **Committed in:** 3627a48 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 lint bug)
**Impact on plan:** Trivial cleanup. No scope creep.

## Issues Encountered

- Pre-commit ruff formatter reformatted `organize_yolo_dataset.py` on first commit attempt; re-staged and committed successfully on second attempt (expected behavior, no impact)

## User Setup Required

None - annotation was completed by user as part of the human checkpoint. Dataset is ready for Plan 02 training.

## Next Phase Readiness

- `data/yolo_fish/dataset.yaml` is ready for `model.train(data="data/yolo_fish/dataset.yaml")` in Plan 02
- 120 training images and 30 validation images with matching YOLO `.txt` label files confirmed
- All 13 cameras represented in both train and val splits
- No blockers for Plan 02 YOLO training

---
*Phase: 02.1.1-object-detection-alternative-to-mog2*
*Completed: 2026-02-20*
