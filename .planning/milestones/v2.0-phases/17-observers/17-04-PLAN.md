# Plan 17-04: 3D Midline Animation Visualization Observer

---
wave: 2
depends_on:
  - 17-02
files_modified:
  - src/aquapose/engine/animation_observer.py
  - tests/unit/engine/test_animation_observer.py
  - src/aquapose/engine/__init__.py
  - pyproject.toml
requirements:
  - OBS-04
autonomous: true
---

## Goal

Implement an Animation3DObserver that generates an interactive HTML viewer using Plotly, showing animated 3D fish midlines with rotate/zoom/frame-scrub controls.

## Context

- **CONTEXT.md decisions**:
  - Interactive HTML viewer using Plotly
  - Self-contained HTML file with rotate/zoom/frame-scrub controls
  - Uses Plotly `Frames` animation API with `go.Scatter3d` traces per fish
  - Adds plotly as a dependency
- **Dependencies on 17-02**: Uses the `context` field on PipelineComplete event (added in 17-02)
- **PipelineContext.midlines_3d**: `list[dict[int, Spline3D]]` — per-frame 3D spline results
- **Spline3D**: has `control_points` (numpy array shape (7,3)) — evaluate B-spline for smooth 3D curves

## Must-Haves (Goal-Backward)

1. Animation3DObserver satisfies Observer protocol
2. On PipelineComplete, generates self-contained `animation_3d.html` in output_dir
3. HTML contains Plotly figure with Frames animation (one frame per pipeline frame)
4. Each fish rendered as a `go.Scatter3d` trace with distinct color
5. Frame scrubber/play/pause controls via Plotly animation API
6. plotly added to pyproject.toml dependencies
7. Unit tests verify observer protocol compliance and figure construction

## Tasks

<task id="17-04-T1">
<title>Add plotly dependency and implement Animation3DObserver</title>
<description>
**Step 1: Add plotly dependency**

In `pyproject.toml`, add `"plotly>=5.18"` to the `dependencies` list.

**Step 2: Create Animation3DObserver**

Create `src/aquapose/engine/animation_observer.py`.

Class `Animation3DObserver`:
- Constructor:
  ```python
  def __init__(
      self,
      output_dir: str | Path,
      *,
      n_eval_points: int = 50,
      line_width: float = 4.0,
  ):
  ```
  - `output_dir`: where to write `animation_3d.html`
  - `n_eval_points`: number of points to evaluate along each spline for smooth curves
  - `line_width`: Plotly Scatter3d line width
- `on_event(self, event: Event) -> None`:
  - On `PipelineComplete`:
    - Extract context from event (skip if None)
    - Extract `midlines_3d` (skip if None)
    - Build Plotly figure and write to `{output_dir}/animation_3d.html`
- `_build_figure(midlines_3d: list[dict]) -> go.Figure`:
  - Collect all unique fish_ids across all frames
  - Assign a distinct color per fish_id (use plotly qualitative color scale, e.g. `plotly.colors.qualitative.Plotly`)
  - Create initial traces (frame 0) as `go.Scatter3d` per fish: mode="lines", x/y/z from evaluated spline points
  - Create `go.Frame` objects for each subsequent frame, each containing updated traces for all fish
  - Fish not present in a given frame get empty x/y/z arrays (trace disappears)
  - For each spline, evaluate B-spline using `scipy.interpolate.BSpline` with knot vector from `aquapose.reconstruction.triangulation.SPLINE_KNOTS` and degree `SPLINE_K`, at `np.linspace(0, 1, n_eval_points)`
  - Set layout:
    - `scene` with equal aspect ratio (`aspectmode="data"`)
    - Title: "AquaPose 3D Midline Animation"
    - `updatemenus` with Play/Pause buttons
    - `sliders` for frame scrubbing
  - Return figure
- `_write_html(fig: go.Figure, path: Path)`:
  - `fig.write_html(str(path), include_plotlyjs=True)` — self-contained HTML

Add `Animation3DObserver` to `src/aquapose/engine/__init__.py` exports and `__all__`.
</description>
</task>

<task id="17-04-T2">
<title>Unit tests for Animation3DObserver</title>
<description>
Create `tests/unit/engine/test_animation_observer.py`.

Tests:
1. `test_animation_observer_satisfies_protocol` — `isinstance(Animation3DObserver(tmp_path), Observer)` is True
2. `test_build_figure_creates_traces` — create mock midlines_3d (3 frames, 2 fish) with numpy control_points arrays. Call `_build_figure()`, assert figure has 2 traces (one per fish) and `len(figure.frames) == 3`
3. `test_build_figure_handles_missing_fish` — frame 0 has fish 0,1; frame 1 has only fish 0. Assert frame 1's trace for fish 1 has empty x/y/z
4. `test_html_output_written` — fire PipelineComplete with mock context, assert `animation_3d.html` exists in tmp_path and file size > 0
5. `test_skips_if_no_context` — fire PipelineComplete without context, assert no file written, no error
6. `test_figure_has_animation_controls` — build figure, assert `figure.layout.updatemenus` is not empty and `figure.layout.sliders` is not empty

For mock Spline3D objects, use simple objects with `control_points` as numpy arrays of shape (7,3) with random but valid coordinates. Use `SPLINE_KNOTS` and `SPLINE_K` from `aquapose.reconstruction.triangulation` for spline evaluation.
</description>
</task>

## Verification

```bash
hatch run test tests/unit/engine/test_animation_observer.py -v
hatch run check
```

- [ ] All tests pass
- [ ] plotly is importable
- [ ] HTML file is self-contained and > 0 bytes
- [ ] Figure contains traces per fish with animation frames
- [ ] Play/Pause and slider controls present in layout
- [ ] No stage code was modified
