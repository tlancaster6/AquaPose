---
phase: 19-alpha-refactor-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/import_boundary_checker.py
  - .pre-commit-config.yaml
  - .hooks/check-import-boundary.sh
autonomous: true
requirements: [AUDIT]

must_haves:
  truths:
    - "A pre-commit hook rejects commits that violate the core/ -> engine/ -> cli/ import layering"
    - "No TYPE_CHECKING backdoors are permitted by the checker"
    - "Structural rules from guidebook section 15 are automated where feasible"
  artifacts:
    - path: "tools/import_boundary_checker.py"
      provides: "AST-based import boundary and structural rule checker"
    - path: ".hooks/check-import-boundary.sh"
      provides: "Shell wrapper for pre-commit hook"
    - path: ".pre-commit-config.yaml"
      provides: "Updated config with import boundary hook"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: ".hooks/check-import-boundary.sh"
      via: "local hook entry"
      pattern: "check-import-boundary"
    - from: ".hooks/check-import-boundary.sh"
      to: "tools/import_boundary_checker.py"
      via: "python invocation"
      pattern: "import_boundary_checker"
---

<objective>
Implement an automated import boundary checker and structural rule enforcement as a pre-commit hook.

Purpose: The guidebook (Section 3) mandates strict one-way import discipline: `core/` imports nothing from engine/cli, `engine/` imports only from core/, `cli/` imports only from engine/. No TYPE_CHECKING backdoors. Section 15 adds structural rules: no file I/O in stage run(), no mutable class attrs on stages, observers don't import core/ internals. This plan automates these checks.

Output: Python-based checker script, shell wrapper, and pre-commit hook configuration.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/alpha_refactor_guidebook.md (sections 3, 15)
@.pre-commit-config.yaml
@src/aquapose/engine/
@src/aquapose/core/
@src/aquapose/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build AST-based import boundary and structural rule checker</name>
  <files>tools/import_boundary_checker.py</files>
  <action>
Create `tools/import_boundary_checker.py` — a standalone Python script (no external deps beyond stdlib) that uses `ast` module to enforce:

**Import Boundary Rules (guidebook Section 3):**
1. Files in `src/aquapose/core/` MUST NOT import from `aquapose.engine` or `aquapose.cli`
2. Files in `src/aquapose/engine/` MUST NOT import from `aquapose.cli`
3. Files in `src/aquapose/cli` (cli.py) may import from `aquapose.engine` only
4. NO imports of `aquapose.engine` or `aquapose.cli` inside `if TYPE_CHECKING:` blocks in core/ — TYPE_CHECKING backdoors are explicitly forbidden by guidebook

**Also check legacy modules that should follow core/ rules** (these are computation modules per the guidebook's Layer 1 definition):
- `src/aquapose/calibration/`, `src/aquapose/segmentation/`, `src/aquapose/tracking/`, `src/aquapose/reconstruction/`, `src/aquapose/initialization/`, `src/aquapose/mesh/`, `src/aquapose/optimization/`
- These are all "pure computation modules" and must not import engine/ or cli/

**Structural Rules (guidebook Section 15):**
5. Stage `run()` methods must not contain file I/O calls (open(), Path.write_*, Path.read_*, etc.) — scan AST for these patterns inside methods named `run` in files under `core/*/stage.py`
6. Observer classes (in `engine/`) must not import directly from `core/` submodule internals — they should use types from `engine/stages.py` (PipelineContext) not reach into core/ types. (Flag as warning since some core types may be legitimately needed)

**Script behavior:**
- Accept file paths as arguments (for pre-commit file-level invocation) OR scan all `src/aquapose/` if no args
- Exit 0 if all checks pass, exit 1 with descriptive error messages if violations found
- Each violation prints: `{filepath}:{line}: {rule_id} — {description}`
- Support `--verbose` flag for extra detail

Rule IDs: `IB-001` (core imports engine/cli), `IB-002` (engine imports cli), `IB-003` (TYPE_CHECKING backdoor), `IB-004` (computation module imports engine/cli), `SR-001` (file I/O in stage run()), `SR-002` (observer imports core internals)
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python tools/import_boundary_checker.py --verbose</automated>
  </verify>
  <done>The checker script runs against the full codebase and reports any violations with rule IDs, file paths, and line numbers. Exit code reflects pass/fail status.</done>
</task>

<task type="auto">
  <name>Task 2: Wire checker as pre-commit hook</name>
  <files>.hooks/check-import-boundary.sh, .pre-commit-config.yaml</files>
  <action>
1. Create `.hooks/check-import-boundary.sh`:
   ```bash
   #!/usr/bin/env bash
   set -euo pipefail
   python tools/import_boundary_checker.py "$@"
   ```

2. Update `.pre-commit-config.yaml` to add a local hook under the existing `repo: local` section:
   ```yaml
   - id: import-boundary
     name: Import boundary check
     entry: bash .hooks/check-import-boundary.sh
     language: system
     files: ^src/aquapose/
     types: [python]
     stages: [pre-commit]
   ```

3. Run the hook manually to verify it works:
   ```bash
   hatch run pre-commit run import-boundary --all-files
   ```

4. If any violations are found in the current codebase, catalog them (do NOT fix them — this is an audit phase). Document any violations as comments in the checker output.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && hatch run pre-commit run import-boundary --all-files 2>&1; echo "Exit: $?"</automated>
  </verify>
  <done>The import-boundary pre-commit hook is registered and runs on all Python files under src/aquapose/. Any current violations are documented but not fixed (audit only).</done>
</task>

</tasks>

<verification>
1. `python tools/import_boundary_checker.py` runs without errors
2. `hatch run pre-commit run import-boundary --all-files` executes the hook
3. The checker correctly identifies test violations (create a temporary violating file, run checker, verify detection, remove file)
4. No false positives on legitimate imports (core modules importing each other is fine, engine importing core is fine)
</verification>

<success_criteria>
- Import boundary checker exists as a reusable tool at `tools/import_boundary_checker.py`
- Pre-commit hook is registered and active
- All 6 rule categories (IB-001 through SR-002) are implemented
- TYPE_CHECKING backdoor detection works
- Any existing violations are cataloged (not fixed)
</success_criteria>

<output>
After completion, create `.planning/phases/19-alpha-refactor-audit/19-01-SUMMARY.md`
</output>
