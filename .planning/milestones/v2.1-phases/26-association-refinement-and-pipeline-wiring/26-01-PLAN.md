---
phase: 26-association-refinement-and-pipeline-wiring
plan: 01
type: tdd
wave: 1
depends_on: [25-02]
files_modified:
  - src/aquapose/core/association/refinement.py
  - src/aquapose/core/association/stage.py
  - src/aquapose/core/association/types.py
  - src/aquapose/core/association/__init__.py
  - src/aquapose/engine/config.py
  - src/aquapose/engine/pipeline.py
  - tests/unit/core/association/test_refinement.py
autonomous: true
requirements: [ASSOC-03]

must_haves:
  truths:
    - "Each tracklet cluster is refined by per-frame 3D triangulation of centroids from constituent tracklets"
    - "Tracklets whose median reprojection error exceeds the configurable threshold are evicted from their cluster"
    - "Evicted tracklets become singleton TrackletGroups with low confidence, not discarded"
    - "After eviction, the cleaned cluster is re-triangulated to produce updated confidence"
    - "Per-frame confidence estimates are emitted alongside the final clusters"
    - "Refinement thresholds are exposed in AssociationConfig with sensible defaults"
  artifacts:
    - path: "src/aquapose/core/association/refinement.py"
      provides: "3D triangulation refinement with tracklet eviction"
      exports: ["refine_clusters"]
    - path: "src/aquapose/core/association/types.py"
      provides: "TrackletGroup with per-frame confidence field"
      contains: "per_frame_confidence"
    - path: "src/aquapose/engine/config.py"
      provides: "AssociationConfig with refinement thresholds"
      contains: "eviction_reproj_threshold"
    - path: "tests/unit/core/association/test_refinement.py"
      provides: "Unit tests for cluster refinement and eviction"
      min_lines: 120
  key_links:
    - from: "src/aquapose/core/association/refinement.py"
      to: "src/aquapose/calibration/luts.py"
      via: "ForwardLUT.cast_ray() for back-projecting centroids to rays"
      pattern: "cast_ray"
    - from: "src/aquapose/core/association/refinement.py"
      to: "src/aquapose/core/association/scoring.py"
      via: "ray_ray_closest_point() for per-frame triangulation"
      pattern: "ray_ray_closest_point"
    - from: "src/aquapose/core/association/stage.py"
      to: "src/aquapose/core/association/refinement.py"
      via: "AssociationStage.run() calls refine_clusters() after merge_fragments()"
      pattern: "refine_clusters"
    - from: "src/aquapose/core/association/stage.py"
      to: "src/aquapose/calibration/luts.py"
      via: "AssociationStage loads ForwardLUTs via load_forward_luts() at start of run()"
      pattern: "load_forward_luts"
---

<objective>
Refine cross-camera identity clusters via per-frame 3D triangulation error, evicting tracklets with consistently high reprojection error and emitting per-frame confidence.

Purpose: Association clustering (Phase 25) produces groups based on pairwise scoring, but some tracklets may be misassigned. Geometric refinement uses actual 3D triangulation to validate each tracklet's membership by checking whether its rays converge with the cluster's consensus 3D position.

Output: `refinement.py` module with `refine_clusters()`, updated AssociationConfig with refinement fields, updated TrackletGroup with per-frame confidence, wiring into AssociationStage.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-association-refinement-and-pipeline-wiring/26-CONTEXT.md

@src/aquapose/core/association/types.py
@src/aquapose/core/association/scoring.py
@src/aquapose/core/association/clustering.py
@src/aquapose/core/association/stage.py
@src/aquapose/core/tracking/types.py
@src/aquapose/calibration/luts.py
@src/aquapose/engine/config.py

<interfaces>
<!-- Key types the executor needs -->

From src/aquapose/core/association/types.py:
```python
@dataclass(frozen=True)
class TrackletGroup:
    fish_id: int
    tracklets: tuple       # tuple[Tracklet2D, ...]
    confidence: float | None = None
```

From src/aquapose/core/tracking/types.py:
```python
@dataclass(frozen=True)
class Tracklet2D:
    camera_id: str
    track_id: int
    frames: tuple          # tuple[int, ...]
    centroids: tuple       # tuple[tuple[float, float], ...]
    bboxes: tuple          # tuple[tuple[float, float, float, float], ...]
    frame_status: tuple    # tuple[str, ...] — "detected" | "coasted" | "interpolated"
```

From src/aquapose/core/association/scoring.py:
```python
def ray_ray_closest_point(
    origin_a: np.ndarray, dir_a: np.ndarray,
    origin_b: np.ndarray, dir_b: np.ndarray,
) -> tuple[float, np.ndarray]:
    """Returns (distance, midpoint) for closest approach of two 3D rays."""
```

From src/aquapose/calibration/luts.py (ForwardLUT):
```python
class ForwardLUT:
    def cast_ray(self, pixels: torch.Tensor) -> tuple[torch.Tensor, torch.Tensor]:
        """pixels: (N, 2) -> origins (N, 3), directions (N, 3)"""
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refinement config fields and update TrackletGroup</name>
  <files>
    src/aquapose/engine/config.py
    src/aquapose/core/association/types.py
  </files>
  <action>
  1. In `AssociationConfig`, add three new frozen fields:
     - `eviction_reproj_threshold: float = 25.0` — median reprojection error (pixels) above which a tracklet is evicted. Fish are ~10cm (~50-100px at typical imaging distance); 25px is conservative (~25% of fish length).
     - `min_cameras_refine: int = 3` — minimum cameras in a cluster to attempt 3D refinement (clusters with fewer cameras skip refinement).
     - `refinement_enabled: bool = True` — toggle to skip refinement entirely (useful for debugging).

  2. In `TrackletGroup`, add an optional `per_frame_confidence` field:
     ```python
     per_frame_confidence: tuple | None = None
     # tuple[float, ...] — one confidence per frame, aligned with the union
     # of all constituent tracklets' frame ranges. None until refinement runs.
     ```
     Keep `confidence` as the aggregate scalar (mean of per-frame values after refinement).
  </action>
  <verify>
    <automated>hatch run test -- tests/unit/core/association/ -x -q</automated>
  </verify>
  <done>
  - AssociationConfig has `eviction_reproj_threshold`, `min_cameras_refine`, `refinement_enabled` fields with sensible defaults
  - TrackletGroup has `per_frame_confidence: tuple | None = None` field
  - Existing association tests still pass (no regression)
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement refine_clusters() and wire into AssociationStage</name>
  <files>
    src/aquapose/core/association/refinement.py
    src/aquapose/core/association/stage.py
    src/aquapose/core/association/__init__.py
    tests/unit/core/association/test_refinement.py
  </files>
  <action>
  Create `src/aquapose/core/association/refinement.py` with:

  1. **`RefinementConfigLike` Protocol** (IB-003 pattern — core/ must not import engine/):
     - `eviction_reproj_threshold: float`
     - `min_cameras_refine: int`
     - `refinement_enabled: bool`

  2. **`refine_clusters()` function**:
     ```python
     def refine_clusters(
         groups: list[TrackletGroup],
         forward_luts: dict[str, ForwardLUT],
         config: RefinementConfigLike,
     ) -> list[TrackletGroup]:
     ```

     Algorithm:
     a. If `not config.refinement_enabled`, return groups unchanged.
     b. For each TrackletGroup with >= `min_cameras_refine` cameras:
        - Compute the union of all frames across constituent tracklets.
        - For each frame in the union, collect centroids from tracklets that have that frame.
        - Back-project each centroid to a ray via `forward_luts[cam_id].cast_ray()`.
        - If >=2 rays available, compute all pairwise `ray_ray_closest_point()` distances.
        - The frame's 3D point = mean of pairwise midpoints. Frame confidence = 1.0 - (mean_distance / eviction_reproj_threshold), clamped to [0, 1].
        - For each tracklet, compute its median reprojection error:
          For each frame where the tracklet has a centroid, reproject the consensus 3D point to that camera using the ForwardLUT (inverse: project 3D -> find nearest grid point, but for simplicity use the ray-ray distance as a proxy since we don't have inverse projection here). Instead, compute: for each frame, the tracklet's ray-to-consensus-midpoint distance. The median across all frames is the tracklet's "reprojection" metric.
        - If the median distance > `eviction_reproj_threshold` (in metres, default 0.025m = 2.5cm), evict the tracklet.
     c. Evicted tracklets become singleton TrackletGroups with `confidence=0.1`.
     d. After eviction, re-compute per-frame confidence for the cleaned cluster (re-triangulate with remaining tracklets).
     e. Set `TrackletGroup.confidence` = mean of per-frame confidences. Set `per_frame_confidence` = tuple of per-frame values.
     f. Groups with < `min_cameras_refine` cameras: skip refinement, keep `confidence` as-is from clustering, set `per_frame_confidence = None`.

  3. **Wire into AssociationStage.run()**:

     a. Add an optional `lut_config` constructor parameter to `AssociationStage.__init__` (default `None`). Also accept optional `calibration_path: str | None = None`. Store both as instance attributes.

     b. At the start of `run()`, load ForwardLUTs if `lut_config` and `calibration_path` are available:
        ```python
        forward_luts: dict[str, ForwardLUT] | None = None
        if self._lut_config is not None and self._calibration_path is not None:
            from aquapose.calibration.luts import load_forward_luts
            forward_luts = load_forward_luts(self._calibration_path, self._lut_config)
        ```
        If `lut_config` is None or `calibration_path` is None, log a warning ("ForwardLUTs unavailable — skipping cluster refinement") and skip refinement.

     c. After `groups = merge_fragments(groups, self._config.association)`, add:
        ```python
        if forward_luts is not None:
            from aquapose.core.association.refinement import refine_clusters
            groups = refine_clusters(groups, forward_luts, self._config.association)
        ```

     d. Update `build_stages()` in `pipeline.py` to pass `lut_config=config.lut` and `calibration_path=config.calibration_path` when constructing AssociationStage (same pattern as 26-02 does for MidlineStage).

     IMPORTANT: The constructor changes must be backward-compatible. Both new parameters default to None, so existing construction sites (tests, etc.) continue to work without modification.

  4. **Update `__init__.py`**: Export `refine_clusters` from `aquapose.core.association`.

  5. **Tests in `test_refinement.py`**:
     - Test with synthetic TrackletGroups where all tracklets converge (no eviction).
     - Test eviction: one tracklet with a wildly different camera position gets evicted, becomes singleton.
     - Test re-triangulation after eviction produces updated confidence.
     - Test `refinement_enabled=False` returns groups unchanged.
     - Test groups below `min_cameras_refine` are skipped.
     - Test per-frame confidence is populated and is a tuple of floats.
     - Use mock ForwardLUTs that return predictable ray origins/directions (same pattern as test_scoring.py).

  NOTE: The "reprojection error" metric used here is ray-to-consensus-point distance in 3D (metres), NOT pixel reprojection. This is simpler and avoids needing the full projection model. The threshold `eviction_reproj_threshold` is therefore in metres (default 0.025). Update the config field docstring accordingly: rename to `eviction_ray_threshold` if clearer, but keep the field name as specified in CONTEXT.md decisions.

  Actually, per CONTEXT.md: "Eviction metric: median reprojection error across the tracklet's detected frames exceeds a configurable threshold." The word "reprojection" in the decisions implies pixel-space error. However, since we only have ForwardLUTs (pixel->ray, not 3D->pixel), use ray-ray distance in metres as the proxy metric. Document this clearly. The default threshold of 0.025m (2.5cm) is appropriate given fish are ~10cm long, ~2cm wide.
  </action>
  <verify>
    <automated>hatch run test -- tests/unit/core/association/test_refinement.py -x -v</automated>
  </verify>
  <done>
  - `refine_clusters()` triangulates per-frame, evicts high-error tracklets as singletons, re-triangulates cleaned clusters
  - Per-frame confidence populated on refined groups
  - AssociationStage accepts optional lut_config and calibration_path; loads ForwardLUTs at run() start
  - AssociationStage.run() calls refine_clusters() after merge_fragments() (skips gracefully when LUTs unavailable)
  - build_stages() passes lut_config and calibration_path to AssociationStage
  - All unit tests pass including eviction, skip, and confidence validation
  </done>
</task>

</tasks>

<verification>
```bash
# All association tests pass
hatch run test -- tests/unit/core/association/ -x -v

# Refinement tests specifically
hatch run test -- tests/unit/core/association/test_refinement.py -x -v

# Type checking
hatch run typecheck

# Lint
hatch run lint
```
</verification>

<success_criteria>
- Clusters are refined via per-frame 3D triangulation of constituent tracklet centroids
- Tracklets with median ray distance exceeding threshold are evicted to singleton groups
- Per-frame confidence values are computed and stored on TrackletGroup
- AssociationConfig exposes all refinement thresholds as frozen fields
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-association-refinement-and-pipeline-wiring/26-01-SUMMARY.md`
</output>
