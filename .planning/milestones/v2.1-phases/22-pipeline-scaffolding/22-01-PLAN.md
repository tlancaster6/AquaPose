---
phase: 22-pipeline-scaffolding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquapose/core/tracking/types.py
  - src/aquapose/core/association/types.py
  - src/aquapose/core/context.py
  - src/aquapose/core/tracking/__init__.py
  - src/aquapose/core/association/__init__.py
  - src/aquapose/core/tracking/stage.py
  - src/aquapose/core/tracking/backends/hungarian.py
  - src/aquapose/core/tracking/backends/__init__.py
  - src/aquapose/core/association/stage.py
  - src/aquapose/core/association/backends/ransac_centroid.py
  - src/aquapose/core/association/backends/__init__.py
  - src/aquapose/tracking/tracker.py
  - src/aquapose/tracking/associate.py
  - src/aquapose/tracking/writer.py
  - src/aquapose/tracking/__init__.py
  - tests/unit/core/tracking/test_tracking_stage.py
  - tests/unit/core/association/test_association_stage.py
  - tests/unit/tracking/test_tracker.py
  - tests/unit/tracking/test_associate.py
  - tests/unit/tracking/test_writer.py
autonomous: true
requirements:
  - PIPE-01

must_haves:
  truths:
    - "Tracklet2D is a frozen dataclass in core/tracking/types.py with fields camera_id, track_id, frames, centroids, bboxes, frame_status"
    - "TrackletGroup is a frozen dataclass in core/association/types.py with fields fish_id, tracklets, confidence (Optional)"
    - "CarryForward is a frozen dataclass in core/context.py with field tracks_2d_state: dict[str, Any] = field(default_factory=dict) for per-camera 2D track state"
    - "PipelineContext has tracks_2d (dict[str, list] | None) and tracklet_groups (list | None) fields replacing associated_bundles and tracks"
    - "Old AssociationStage, TrackingStage, FishTracker, ransac_centroid_cluster source modules are deleted"
    - "Old tests exercising deleted code are deleted"
  artifacts:
    - path: "src/aquapose/core/tracking/types.py"
      provides: "Tracklet2D frozen dataclass + re-exported FishTrack/TrackState (kept for reconstruction compatibility)"
      contains: "Tracklet2D"
    - path: "src/aquapose/core/association/types.py"
      provides: "TrackletGroup frozen dataclass"
      contains: "TrackletGroup"
    - path: "src/aquapose/core/context.py"
      provides: "Updated PipelineContext with tracks_2d and tracklet_groups fields, plus CarryForward frozen dataclass"
      contains: "tracks_2d|CarryForward"
  key_links:
    - from: "src/aquapose/core/context.py"
      to: "core/tracking/types.py, core/association/types.py"
      via: "docstring type references (no runtime import — stdlib types only)"
      pattern: "tracks_2d|tracklet_groups"
---

<objective>
Define new v2.1 domain types (Tracklet2D, TrackletGroup), update PipelineContext with new typed fields for the reordered pipeline, and delete all legacy tracking/association code (old stages, backends, FishTracker, ransac_centroid_cluster).

Purpose: Establishes the data contracts for the new 5-stage pipeline order (Detection → 2D Tracking → Association → Midline → Reconstruction) and removes dead code that would otherwise confuse subsequent phases.

Output: New domain types in core/, updated PipelineContext, deleted legacy modules and their tests.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-pipeline-scaffolding/22-CONTEXT.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/aquapose/core/context.py (current):
```python
@dataclass
class PipelineContext:
    frame_count: int | None = None
    camera_ids: list[str] | None = None
    detections: list[dict[str, list]] | None = None
    annotated_detections: list[dict[str, list]] | None = None
    associated_bundles: list[list] | None = None      # TO BE REMOVED
    tracks: list[list] | None = None                   # TO BE REMOVED
    midlines_3d: list[dict] | None = None
    stage_timing: dict[str, float] = field(default_factory=dict)
```

From src/aquapose/core/tracking/types.py (current — FishTrack, TrackState):
```python
# FishTrack and TrackState are used by reconstruction stage — keep these types
# but they will no longer be populated by the old TrackingStage
```

From src/aquapose/core/association/types.py (current):
```python
@dataclass
class AssociationBundle:
    fish_idx: int
    centroid_3d: np.ndarray
    camera_detections: dict[str, int]
    n_cameras: int
    reprojection_residual: float
    confidence: float
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Tracklet2D and TrackletGroup domain types and update PipelineContext</name>
  <files>
    src/aquapose/core/tracking/types.py
    src/aquapose/core/association/types.py
    src/aquapose/core/context.py
    src/aquapose/core/tracking/__init__.py
    src/aquapose/core/association/__init__.py
  </files>
  <action>
**1. Add Tracklet2D to `src/aquapose/core/tracking/types.py`:**

Create a frozen dataclass `Tracklet2D` with these exact fields:
- `camera_id: str` — which camera this tracklet belongs to
- `track_id: int` — unique identifier within this camera (local, not global)
- `frames: tuple[int, ...]` — ordered frame indices where tracklet is active
- `centroids: tuple[tuple[float, float], ...]` — per-frame (u, v) pixel centroids
- `bboxes: tuple[tuple[float, float, float, float], ...]` — per-frame (x, y, w, h)
- `frame_status: tuple[str, ...]` — per-frame "detected" or "coasted"

Use `tuple` (not `list`) for immutability since the dataclass is frozen. Keep existing FishTrack and TrackState in the same file — they are still used by the reconstruction stage.

**2. Add TrackletGroup to `src/aquapose/core/association/types.py`:**

Create a frozen dataclass `TrackletGroup` with these exact fields:
- `fish_id: int` — global fish identity
- `tracklets: tuple` — tuple of Tracklet2D objects (use generic tuple, not Tracklet2D directly, to preserve the core/ import boundary — association types must not import tracking types at runtime). Document the actual element type in the docstring.
- `confidence: float | None = None` — None until Phase 25/26 populates it

Keep existing `AssociationBundle` in the file — it may still be referenced by reconstruction until Phase 26 replaces it.

**3. Add CarryForward to `src/aquapose/core/context.py`:**

Create a frozen dataclass `CarryForward` that persists per-camera 2D track state across pipeline batch invocations. Per CONTEXT.md locked decision: "Stub TrackingStage accepts and returns CarryForward (unchanged), establishing the carry interface plumbing now for Phase 24."

```python
@dataclass(frozen=True)
class CarryForward:
    """Cross-batch state carried between pipeline invocations.

    Persists per-camera 2D track state (positions, velocities, lifecycle per
    local tracklet) across batches. Each camera's tracker is independent —
    no cross-camera state in carry. Cross-camera association operates on
    complete tracklets within the batch, not incrementally.

    Attributes:
        tracks_2d_state: Per-camera opaque tracker state. Keys are camera IDs,
            values are backend-specific state objects (e.g., OC-SORT internal
            state dicts). Placeholder ``dict[str, Any]`` — Phase 24 defines
            the concrete OC-SORT state type.
    """

    tracks_2d_state: dict = field(default_factory=dict)
```

Use `dict` (not `dict[str, Any]`) on the field annotation to avoid importing `Any` — document the actual key/value types in the docstring only. The dataclass is frozen so carry state is replaced wholesale each batch, not mutated.

Add `CarryForward` to the module's exports (it is used by engine/ and will be imported by `core/__init__.py`).

**4. Update PipelineContext in `src/aquapose/core/context.py`:**

Replace the old pipeline data flow fields with the new stage ordering. The new data flow is:
1. Detection → `detections`
2. 2D Tracking → `tracks_2d`
3. Association → `tracklet_groups`
4. Midline → `annotated_detections`
5. Reconstruction → `midlines_3d`

Specific changes:
- Remove `associated_bundles: list[list] | None = None`
- Remove `tracks: list[list] | None = None`
- Add `tracks_2d: dict[str, list] | None = None` — per-camera 2D tracklets, typed as `dict[CameraId, list[Tracklet2D]]` in docstring
- Add `tracklet_groups: list | None = None` — cross-camera identity clusters, typed as `list[TrackletGroup]` in docstring

Update the class docstring to reflect the new 5-stage data flow. Keep using generic stdlib types (dict, list) on the field annotations to preserve import boundary (ENG-07). Document exact element types in docstring only.

IMPORTANT: Do NOT import Tracklet2D or TrackletGroup in context.py — maintain the no-external-imports rule for this module.

**5. Update `__init__.py` exports:**

In `src/aquapose/core/tracking/__init__.py`: Add `Tracklet2D` to imports and `__all__`. Keep FishTrack and TrackState exports.

In `src/aquapose/core/association/__init__.py`: Add `TrackletGroup` to imports and `__all__`. Keep AssociationBundle export for now (used by reconstruction until Phase 26).

In `src/aquapose/core/__init__.py` (or wherever core re-exports context types): Add `CarryForward` to imports and `__all__` alongside `PipelineContext` and `Stage`.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -c "from aquapose.core.tracking import Tracklet2D, FishTrack, TrackState; from aquapose.core.association import TrackletGroup, AssociationBundle; from aquapose.core.context import PipelineContext, CarryForward; ctx = PipelineContext(); assert hasattr(ctx, 'tracks_2d'); assert hasattr(ctx, 'tracklet_groups'); assert not hasattr(ctx, 'associated_bundles'); assert not hasattr(ctx, 'tracks'); cf = CarryForward(); assert cf.tracks_2d_state == {}; print('OK')"</automated>
  </verify>
  <done>Tracklet2D, TrackletGroup, and CarryForward frozen dataclasses exist with specified fields. PipelineContext has tracks_2d and tracklet_groups fields; associated_bundles and tracks fields are removed. CarryForward has tracks_2d_state dict field. All types importable from their package __init__.py.</done>
</task>

<task type="auto">
  <name>Task 2: Delete legacy tracking/association code and their tests</name>
  <files>
    src/aquapose/core/tracking/stage.py
    src/aquapose/core/tracking/backends/hungarian.py
    src/aquapose/core/tracking/backends/__init__.py
    src/aquapose/core/association/stage.py
    src/aquapose/core/association/backends/ransac_centroid.py
    src/aquapose/core/association/backends/__init__.py
    src/aquapose/tracking/tracker.py
    src/aquapose/tracking/associate.py
    src/aquapose/tracking/writer.py
    src/aquapose/tracking/__init__.py
    tests/unit/core/tracking/test_tracking_stage.py
    tests/unit/core/association/test_association_stage.py
    tests/unit/tracking/test_tracker.py
    tests/unit/tracking/test_associate.py
    tests/unit/tracking/test_writer.py
  </files>
  <action>
**Delete the following source files entirely:**

1. `src/aquapose/core/tracking/stage.py` — old TrackingStage (Stage 4 consuming associated_bundles)
2. `src/aquapose/core/tracking/backends/hungarian.py` — old HungarianBackend wrapping FishTracker
3. `src/aquapose/core/tracking/backends/__init__.py` — old backend registry (get_backend)
4. `src/aquapose/core/association/stage.py` — old AssociationStage (Stage 3 consuming annotated_detections)
5. `src/aquapose/core/association/backends/ransac_centroid.py` — old RansacCentroidBackend
6. `src/aquapose/core/association/backends/__init__.py` — old backend registry (get_backend)
7. `src/aquapose/tracking/tracker.py` — FishTracker (the v1.0 tracker with track-driven association)
8. `src/aquapose/tracking/associate.py` — ransac_centroid_cluster, discover_births, claim_detections_for_tracks
9. `src/aquapose/tracking/writer.py` — tracking output writer

**Update `src/aquapose/tracking/__init__.py`:**

The old `__init__.py` exports FishTracker, FishTrack, etc. from the deleted modules. Replace its contents to re-export only what still exists. Since FishTrack and TrackState now live in `core/tracking/types.py`, and the tracking package itself is gutted, make it a near-empty package that just documents "legacy tracking package — v2.1 tracking lives in core/tracking/". Do NOT delete the tracking/ package itself — it may still be referenced by tests or other code that hasn't been updated yet.

If `src/aquapose/tracking/__init__.py` currently imports from `tracker.py` or `associate.py`, remove those imports. Keep it as a minimal `__init__.py` with docstring and empty `__all__`.

**Update `src/aquapose/core/tracking/__init__.py`:**

Remove the import of `TrackingStage` from `stage.py` (which was deleted). Keep Tracklet2D, FishTrack, TrackState exports. Update `__all__` to remove `TrackingStage`.

**Update `src/aquapose/core/association/__init__.py`:**

Remove the import of `AssociationStage` from `stage.py` (which was deleted). Keep TrackletGroup, AssociationBundle exports. Update `__all__` to remove `AssociationStage`.

**Delete the following test files entirely:**

1. `tests/unit/core/tracking/test_tracking_stage.py` — tests the deleted TrackingStage
2. `tests/unit/core/association/test_association_stage.py` — tests the deleted AssociationStage
3. `tests/unit/tracking/test_tracker.py` — tests FishTracker
4. `tests/unit/tracking/test_associate.py` — tests ransac_centroid_cluster
5. `tests/unit/tracking/test_writer.py` — tests tracking writer (exercises deleted writer.py)

These tests exercise entirely deleted code — there is nothing to adapt, only delete.

**Also check and update `src/aquapose/core/__init__.py`:**

Remove `AssociationStage` and `TrackingStage` from imports and `__all__`. These classes no longer exist. Keep the other exports (DetectionStage, MidlineStage, ReconstructionStage, SyntheticDataStage, PipelineContext, Stage). Update the module docstring to reflect the new stage ordering.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -c "import aquapose.core; assert not hasattr(aquapose.core, 'TrackingStage'); assert not hasattr(aquapose.core, 'AssociationStage'); from aquapose.core import DetectionStage, MidlineStage, ReconstructionStage, SyntheticDataStage, PipelineContext, Stage; print('Imports OK')" && python -c "
import importlib, sys
# Verify deleted modules cannot be imported
for mod in ['aquapose.core.tracking.stage', 'aquapose.core.association.stage', 'aquapose.tracking.tracker', 'aquapose.tracking.associate']:
    try:
        importlib.import_module(mod)
        print(f'FAIL: {mod} should not be importable')
        sys.exit(1)
    except (ImportError, ModuleNotFoundError):
        pass
print('Deletion verified OK')
"</automated>
  </verify>
  <done>Old AssociationStage, TrackingStage, FishTracker, ransac_centroid_cluster source files are deleted. Old tracking/association backends deleted. All test files exercising deleted code are deleted. core/__init__.py no longer exports deleted stage classes. tracking/__init__.py is a minimal stub.</done>
</task>

</tasks>

<verification>
1. `python -c "from aquapose.core.tracking import Tracklet2D; from aquapose.core.association import TrackletGroup; from aquapose.core.context import CarryForward; print('types OK')"` succeeds
2. `python -c "from aquapose.core.context import PipelineContext, CarryForward; ctx = PipelineContext(); assert ctx.tracks_2d is None; assert ctx.tracklet_groups is None; cf = CarryForward(); assert cf.tracks_2d_state == {}"` succeeds
3. `python -c "from aquapose.core import DetectionStage, MidlineStage, ReconstructionStage"` succeeds
4. Importing `aquapose.core.tracking.stage` raises ImportError
5. Importing `aquapose.tracking.tracker` raises ImportError
6. No references to `associated_bundles` or `tracks` (as PipelineContext fields) remain in context.py
</verification>

<success_criteria>
- Tracklet2D, TrackletGroup, and CarryForward exist as frozen dataclasses with the specified fields
- PipelineContext has tracks_2d and tracklet_groups; does NOT have associated_bundles or tracks
- CarryForward has tracks_2d_state (dict) for per-camera 2D track state; no old bundle or 3D cluster fields
- All legacy tracking/association modules are deleted from the source tree
- All tests exercising deleted code are deleted
- core/__init__.py exports are updated (no TrackingStage or AssociationStage)
</success_criteria>

<output>
After completion, create `.planning/phases/22-pipeline-scaffolding/22-01-SUMMARY.md`
</output>
