---
phase: 20-post-refactor-loose-ends
plan: 05
type: execute
wave: 2
depends_on: [20-01, 20-02, 20-03]
files_modified:
  - src/aquapose/core/detection/stage.py
  - src/aquapose/core/midline/stage.py
  - src/aquapose/io/discovery.py
  - src/aquapose/io/__init__.py
  - src/aquapose/visualization/overlay.py
  - src/aquapose/visualization/midline_viz.py
  - src/aquapose/visualization/triangulation_viz.py
  - src/aquapose/visualization/__init__.py
  - src/aquapose/visualization/diagnostics.py
  - tests/regression/conftest.py
  - tests/unit/segmentation/test_model.py
autonomous: true
requirements: [REMEDIATE]

must_haves:
  truths:
    - "Camera-video discovery logic is shared, not duplicated"
    - "diagnostics.py is split into focused modules"
    - "Stale 'orchestrator' comments are removed"
    - "Regression tests use environment variables for paths"
    - "Backward-compat test fixtures for dead modules are removed"
  artifacts:
    - path: "src/aquapose/io/discovery.py"
      provides: "Shared camera-video discovery utility"
      exports: ["discover_camera_videos"]
    - path: "src/aquapose/visualization/overlay.py"
      provides: "Overlay visualization functions"
    - path: "src/aquapose/visualization/midline_viz.py"
      provides: "Midline visualization functions"
    - path: "src/aquapose/visualization/triangulation_viz.py"
      provides: "Triangulation visualization functions"
  key_links:
    - from: "src/aquapose/core/detection/stage.py"
      to: "src/aquapose/io/discovery.py"
      via: "import discover_camera_videos"
      pattern: "from aquapose.io.discovery import discover_camera_videos"
    - from: "tests/regression/conftest.py"
      to: "environment variables"
      via: "os.environ.get"
      pattern: "AQUAPOSE_VIDEO_DIR|AQUAPOSE_CALIBRATION_PATH"
---

<objective>
Address all remaining info-level findings (AUD-009 through AUD-018) and fix regression test paths (AUD-004).

Purpose: Clean up duplicated code, split a 2200-LOC file into focused modules, remove stale comments, fix regression test environment, and delete backward-compat tests for now-deleted modules.

Output: Cleaner codebase with shared utilities, focused visualization modules, and working regression test infrastructure.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-post-refactor-loose-ends/20-CONTEXT.md

<interfaces>
<!-- Duplicated camera-video discovery pattern -->
From core/detection/stage.py:89 and core/midline/stage.py:98:
```python
# Discover camera videos (same logic as v1.0 orchestrator)
video_paths = sorted(Path(self._video_dir).glob("*.mp4"))
camera_map = {}
for vp in video_paths:
    cam_id = vp.stem  # or similar extraction logic
    camera_map[cam_id] = vp
```

<!-- diagnostics.py is 2,203 LOC -->
src/aquapose/visualization/diagnostics.py — contains overlay, midline viz, and triangulation viz functions

<!-- Regression test conftest defaults -->
From tests/regression/conftest.py:
```python
_DEFAULT_VIDEO_DIR = Path("C:/Users/tucke/Desktop/Aqua/Videos/021826/core_videos")
_DEFAULT_CALIBRATION = Path("C:/Users/tucke/Desktop/Aqua/AquaCal/release_calibration/calibration.json")
```

<!-- Stale backward-compat fixture -->
From tests/unit/segmentation/test_model.py:208-212:
MaskRCNNSegmentor importability check — module still exists in segmentation/ but is legacy
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared camera-video discovery, split diagnostics.py, remove stale comments</name>
  <files>
    src/aquapose/io/discovery.py
    src/aquapose/io/__init__.py
    src/aquapose/core/detection/stage.py
    src/aquapose/core/midline/stage.py
    src/aquapose/visualization/overlay.py
    src/aquapose/visualization/midline_viz.py
    src/aquapose/visualization/triangulation_viz.py
    src/aquapose/visualization/__init__.py
    src/aquapose/visualization/diagnostics.py
  </files>
  <action>
    **Camera-video discovery (AUD-013):**
    1. Create `src/aquapose/io/discovery.py` with a `discover_camera_videos(video_dir)` function that:
       - Takes a video directory path
       - Globs for video files (*.mp4)
       - Returns a dict mapping camera_id -> video_path
       - Extracts camera_id from filename stem
       - Read the actual duplicate logic from detection/stage.py and midline/stage.py to match exactly
    2. Add `discover_camera_videos` to `src/aquapose/io/__init__.py` exports and `__all__`
    3. Update `core/detection/stage.py` and `core/midline/stage.py` to import and use `discover_camera_videos` instead of inline discovery
    4. Remove the "same logic as v1.0 orchestrator" comments from both files (AUD-018)

    **Split diagnostics.py (AUD-012, AUD-014):**
    5. Read `src/aquapose/visualization/diagnostics.py` to understand its function groupings
    6. Split into 3 focused modules based on function domains:
       - `src/aquapose/visualization/overlay.py` — 2D overlay/reprojection visualization functions
       - `src/aquapose/visualization/midline_viz.py` — midline-specific visualization functions
       - `src/aquapose/visualization/triangulation_viz.py` — triangulation/3D visualization functions
    7. Keep `diagnostics.py` as a thin re-export module for backward compat:
       ```python
       """Backward-compatible re-exports from split visualization modules."""
       from aquapose.visualization.overlay import *  # noqa: F401,F403
       from aquapose.visualization.midline_viz import *  # noqa: F401,F403
       from aquapose.visualization.triangulation_viz import *  # noqa: F401,F403
       ```
       This ensures any existing imports from diagnostics.py still work.
    8. Update `src/aquapose/visualization/__init__.py` to export from the new modules
    9. Check which engine observers import from diagnostics.py and update their imports to use the specific new module

    Use your judgment on exact function grouping — the key criterion is each new file should be cohesive and under ~800 LOC.
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -c "from aquapose.io.discovery import discover_camera_videos; print('OK')" && python -c "from aquapose.visualization.diagnostics import *; print('backward compat OK')" && hatch run test 2>&1 | tail -10</automated>
  </verify>
  <done>
    - discover_camera_videos() exists in io/discovery.py and is used by both stage files
    - diagnostics.py split into 3 focused modules (each under ~800 LOC)
    - diagnostics.py remains as backward-compat re-export shim
    - Stale "orchestrator" comments removed from stage files
    - All unit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix regression test paths and remove dead backward-compat fixtures</name>
  <files>
    tests/regression/conftest.py
    tests/unit/segmentation/test_model.py
  </files>
  <action>
    **Regression test environment variables (AUD-004):**
    1. Update `tests/regression/conftest.py` to use environment variables instead of hardcoded paths:
       - `AQUAPOSE_VIDEO_DIR` — path to video directory. No hardcoded fallback.
       - `AQUAPOSE_CALIBRATION_PATH` — path to calibration file. No hardcoded fallback.
       - `AQUAPOSE_YOLO_WEIGHTS` — path to YOLO weights (optional, has sensible default)
       - `AQUAPOSE_UNET_WEIGHTS` — path to U-Net weights (optional, has sensible default)
    2. Update `_resolve_real_data_paths()`:
       - Read paths from `os.environ.get("AQUAPOSE_VIDEO_DIR")` and `os.environ.get("AQUAPOSE_CALIBRATION_PATH")`
       - If env var not set, `pytest.skip("AQUAPOSE_VIDEO_DIR not set — set environment variable to run regression tests")`
       - Remove `_DEFAULT_VIDEO_DIR` and `_DEFAULT_CALIBRATION` constants
       - Keep weight defaults as fallbacks but also check env vars first
    3. Add a brief comment at module level explaining the required environment variables

    **Dead backward-compat test fixtures (AUD-017):**
    4. In `tests/unit/segmentation/test_model.py`:
       - Check if the MaskRCNNSegmentor importability test (lines ~208-212) references anything in now-deleted modules
       - The MaskRCNNSegmentor itself lives in segmentation/ which is still active, so this test is probably fine to keep
       - If it references deleted modules, remove it
    5. After Plan 02 deletes `tests/unit/pipeline/`, verify no other test file imports from `tests.unit.pipeline` — if so, fix those imports

    **Run regression tests** (if env vars can be set):
    6. If the environment has video data available, set the env vars and run `hatch run test -- tests/regression/ -v`
    7. Report results — if numerical drift is found, triage per case (fix bugs, accept RANSAC non-determinism, document reasoning)
  </action>
  <verify>
    <automated>cd C:/Users/tucke/PycharmProjects/AquaPose && python -c "import tests.regression.conftest; print('conftest loads OK')" && hatch run test 2>&1 | tail -10</automated>
  </verify>
  <done>
    - Regression test conftest uses environment variables for video/calibration paths
    - No hardcoded machine-specific paths in test code
    - Clear skip message when env vars not set
    - Dead backward-compat test fixtures cleaned up (if applicable)
    - Full unit test suite passes
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "_DEFAULT_VIDEO_DIR\|_DEFAULT_CALIBRATION" tests/` returns 0 matches
2. `grep -rn "AQUAPOSE_VIDEO_DIR" tests/regression/conftest.py` returns matches (env var usage)
3. `python -c "from aquapose.io.discovery import discover_camera_videos; print('OK')"` succeeds
4. `wc -l src/aquapose/visualization/diagnostics.py` shows small file (~10-20 LOC re-export shim)
5. `hatch run test` passes all unit tests
</verification>

<success_criteria>
- Camera-video discovery deduplicated into shared utility
- diagnostics.py split into 3 focused, cohesive modules
- Regression tests use environment variables for data paths
- Stale comments and dead fixtures removed
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-post-refactor-loose-ends/20-05-SUMMARY.md`
</output>
