---
phase: 26-association-refinement-and-pipeline-wiring
plan: 03
type: execute
wave: 3
depends_on: [26-02]
files_modified:
  - src/aquapose/core/reconstruction/stage.py
  - src/aquapose/engine/hdf5_observer.py
  - src/aquapose/engine/config.py
  - src/aquapose/engine/pipeline.py
  - tests/unit/core/reconstruction/test_reconstruction_stage.py
  - tests/unit/engine/test_hdf5_observer.py
autonomous: true
requirements: [PIPE-03]

must_haves:
  truths:
    - "Reconstruction reads from tracklet_groups and annotated_detections, triangulating using only cameras known to observe each fish per frame"
    - "No RANSAC cross-view matching step is required — camera membership comes from tracklet_groups"
    - "Fish below min_cameras in a frame are dropped with reason insufficient_views"
    - "Short gaps where a fish drops below min_cameras are interpolated up to max_interp_gap frames"
    - "Interpolated frames are flagged via confidence=0 (not a separate status field)"
    - "HDF5 output uses fish-first structure with spline_controls[T, N, 3] and confidence[T] per fish"
    - "The full pipeline (Detection -> 2D Tracking -> Association -> Midline -> Reconstruction) runs end-to-end"
  artifacts:
    - path: "src/aquapose/core/reconstruction/stage.py"
      provides: "ReconstructionStage consuming tracklet_groups with known camera membership"
      contains: "tracklet_groups"
    - path: "src/aquapose/engine/hdf5_observer.py"
      provides: "Fish-first HDF5 output with spline_controls and confidence arrays"
      contains: "spline_controls"
    - path: "src/aquapose/engine/config.py"
      provides: "ReconstructionConfig with min_cameras, max_interp_gap, n_control_points"
      contains: "min_cameras"
    - path: "tests/unit/core/reconstruction/test_reconstruction_stage.py"
      provides: "Tests for tracklet-group-driven reconstruction"
      min_lines: 80
  key_links:
    - from: "src/aquapose/core/reconstruction/stage.py"
      to: "src/aquapose/core/association/types.py"
      via: "ReconstructionStage reads TrackletGroup.tracklets for per-frame camera membership"
      pattern: "TrackletGroup"
    - from: "src/aquapose/core/reconstruction/stage.py"
      to: "src/aquapose/core/reconstruction/backends/triangulation.py"
      via: "Delegates per-frame triangulation to TriangulationBackend"
      pattern: "reconstruct_frame"
    - from: "src/aquapose/engine/hdf5_observer.py"
      to: "src/aquapose/core/context.py"
      via: "Reads midlines_3d and tracklet_groups from PipelineContext"
      pattern: "midlines_3d"
---

<objective>
Rewrite ReconstructionStage to consume tracklet_groups with known camera membership (no RANSAC), add gap interpolation, and update HDF5 output to fish-first structure with per-frame confidence — completing the end-to-end pipeline.

Purpose: The final pipeline stage must leverage the camera membership knowledge from association to triangulate directly (no RANSAC matching), handle dropped frames via interpolation, and produce the HDF5 output format specified in CONTEXT.md decisions.

Output: Rewritten `ReconstructionStage.run()`, updated `HDF5ExportObserver`, new ReconstructionConfig fields, working end-to-end pipeline.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-association-refinement-and-pipeline-wiring/26-CONTEXT.md
@.planning/phases/26-association-refinement-and-pipeline-wiring/26-01-PLAN.md
@.planning/phases/26-association-refinement-and-pipeline-wiring/26-02-PLAN.md

@src/aquapose/core/reconstruction/stage.py
@src/aquapose/core/reconstruction/backends/triangulation.py
@src/aquapose/reconstruction/triangulation.py
@src/aquapose/core/context.py
@src/aquapose/core/association/types.py
@src/aquapose/core/tracking/types.py
@src/aquapose/engine/hdf5_observer.py
@src/aquapose/engine/config.py
@src/aquapose/engine/pipeline.py

<interfaces>
<!-- Key types the executor needs -->

From src/aquapose/core/association/types.py (after 26-01):
```python
@dataclass(frozen=True)
class TrackletGroup:
    fish_id: int
    tracklets: tuple       # tuple[Tracklet2D, ...]
    confidence: float | None = None
    per_frame_confidence: tuple | None = None
```

From src/aquapose/reconstruction/triangulation.py:
```python
MidlineSet = dict[int, dict[str, Midline2D]]
# fish_id -> camera_id -> Midline2D

@dataclass
class Midline3D:
    control_points: np.ndarray  # (N_CTRL, 3)
    arc_length: float
    half_widths: np.ndarray     # (N_SAMPLE_POINTS,)
    n_cameras: int
    mean_residual: float
    max_residual: float
    is_low_confidence: bool
    frame_index: int

SPLINE_N_CTRL: int = 7
```

From TriangulationBackend:
```python
class TriangulationBackend:
    def reconstruct_frame(self, frame_idx: int, midline_set: MidlineSet) -> dict[int, Midline3D]:
        """midline_set: fish_id -> cam_id -> Midline2D"""
```

From HDF5ExportObserver (current frame-major layout — to be replaced):
```python
class HDF5ExportObserver:
    def _write_hdf5(self, event: PipelineComplete) -> None:
        # Currently: /frames/NNNN/fish_N/control_points
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ReconstructionConfig fields and rewrite ReconstructionStage</name>
  <files>
    src/aquapose/engine/config.py
    src/aquapose/core/reconstruction/stage.py
    src/aquapose/engine/pipeline.py
    tests/unit/core/reconstruction/test_reconstruction_stage.py
  </files>
  <action>
  1. **Config additions** in `ReconstructionConfig`:
     - `min_cameras: int = 3` — minimum cameras to attempt triangulation per fish per frame. Default 3 per CONTEXT.md ("well-supported by rig geometry"). Can lower to 2 for exploratory runs.
     - `max_interp_gap: int = 5` — maximum consecutive frames to interpolate when fish drops below min_cameras. Default 5 (conservative; at 30fps this is ~167ms, well within a fish's expected trajectory smoothness).
     - `n_control_points: int = 7` — fixed B-spline control point count per fish per frame (matching existing `SPLINE_N_CTRL`).

  2. **Rewrite `ReconstructionStage.run()`**:

     The new algorithm (replaces the v2.1 transition stub):

     a. Read `tracklet_groups` from context. If empty, produce empty midlines (unchanged behavior).

     b. Read `annotated_detections` from context.

     c. Determine frame range: `frame_count = context.frame_count or len(annotated_detections)`.

     d. For each TrackletGroup (each fish):
        - Determine per-frame camera membership: for each frame in range, check which tracklets in this group have that frame AND have `frame_status == "detected"`.
        - Build per-frame MidlineSet entry: `{fish_id: {cam_id: Midline2D}}` using only the cameras from the group's tracklets.
        - The detection->Midline2D lookup: for each (cam_id, frame_idx) from the tracklet, find the corresponding AnnotatedDetection in `annotated_detections[frame_idx][cam_id]`. Match by centroid proximity to the tracklet's centroid at that frame (same pattern as 26-02). Extract its midline.

     e. For each frame, for each fish:
        - If n_cameras >= min_cameras: triangulate normally via `self._backend.reconstruct_frame()`.
        - If n_cameras < min_cameras: mark as `dropped` with reason `insufficient_views`. Store dropped frames in a dict `dropped_frames: dict[int, dict[int, str]]` mapping `{fish_id: {frame_idx: reason_string}}`. The reason string for this case is `"insufficient_views"`. This dict is attached to context (e.g., `context.dropped_frames`) or stored as an instance attribute for logging/testing.

     f. **Gap interpolation**: After processing all frames, scan each fish's results for gaps (consecutive dropped frames). If gap length <= max_interp_gap AND there are valid frames on both sides:
        - Linearly interpolate control points between the bounding valid frames.
        - Set interpolated frames' confidence to 0.0 (per CONTEXT.md: "confidence=0 for interpolated frames").
        - Valid (triangulated) frames get confidence from the TrackletGroup's per_frame_confidence (if available) or 1.0.

     g. Populate `context.midlines_3d` as `list[dict[int, Midline3D]]` — one dict per frame, mapping fish_id to Midline3D. Interpolated Midline3D objects have `is_low_confidence = True`.

  3. **Update `build_stages()` in `pipeline.py`**: Pass `min_cameras`, `max_interp_gap`, and `n_control_points` from config to ReconstructionStage constructor. Add these as constructor parameters to ReconstructionStage (with defaults matching the config defaults for backward compat).

  4. **Remove legacy compatibility code**: Delete the `AssociationBundle` class from `src/aquapose/core/association/types.py` and the `FishTrack`/`TrackState`/`TrackHealth` classes from `src/aquapose/core/tracking/types.py`. These were retained "until Phase 26 replaces them" — Phase 26 is now replacing them. Update `__all__` in both modules. If any imports break, fix them (check with grep first).

     CAUTION: Before deleting, grep for all imports of these types. If they are still imported by visualization or other modules, keep them but add a deprecation comment. Only delete if the only consumers are reconstruction/stage.py (which we are rewriting).

  5. **Tests**: Update `test_reconstruction_stage.py`:
     - Test with synthetic tracklet_groups: 2 fish, 4 cameras each, verify per-fish triangulation.
     - Test min_cameras enforcement: fish with 2 cameras (below threshold of 3) produces dropped frame with reason `"insufficient_views"` in the dropped_frames dict.
     - Test gap interpolation: 3-frame gap within max_interp_gap gets interpolated control points.
     - Test gap > max_interp_gap: NOT interpolated (stays dropped).
     - Test interpolated frames have confidence=0.
     - Test empty tracklet_groups still produces empty midlines (no crash).
  </action>
  <verify>
    <automated>hatch run test -- tests/unit/core/reconstruction/test_reconstruction_stage.py -x -v</automated>
  </verify>
  <done>
  - ReconstructionStage reads tracklet_groups for camera membership — no RANSAC matching
  - Frames below min_cameras are dropped
  - Short gaps are interpolated with confidence=0
  - Legacy AssociationBundle / FishTrack types removed (or deprecated) if safe
  - All reconstruction tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite HDF5 output to fish-first structure and verify end-to-end</name>
  <files>
    src/aquapose/engine/hdf5_observer.py
    tests/unit/engine/test_hdf5_observer.py
  </files>
  <action>
  1. **Rewrite `HDF5ExportObserver._write_hdf5()`** to produce fish-first layout:

     Per CONTEXT.md decisions:
     ```
     /fish_{fish_id}/
       spline_controls    [T, N, 3]   float32  — B-spline control points per frame
       confidence         [T]          float32  — per-frame quality score (0/NaN for interpolated)
     ```
     Root attributes:
     - `config_hash`: MD5 hash of serialized config (already computed)
     - `video_paths`: JSON string of video path list (from config)
     - `calibration_path`: calibration file path string
     - `run_timestamp`: ISO timestamp
     - `run_id`: run identifier

     Algorithm:
     a. Collect all unique fish_ids from `context.midlines_3d`.
     b. Determine total frame count T.
     c. For each fish_id, create a group `/fish_{fish_id}/`.
     d. Pre-allocate `spline_controls` array `[T, N_CTRL, 3]` filled with NaN.
     e. Pre-allocate `confidence` array `[T]` filled with NaN.
     f. Fill in frames where this fish has a Midline3D:
        - `spline_controls[frame_idx] = midline.control_points`
        - `confidence[frame_idx] = 1.0` for normal frames, `0.0` for `is_low_confidence=True` (interpolated).
     g. Use gzip compression (level 4) for datasets.
     h. Also read `tracklet_groups` from context to get the association confidence per frame if available. If `TrackletGroup.per_frame_confidence` is populated, use it for the confidence array (instead of simple 1.0/0.0).

  2. **Preserve backward compatibility**: Keep the old frame-major code path as a fallback when `tracklet_groups` is None/empty (legacy mode). Gate the new fish-first path on `tracklet_groups` being non-empty.

  3. **Add root attributes**: The `PipelineComplete` event already carries `context` and `run_id`. Access config from `PipelineStart` event (already captured). Add `video_paths`, `calibration_path`, `run_timestamp` from the stored config reference.

  4. **Tests in `test_hdf5_observer.py`**:
     - Test fish-first layout: mock context with 2 fish, 10 frames, verify HDF5 structure.
     - Test confidence array: verify interpolated frames (is_low_confidence=True) have confidence=0.
     - Test root attributes: config_hash, run_timestamp present.
     - Test empty midlines: produces valid but empty HDF5.
     - Test backward compat: when tracklet_groups is None, falls back to frame-major layout.
  </action>
  <verify>
    <automated>hatch run test -- tests/unit/engine/test_hdf5_observer.py -x -v</automated>
  </verify>
  <done>
  - HDF5 output uses fish-first structure with spline_controls[T, N, 3] and confidence[T]
  - Root attributes include config_hash, video_paths, calibration_path, run_timestamp
  - Interpolated frames correctly flagged with confidence=0
  - Backward-compatible frame-major layout preserved when tracklet_groups absent
  - All HDF5 observer tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Reconstruction tests
hatch run test -- tests/unit/core/reconstruction/ -x -v

# HDF5 observer tests
hatch run test -- tests/unit/engine/test_hdf5_observer.py -x -v

# Full test suite (regression check)
hatch run test -- -x -q

# Type checking
hatch run typecheck

# Lint
hatch run lint
```
</verification>

<success_criteria>
- Reconstruction uses known camera membership from tracklet_groups (no RANSAC matching)
- Fish below min_cameras are dropped; short gaps are interpolated
- HDF5 output has fish-first layout: /fish_{id}/spline_controls[T,N,3] and /fish_{id}/confidence[T]
- Full pipeline Detection -> Tracking -> Association -> Midline -> Reconstruction wires correctly
- All existing and new tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/26-association-refinement-and-pipeline-wiring/26-03-SUMMARY.md`
</output>
