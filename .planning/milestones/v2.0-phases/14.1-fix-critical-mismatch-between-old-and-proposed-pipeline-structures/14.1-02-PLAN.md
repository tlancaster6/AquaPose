# Plan 14.1-02: Update Engine Code and Golden Tests to 5-Stage Model

---
wave: 1
depends_on: []
files_modified:
  - src/aquapose/engine/stages.py
  - src/aquapose/engine/config.py
  - src/aquapose/engine/__init__.py
  - tests/unit/engine/test_stages.py
  - tests/unit/engine/test_config.py
  - tests/golden/test_stage_harness.py
  - tests/golden/conftest.py
requirements: []
autonomous: true
---

## Goal

Update engine code (PipelineContext fields, config dataclasses, stage examples) and golden test harness to match the guidebook's canonical 5-stage pipeline model. After this plan, the engine infrastructure accurately describes the stages that Phase 15 will implement.

## Context

The guidebook defines 5 stages with specific data flow:
1. **Detection** -> `detections_per_frame` (per-camera per-frame detections)
2. **Midline** -> `annotated_detections` (detections enriched with 15-point 2D midlines + half-widths)
3. **Association** -> `associated_bundles` (cross-camera matched detection groups per fish)
4. **Tracking** -> `tracks_per_frame` (bundles promoted to persistent fish IDs with lifecycle)
5. **Reconstruction** -> `midlines_3d` (per-frame dict[fish_id, Spline3D])

The current PipelineContext has fields from the old 7-stage model: `detections`, `masks` (separate segmentation), `tracks`, `midline_sets`, `midlines_3d`. The config has `SegmentationConfig` and `TriangulationConfig` as separate stage configs.

The golden test harness tests v1.0 pipeline outputs — these golden data FILES remain unchanged (they capture v1.0 behavior). But the test organization and docstrings must clarify the mapping between v1.0 output snapshots and the new 5-stage model.

**IMPORTANT**: The golden data .pt files on disk are NOT modified. Only test code and engine infrastructure code changes.

## Tasks

<task id="1">
<title>Update PipelineContext fields and config dataclasses to match 5-stage model</title>
<description>
**PipelineContext changes (stages.py):**

Replace the current fields with fields that match the guidebook's 5-stage data flow:

```python
@dataclass
class PipelineContext:
    # Metadata
    frame_count: int | None = None
    camera_ids: list[str] | None = None

    # Stage 1 — Detection
    detections: list[dict[str, list]] | None = None

    # Stage 2 — Midline
    annotated_detections: list[dict[str, list]] | None = None

    # Stage 3 — Association
    associated_bundles: list[list] | None = None

    # Stage 4 — Tracking
    tracks: list[list] | None = None

    # Stage 5 — Reconstruction
    midlines_3d: list[dict] | None = None

    # Engine metadata
    stage_timing: dict[str, float] = field(default_factory=dict)
```

Key changes:
- REMOVE `masks` field (segmentation is internal to midline stage)
- REMOVE `midline_sets` field (replaced by `annotated_detections`)
- ADD `annotated_detections` field (midline stage output — detections enriched with 2D midlines)
- ADD `associated_bundles` field (association stage output — cross-camera matched groups)
- Keep `detections`, `tracks`, `midlines_3d` (names match guidebook)
- Update all docstrings to reference the guidebook stage names and data descriptions

**Config changes (config.py):**

1. Rename `SegmentationConfig` to `MidlineConfig`:
   - Keep `confidence_threshold` and `weights_path` fields (these configure the segmentation backend within midline)
   - Add docstring explaining this configures the midline stage's segment-then-extract backend

2. Rename `TriangulationConfig` to `ReconstructionConfig`:
   - Add a `backend` field with default `"triangulation"` (future: `"curve_optimizer"`)
   - Update docstring to explain this configures the reconstruction stage

3. Add `AssociationConfig` dataclass:
   - Placeholder for now (empty frozen dataclass with docstring)

4. Update `PipelineConfig`:
   - Rename `segmentation` field to `midline` (type: `MidlineConfig`)
   - Rename `triangulation` field to `reconstruction` (type: `ReconstructionConfig`)
   - Add `association` field (type: `AssociationConfig`)

5. Update `load_config()`:
   - Replace `seg_kwargs` with `mid_kwargs` (midline)
   - Replace `tri_kwargs` with `rec_kwargs` (reconstruction)
   - Add `assoc_kwargs` for association
   - Update YAML key parsing: accept both old names (`segmentation`, `triangulation`) for backward compat AND new names (`midline`, `reconstruction`, `association`). New names take precedence.

6. Update `__init__.py` exports:
   - Remove `SegmentationConfig`, `TriangulationConfig`
   - Add `MidlineConfig`, `ReconstructionConfig`, `AssociationConfig`
   - Update `__all__`

**Test updates:**

- `test_stages.py`: Update `test_pipeline_context_defaults_none` to check new fields (`annotated_detections`, `associated_bundles`) and remove checks for `masks`, `midline_sets`
- `test_config.py`: Update all tests to use new config names (`midline`, `reconstruction`, `association`). Specifically:
  - `test_load_config_defaults`: Check `config.midline.confidence_threshold` instead of `config.segmentation.confidence_threshold`
  - YAML override tests: Use `midline` key instead of `segmentation`
  - Serialization roundtrip test: Assert `parsed["midline"]` instead of `parsed["segmentation"]`

Run `hatch run test tests/unit/engine/` to verify all unit tests pass after changes.
</description>
</task>

<task id="2">
<title>Update golden test harness to clarify 5-stage mapping</title>
<description>
The golden data files on disk capture v1.0 pipeline outputs and MUST NOT be modified. However, the golden test harness code needs updates to clarify the mapping between v1.0 outputs and the new 5-stage model.

**test_stage_harness.py changes:**

1. Update the module docstring to explain the relationship:
   - v1.0 golden data was captured at 5 stage boundaries (detection, segmentation/masks, tracking, midline extraction, triangulation)
   - In the new 5-stage model: detection maps to Stage 1, segmentation+midline map to Stage 2 (Midline), tracking maps to Stage 4, triangulation maps to Stage 5 (Reconstruction)
   - Association (Stage 3) has no separate golden data because it was internal to tracking in v1.0

2. Update `test_segmentation_structure` docstring to note: "In the new model, segmentation is internal to the Midline stage (Stage 2). This test validates the v1.0 golden mask data which will be used to verify the segment-then-extract backend."

3. Update `test_midline_extraction_structure` docstring to note: "In the new model, midline extraction is the output of the Midline stage (Stage 2). This test validates the v1.0 golden midline data."

4. Update `test_triangulation_structure` docstring to note: "In the new model, triangulation is the Reconstruction stage (Stage 5). This test validates the v1.0 golden triangulation data."

5. Update `test_tracking_structure` docstring to note: "In the new model, tracking is Stage 4. Note: in v1.0, association was internal to the tracker; the new model extracts it as a separate Stage 3."

**conftest.py changes:**

No structural changes needed — the fixtures load v1.0 data files which remain valid. Add a module-level comment explaining: "These fixtures load v1.0 pipeline outputs. The v1.0 pipeline had different stage boundaries than the new 5-stage model, but the data itself remains the golden reference for regression testing."

Run `hatch run test tests/unit/engine/` to verify unit tests pass (golden tests are @slow and won't run, but ensure no import errors).
</description>
</task>

## Verification

- [ ] `PipelineContext` has fields: `detections`, `annotated_detections`, `associated_bundles`, `tracks`, `midlines_3d` (no `masks`, no `midline_sets`)
- [ ] Config has `MidlineConfig`, `ReconstructionConfig`, `AssociationConfig` (no `SegmentationConfig`, no `TriangulationConfig`)
- [ ] `PipelineConfig` has fields: `detection`, `midline`, `association`, `tracking`, `reconstruction`
- [ ] `__init__.py` exports updated config names
- [ ] `hatch run test tests/unit/engine/` passes (all unit tests green)
- [ ] Golden test docstrings clarify v1.0-to-5-stage mapping
- [ ] No import errors when loading golden test module
- [ ] `hatch run lint` passes on all modified files
- [ ] `hatch run typecheck` passes on all modified files

## must_haves

Derived from phase goal (goal-backward):

1. **PipelineContext matches guidebook data flow** — fields named exactly as the guidebook defines stage outputs
2. **Config hierarchy matches guidebook stages** — one config per stage, named consistently
3. **Engine unit tests pass with new field/config names** — no broken tests
4. **Golden test harness clarifies the v1.0-to-5-stage mapping** — future readers understand which golden data maps to which new stage
5. **No references to old separate segmentation/triangulation stages in engine code** — `masks` field gone, `SegmentationConfig` gone, `TriangulationConfig` gone
